<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>KDJ指标择时交易策略分析 - R-Finance中国</title><script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:url" content="https://rfinance.org.cn/post/kdj/"><meta property="og:site_name" content="R-Finance中国"><meta property="og:title" content="KDJ指标择时交易策略分析"><meta property="og:description" content='引言 技术分析是金融市场中常用的分析方法，其中KDJ指标是一种重要的随机指标，能够反映价格波动的强弱、超买超卖现象以及市场趋势变化。本研究旨在通过R语言实现基于KDJ指标的股票择时交易策略，并通过历史数据回测寻找最佳参数组合。
研究方法 数据获取与处理 我们将使用quantmod包获取股票数据，并使用quantstrat包进行策略回测。首先加载所需的包：
# 加载必要的包 library(quantmod) library(quantstrat) library(eTTR) library(PerformanceAnalytics) library(ggplot2) library(dplyr) library(tibble) library(scales) library(gridExtra) # 加载环境重置函数 source("/Users/matrixspk/My-Sites/r-finance/assets/code/reset_strategy_env.R") # 加载计算胜率的函数 source("/Users/matrixspk/My-Sites/r-finance/assets/code/calculate_portfolio_win_rates.R") source("/Users/matrixspk/My-Sites/r-finance/assets/code/generateSimpleSignalChain.R") 接下来，我们获取苹果公司股票的历史数据作为研究对象：
# 设置获取数据的起始和结束日期 initDate <- as.Date("2017-12-31") startdate.st <- as.Date("2018-01-01") enddate.st <- as.Date("2023-06-01") # 获取苹果公司股票数据 getSymbols("AAPL", src = "yahoo", from = startdate.st, to = enddate.st) ## [1] "AAPL" colnames(AAPL) <- c("Open", "High", "Low", "Close", "Volume", "Adjusted") # 查看数据结构 head(AAPL) ## Open High Low Close Volume Adjusted ## 2018-01-02 42.5400 43.0750 42.3150 43.0650 102223600 40.42682 ## 2018-01-03 43.1325 43.6375 42.9900 43.0575 118071600 40.41978 ## 2018-01-04 43.1350 43.3675 43.0200 43.2575 89738400 40.60753 ## 2018-01-05 43.3600 43.8425 43.2625 43.7500 94640000 41.06987 ## 2018-01-08 43.5875 43.9025 43.4825 43.5875 82271200 40.91733 ## 2018-01-09 43.6375 43.7650 43.3525 43.5825 86336000 40.91262 summary(AAPL) ## Index Open High Low ## Min. :2018-01-02 Min. : 35.99 Min. : 36.43 Min. : 35.50 ## 1st Qu.:2019-05-10 1st Qu.: 51.97 1st Qu.: 52.32 1st Qu.: 51.67 ## Median :2020-09-15 Median :114.67 Median :116.07 Median :112.84 ## Mean :2020-09-14 Mean :102.38 Mean :103.62 Mean :101.24 ## 3rd Qu.:2022-01-20 3rd Qu.:146.36 3rd Qu.:148.00 3rd Qu.:145.15 ## Max. :2023-05-31 Max. :182.63 Max. :182.94 Max. :179.12 ## Close Volume Adjusted ## Min. : 35.55 Min. : 35195900 Min. : 33.87 ## 1st Qu.: 52.03 1st Qu.: 76144000 1st Qu.: 49.73 ## Median :114.97 Median : 98135650 Median :111.96 ## Mean :102.48 Mean :112825725 Mean :100.02 ## 3rd Qu.:146.61 3rd Qu.:133535000 3rd Qu.:143.97 ## Max. :182.01 Max. :426510000 Max. :178.65 KDJ指标计算原理 KDJ指标由三条曲线组成：K线、D线和J线。其计算基于以下步骤：'><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2025-06-10T15:36:25+00:00"><meta property="article:modified_time" content="2025-06-10T15:36:25+00:00"><meta property="article:tag" content="R"><meta property="article:tag" content="KDJ"><meta property="article:tag" content="择时"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title=R-Finance中国 rel=home><div class="logo__item logo__text"><div class=logo__title>R-Finance中国</div><div class=logo__tagline>R语言与金融深度融合的堡垒站点</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/conference/><span class=menu__text>会议</span></a></li><li class=menu__item><a class=menu__link href=/salon/><span class=menu__text>沙龙</span></a></li><li class=menu__item><a class=menu__link href=/bootcamp/><span class=menu__text>训练坊</span></a></li><li class=menu__item><a class=menu__link href=/media/><span class=menu__text>媒体矩阵</span></a></li><li class=menu__item><a class=menu__link href=/about/><span class=menu__text>关于本站</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>KDJ指标择时交易策略分析</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0a14 14 0 110 28 1 1 0 010-28m0 3a3 3 0 100 22 3 3 0 000-22m1 4h-2v8.4l6.8 4.4L22 18l-6-3.8z"/></svg><time class=meta__text datetime=2025-06-10T15:36:25Z>June 10, 2025</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class=meta__text><a class=meta__link href=/categories/%E9%87%8F%E5%8C%96%E6%8A%95%E8%B5%84/ rel=category>量化投资</a></span></div></div></header><div class="content post__content clearfix"><h1 id=引言>引言</h1><p>技术分析是金融市场中常用的分析方法，其中KDJ指标是一种重要的随机指标，能够反映价格波动的强弱、超买超卖现象以及市场趋势变化。本研究旨在通过R语言实现基于KDJ指标的股票择时交易策略，并通过历史数据回测寻找最佳参数组合。</p><h1 id=研究方法>研究方法</h1><h2 id=数据获取与处理>数据获取与处理</h2><p>我们将使用<code>quantmod</code>包获取股票数据，并使用<code>quantstrat</code>包进行策略回测。首先加载所需的包：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#75715e># 加载必要的包</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>library</span>(quantmod)
</span></span><span style=display:flex><span><span style=color:#a6e22e>library</span>(quantstrat)
</span></span><span style=display:flex><span><span style=color:#a6e22e>library</span>(eTTR)
</span></span><span style=display:flex><span><span style=color:#a6e22e>library</span>(PerformanceAnalytics)
</span></span><span style=display:flex><span><span style=color:#a6e22e>library</span>(ggplot2)
</span></span><span style=display:flex><span><span style=color:#a6e22e>library</span>(dplyr)
</span></span><span style=display:flex><span><span style=color:#a6e22e>library</span>(tibble)
</span></span><span style=display:flex><span><span style=color:#a6e22e>library</span>(scales)
</span></span><span style=display:flex><span><span style=color:#a6e22e>library</span>(gridExtra)
</span></span><span style=display:flex><span><span style=color:#75715e># 加载环境重置函数</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>source</span>(<span style=color:#e6db74>&#34;/Users/matrixspk/My-Sites/r-finance/assets/code/reset_strategy_env.R&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># 加载计算胜率的函数</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>source</span>(<span style=color:#e6db74>&#34;/Users/matrixspk/My-Sites/r-finance/assets/code/calculate_portfolio_win_rates.R&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>source</span>(<span style=color:#e6db74>&#34;/Users/matrixspk/My-Sites/r-finance/assets/code/generateSimpleSignalChain.R&#34;</span>)
</span></span></code></pre></div><p>接下来，我们获取苹果公司股票的历史数据作为研究对象：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#75715e># 设置获取数据的起始和结束日期</span>
</span></span><span style=display:flex><span>initDate <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>as.Date</span>(<span style=color:#e6db74>&#34;2017-12-31&#34;</span>)
</span></span><span style=display:flex><span>startdate.st <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>as.Date</span>(<span style=color:#e6db74>&#34;2018-01-01&#34;</span>)
</span></span><span style=display:flex><span>enddate.st <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>as.Date</span>(<span style=color:#e6db74>&#34;2023-06-01&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># 获取苹果公司股票数据</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>getSymbols</span>(<span style=color:#e6db74>&#34;AAPL&#34;</span>, src <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;yahoo&#34;</span>, from <span style=color:#f92672>=</span> startdate.st, to <span style=color:#f92672>=</span> enddate.st)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;AAPL&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#a6e22e>colnames</span>(AAPL) <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>c</span>(<span style=color:#e6db74>&#34;Open&#34;</span>, <span style=color:#e6db74>&#34;High&#34;</span>, <span style=color:#e6db74>&#34;Low&#34;</span>, <span style=color:#e6db74>&#34;Close&#34;</span>, <span style=color:#e6db74>&#34;Volume&#34;</span>, <span style=color:#e6db74>&#34;Adjusted&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># 查看数据结构</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>head</span>(AAPL)
</span></span></code></pre></div><pre tabindex=0><code>##               Open    High     Low   Close    Volume Adjusted
## 2018-01-02 42.5400 43.0750 42.3150 43.0650 102223600 40.42682
## 2018-01-03 43.1325 43.6375 42.9900 43.0575 118071600 40.41978
## 2018-01-04 43.1350 43.3675 43.0200 43.2575  89738400 40.60753
## 2018-01-05 43.3600 43.8425 43.2625 43.7500  94640000 41.06987
## 2018-01-08 43.5875 43.9025 43.4825 43.5875  82271200 40.91733
## 2018-01-09 43.6375 43.7650 43.3525 43.5825  86336000 40.91262
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#a6e22e>summary</span>(AAPL)
</span></span></code></pre></div><pre tabindex=0><code>##      Index                 Open             High             Low        
##  Min.   :2018-01-02   Min.   : 35.99   Min.   : 36.43   Min.   : 35.50  
##  1st Qu.:2019-05-10   1st Qu.: 51.97   1st Qu.: 52.32   1st Qu.: 51.67  
##  Median :2020-09-15   Median :114.67   Median :116.07   Median :112.84  
##  Mean   :2020-09-14   Mean   :102.38   Mean   :103.62   Mean   :101.24  
##  3rd Qu.:2022-01-20   3rd Qu.:146.36   3rd Qu.:148.00   3rd Qu.:145.15  
##  Max.   :2023-05-31   Max.   :182.63   Max.   :182.94   Max.   :179.12  
##      Close            Volume             Adjusted     
##  Min.   : 35.55   Min.   : 35195900   Min.   : 33.87  
##  1st Qu.: 52.03   1st Qu.: 76144000   1st Qu.: 49.73  
##  Median :114.97   Median : 98135650   Median :111.96  
##  Mean   :102.48   Mean   :112825725   Mean   :100.02  
##  3rd Qu.:146.61   3rd Qu.:133535000   3rd Qu.:143.97  
##  Max.   :182.01   Max.   :426510000   Max.   :178.65
</code></pre><h2 id=kdj指标计算原理>KDJ指标计算原理</h2><p>KDJ指标由三条曲线组成：K线、D线和J线。其计算基于以下步骤：</p><ol><li><p>计算未成熟随机值RSV：
$$
RSV = \frac{C_t - L_n}{H_n - L_n} \times 100%
$$</p><p>其中，$C_t$ 为当日收盘价，$L_n$ 为n日内最低价，$H_n$ 为n日内最高价。</p></li><li><p>计算K值、D值和J值：
$$
K_{t} = \alpha \times RSV_{t} + (1-\alpha) \times K_{t-1}
$$
$$
D_{t} = \beta \times K_t + (1-\beta) \times D_{t-1}
$$
$$
J_t = 3 \times K_t - 2 \times D_t
$$</p></li></ol><p>通常，$\alpha = 1/3$，$\beta = 1/3$，$n=9$。</p><h2 id=交易策略设计>交易策略设计</h2><p>我们将基于KDJ指标设计以下交易策略：</p><ul><li>买入信号：当K线从下方上穿D线，并且K值和D值均小于20</li><li>卖出信号：当K线从上方下穿D线，并且K值和D值均大于80</li></ul><p>下面我们使用<code>quantstrat</code>包实现这个策略：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#75715e># 清理历史环境对象</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>reset_strategy_env</span>()
</span></span></code></pre></div><pre tabindex=0><code>## 策略环境已重置
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#75715e># 初始化quantstrat</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>rm</span>(list <span style=color:#f92672>=</span> <span style=color:#a6e22e>ls</span>(.blotter))
</span></span><span style=display:flex><span><span style=color:#a6e22e>rm</span>(list <span style=color:#f92672>=</span> <span style=color:#a6e22e>ls</span>(.strategy))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 设置初始参数</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>currency</span>(<span style=color:#e6db74>&#34;USD&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;USD&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#a6e22e>stock</span>(<span style=color:#e6db74>&#34;AAPL&#34;</span>, currency <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;USD&#34;</span>, multiplier <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;AAPL&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span>initEq.st <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>1000000</span>  <span style=color:#75715e># 初始资金</span>
</span></span><span style=display:flex><span>portfolio.st <span style=color:#f92672>&lt;-</span> <span style=color:#e6db74>&#34;KDJ_Portfolio&#34;</span>
</span></span><span style=display:flex><span>strategy.st <span style=color:#f92672>&lt;-</span> <span style=color:#e6db74>&#34;KDJ_Strategy&#34;</span>
</span></span><span style=display:flex><span>account.st <span style=color:#f92672>&lt;-</span> <span style=color:#e6db74>&#34;KDJ_Account&#34;</span>
</span></span><span style=display:flex><span>symbols.st <span style=color:#f92672>&lt;-</span> <span style=color:#e6db74>&#34;AAPL&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 初始化投资组合、账户和订单</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>initPortf</span>(name<span style=color:#f92672>=</span>portfolio.st, 
</span></span><span style=display:flex><span>          symbols <span style=color:#f92672>=</span> symbols.st,
</span></span><span style=display:flex><span>          initPosQty <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;KDJ_Portfolio&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#a6e22e>initAcct</span>(name <span style=color:#f92672>=</span> account.st, 
</span></span><span style=display:flex><span>         portfolios <span style=color:#f92672>=</span> portfolio.st, 
</span></span><span style=display:flex><span>         initEq <span style=color:#f92672>=</span> initEq.st)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;KDJ_Account&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#a6e22e>initOrders</span>(portfolio <span style=color:#f92672>=</span> portfolio.st)
</span></span><span style=display:flex><span><span style=color:#a6e22e>strategy</span>(strategy.st, store <span style=color:#f92672>=</span> <span style=color:#66d9ef>TRUE</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 添加KDJ指标（修正参数）</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>add.indicator</span>(strategy.st, 
</span></span><span style=display:flex><span>              name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;KDJ&#34;</span>, 
</span></span><span style=display:flex><span>              arguments <span style=color:#f92672>=</span> <span style=color:#a6e22e>list</span>(ohlc <span style=color:#f92672>=</span> <span style=color:#a6e22e>quote</span>(<span style=color:#a6e22e>HLC</span>(AAPL)), 
</span></span><span style=display:flex><span>                               n <span style=color:#f92672>=</span> <span style=color:#ae81ff>9</span>, 
</span></span><span style=display:flex><span>                               m1 <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>,  <span style=color:#75715e># eTTR::KDJ的m1参数</span>
</span></span><span style=display:flex><span>                               m2 <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>), <span style=color:#75715e># eTTR::KDJ的m2参数</span>
</span></span><span style=display:flex><span>              label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;KDJ_9_3_3&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;KDJ_Strategy&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#75715e># 添加交易信号</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 买入信号</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>add.signal</span>(strategy.st, 
</span></span><span style=display:flex><span>           name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;sigCrossover&#34;</span>, 
</span></span><span style=display:flex><span>           arguments <span style=color:#f92672>=</span> <span style=color:#a6e22e>list</span>(columns <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>(<span style=color:#e6db74>&#34;K.KDJ_9_3_3&#34;</span>, <span style=color:#e6db74>&#34;D.KDJ_9_3_3&#34;</span>), 
</span></span><span style=display:flex><span>                            relationship <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;gte&#34;</span>),
</span></span><span style=display:flex><span>           label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;K_gte_D&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;KDJ_Strategy&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#a6e22e>add.signal</span>(strategy.st, 
</span></span><span style=display:flex><span>           name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;sigThreshold&#34;</span>, 
</span></span><span style=display:flex><span>           arguments <span style=color:#f92672>=</span> <span style=color:#a6e22e>list</span>(column <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;K.KDJ_9_3_3&#34;</span>, 
</span></span><span style=display:flex><span>                            threshold <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span>, 
</span></span><span style=display:flex><span>                            relationship <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lt&#34;</span>, 
</span></span><span style=display:flex><span>                            cross <span style=color:#f92672>=</span> <span style=color:#66d9ef>FALSE</span>),
</span></span><span style=display:flex><span>           label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;K_lt_20&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;KDJ_Strategy&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#a6e22e>add.signal</span>(strategy.st, 
</span></span><span style=display:flex><span>           name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;sigThreshold&#34;</span>, 
</span></span><span style=display:flex><span>           arguments <span style=color:#f92672>=</span> <span style=color:#a6e22e>list</span>(column <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;D.KDJ_9_3_3&#34;</span>, 
</span></span><span style=display:flex><span>                            threshold <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span>, 
</span></span><span style=display:flex><span>                            relationship <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lt&#34;</span>, 
</span></span><span style=display:flex><span>                            cross <span style=color:#f92672>=</span> <span style=color:#66d9ef>FALSE</span>),
</span></span><span style=display:flex><span>           label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;D_lt_20&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;KDJ_Strategy&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#a6e22e>add.signal</span>(<span style=color:#e6db74>&#34;KDJ_Strategy&#34;</span>, 
</span></span><span style=display:flex><span>           name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;sigFormula&#34;</span>, 
</span></span><span style=display:flex><span>           arguments <span style=color:#f92672>=</span> <span style=color:#a6e22e>list</span>(formula <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;K_gte_D &amp; K_lt_20 &amp; D_lt_20&#34;</span>,
</span></span><span style=display:flex><span>                            columns <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>(<span style=color:#e6db74>&#34;K_gte_D&#34;</span>, <span style=color:#e6db74>&#34;K_lt_20&#34;</span>, <span style=color:#e6db74>&#34;D_lt_20&#34;</span>),
</span></span><span style=display:flex><span>                            cross <span style=color:#f92672>=</span> <span style=color:#66d9ef>FALSE</span>),
</span></span><span style=display:flex><span>           label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Buy_Signal&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;KDJ_Strategy&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#75715e># 卖出信号</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>add.signal</span>(strategy.st, 
</span></span><span style=display:flex><span>           name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;sigCrossover&#34;</span>, 
</span></span><span style=display:flex><span>           arguments <span style=color:#f92672>=</span> <span style=color:#a6e22e>list</span>(columns <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>(<span style=color:#e6db74>&#34;K.KDJ_9_3_3&#34;</span>, <span style=color:#e6db74>&#34;D.KDJ_9_3_3&#34;</span>), 
</span></span><span style=display:flex><span>                            relationship <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lte&#34;</span>),
</span></span><span style=display:flex><span>           label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;K_lte_D&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;KDJ_Strategy&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#a6e22e>add.signal</span>(strategy.st, 
</span></span><span style=display:flex><span>           name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;sigThreshold&#34;</span>, 
</span></span><span style=display:flex><span>           arguments <span style=color:#f92672>=</span> <span style=color:#a6e22e>list</span>(column <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;K.KDJ_9_3_3&#34;</span>, 
</span></span><span style=display:flex><span>                            threshold <span style=color:#f92672>=</span> <span style=color:#ae81ff>70</span>, 
</span></span><span style=display:flex><span>                            relationship <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;gt&#34;</span>, 
</span></span><span style=display:flex><span>                            cross <span style=color:#f92672>=</span> <span style=color:#66d9ef>FALSE</span>),
</span></span><span style=display:flex><span>           label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;K_gt_70&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;KDJ_Strategy&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#a6e22e>add.signal</span>(strategy.st, 
</span></span><span style=display:flex><span>           name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;sigThreshold&#34;</span>, 
</span></span><span style=display:flex><span>           arguments <span style=color:#f92672>=</span> <span style=color:#a6e22e>list</span>(column <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;D.KDJ_9_3_3&#34;</span>, 
</span></span><span style=display:flex><span>                            threshold <span style=color:#f92672>=</span> <span style=color:#ae81ff>70</span>, 
</span></span><span style=display:flex><span>                            relationship <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;gt&#34;</span>, 
</span></span><span style=display:flex><span>                            cross <span style=color:#f92672>=</span> <span style=color:#66d9ef>FALSE</span>),
</span></span><span style=display:flex><span>           label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;D_gt_70&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;KDJ_Strategy&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#a6e22e>add.signal</span>(<span style=color:#e6db74>&#34;KDJ_Strategy&#34;</span>, 
</span></span><span style=display:flex><span>           name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;sigFormula&#34;</span>, 
</span></span><span style=display:flex><span>           arguments <span style=color:#f92672>=</span> <span style=color:#a6e22e>list</span>(formula <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;K_lte_D &amp; K_gt_70 &amp; D_gt_70&#34;</span>,
</span></span><span style=display:flex><span>                            columns <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>(<span style=color:#e6db74>&#34;K_lte_D&#34;</span>, <span style=color:#e6db74>&#34;K_gt_70&#34;</span>, <span style=color:#e6db74>&#34;D_gt_70&#34;</span>),
</span></span><span style=display:flex><span>                            cross <span style=color:#f92672>=</span> <span style=color:#66d9ef>FALSE</span>),
</span></span><span style=display:flex><span>           label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Sell_Signal&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;KDJ_Strategy&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#75715e># 添加交易规则</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>add.rule</span>(strategy.st, 
</span></span><span style=display:flex><span>         name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ruleSignal&#34;</span>, 
</span></span><span style=display:flex><span>         arguments <span style=color:#f92672>=</span> <span style=color:#a6e22e>list</span>(sigcol <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Buy_Signal&#34;</span>, 
</span></span><span style=display:flex><span>                          sigval <span style=color:#f92672>=</span> <span style=color:#66d9ef>TRUE</span>, 
</span></span><span style=display:flex><span>                          orderqty <span style=color:#f92672>=</span> <span style=color:#ae81ff>10000</span>, 
</span></span><span style=display:flex><span>                          ordertype <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;market&#34;</span>, 
</span></span><span style=display:flex><span>                          orderside <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;long&#34;</span>, 
</span></span><span style=display:flex><span>                          replace <span style=color:#f92672>=</span> <span style=color:#66d9ef>FALSE</span>, 
</span></span><span style=display:flex><span>                          prefer <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Close&#34;</span>),
</span></span><span style=display:flex><span>         type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;enter&#34;</span>, 
</span></span><span style=display:flex><span>         label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Enter_Long&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;KDJ_Strategy&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#a6e22e>add.rule</span>(strategy.st, 
</span></span><span style=display:flex><span>         name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ruleSignal&#34;</span>, 
</span></span><span style=display:flex><span>         arguments <span style=color:#f92672>=</span> <span style=color:#a6e22e>list</span>(sigcol <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Sell_Signal&#34;</span>, 
</span></span><span style=display:flex><span>                          sigval <span style=color:#f92672>=</span> <span style=color:#66d9ef>TRUE</span>, 
</span></span><span style=display:flex><span>                          orderqty <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;all&#34;</span>, 
</span></span><span style=display:flex><span>                          ordertype <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;market&#34;</span>, 
</span></span><span style=display:flex><span>                          orderside <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;long&#34;</span>, 
</span></span><span style=display:flex><span>                          replace <span style=color:#f92672>=</span> <span style=color:#66d9ef>FALSE</span>, 
</span></span><span style=display:flex><span>                          prefer <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Close&#34;</span>),
</span></span><span style=display:flex><span>         type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;exit&#34;</span>, 
</span></span><span style=display:flex><span>         label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Exit_Long&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;KDJ_Strategy&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#75715e># 添加止损规则</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>add.rule</span>(strategy.st, 
</span></span><span style=display:flex><span>         name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ruleSignal&#34;</span>,  
</span></span><span style=display:flex><span>         arguments <span style=color:#f92672>=</span> <span style=color:#a6e22e>list</span>(threshold <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.05</span>, 
</span></span><span style=display:flex><span>                          sigcol <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Buy_Signal&#34;</span>, 
</span></span><span style=display:flex><span>                          sigval <span style=color:#f92672>=</span> <span style=color:#66d9ef>TRUE</span>, 
</span></span><span style=display:flex><span>                          orderqty <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;all&#34;</span>, 
</span></span><span style=display:flex><span>                          ordertype <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;stoplimit&#34;</span>, 
</span></span><span style=display:flex><span>                          orderside <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;long&#34;</span>, 
</span></span><span style=display:flex><span>                          replace <span style=color:#f92672>=</span> <span style=color:#66d9ef>FALSE</span>, 
</span></span><span style=display:flex><span>                          prefer <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Close&#34;</span>),
</span></span><span style=display:flex><span>         type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;chain&#34;</span>, 
</span></span><span style=display:flex><span>         parent <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Enter_Long&#34;</span>, 
</span></span><span style=display:flex><span>         label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Stop_Loss&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;KDJ_Strategy&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#75715e># 策略回测</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>tryCatch</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>applyStrategy</span>(strategy <span style=color:#f92672>=</span> strategy.st, portfolios <span style=color:#f92672>=</span> portfolio.st, mktdata <span style=color:#f92672>=</span> AAPL)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e># 更新结果</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>updatePortf</span>(portfolio.st)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>updateAcct</span>(account.st)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>updateEndEq</span>(account.st)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e># 分析回测结果</span>
</span></span><span style=display:flex><span>  port_ret <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>PortfReturns</span>(Account <span style=color:#f92672>=</span> account.st)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>nrow</span>(port_ret) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e># 计算绩效指标</span>
</span></span><span style=display:flex><span>    sharpe_ratio <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>SharpeRatio.annualized</span>(port_ret, Rf <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.02</span>)
</span></span><span style=display:flex><span>    total_return <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>Return.cumulative</span>(port_ret)
</span></span><span style=display:flex><span>    max_drawdown <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>maxDrawdown</span>(port_ret)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cat</span>(<span style=color:#e6db74>&#34;策略绩效指标:\n&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cat</span>(<span style=color:#e6db74>&#34;夏普比率:&#34;</span>, <span style=color:#a6e22e>round</span>(sharpe_ratio, <span style=color:#ae81ff>4</span>), <span style=color:#e6db74>&#34;\n&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cat</span>(<span style=color:#e6db74>&#34;总回报率:&#34;</span>, <span style=color:#a6e22e>round</span>(total_return, <span style=color:#ae81ff>4</span>), <span style=color:#e6db74>&#34;\n&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cat</span>(<span style=color:#e6db74>&#34;最大回撤:&#34;</span>, <span style=color:#a6e22e>round</span>(max_drawdown, <span style=color:#ae81ff>4</span>), <span style=color:#e6db74>&#34;\n&#34;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 绘制绩效图表</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>charts.PerformanceSummary</span>(port_ret)
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cat</span>(<span style=color:#e6db74>&#34;警告: 策略未产生任何交易\n&#34;</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}, error <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(e) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>cat</span>(<span style=color:#e6db74>&#34;回测失败:&#34;</span>, e<span style=color:#f92672>$</span>message, <span style=color:#e6db74>&#34;\n&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>cat</span>(<span style=color:#e6db74>&#34;请检查KDJ指标参数和数据格式\n&#34;</span>)
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;2018-11-28 00:00:00 AAPL 10000 @ 45.2350006103516&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 10000 @ 39.0374984741211&#34;
## [1] &#34;2019-02-11 00:00:00 AAPL -20000 @ 42.3574981689453&#34;
## [1] &#34;2022-01-26 00:00:00 AAPL 10000 @ 159.690002441406&#34;
## [1] &#34;2022-02-11 00:00:00 AAPL -10000 @ 168.639999389648&#34;
## [1] &#34;2022-12-30 00:00:00 AAPL 10000 @ 129.929992675781&#34;
## [1] &#34;2023-01-31 00:00:00 AAPL -10000 @ 144.289993286133&#34;
## 策略绩效指标:
## 夏普比率: -10.8848 
## 总回报率: 0.2403 
## 最大回撤: 0.1357
</code></pre><img src=/post/kdj_files/figure-html/strategy-1.png width=90% style=display:block;margin:auto><h1 id=参数优化>参数优化</h1><p>KDJ指标的主要参数包括RSV周期(n)、K值平滑因子(k)和D值平滑因子(d)。为了找到最佳参数组合，我们将进行参数网格搜索：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#75715e># 设置参数网格</span>
</span></span><span style=display:flex><span>n_values <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>c</span>(<span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>18</span>, <span style=color:#ae81ff>36</span>, <span style=color:#ae81ff>55</span>)<span style=color:#75715e># RSV周期（对应eTTR::KDJ的n参数）</span>
</span></span><span style=display:flex><span>m1_values <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>c</span>(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>5</span>)  <span style=color:#75715e># K值平滑因子（对应eTTR::KDJ的m1参数）</span>
</span></span><span style=display:flex><span>m2_values <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>c</span>(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>5</span>)  <span style=color:#75715e># D值平滑因子（对应eTTR::KDJ的m2参数）</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建参数组合</span>
</span></span><span style=display:flex><span>param_grid <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>expand.grid</span>(n <span style=color:#f92672>=</span> n_values, m1 <span style=color:#f92672>=</span> m1_values, m2 <span style=color:#f92672>=</span> m2_values)
</span></span><span style=display:flex><span>n_combinations <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>nrow</span>(param_grid)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 初始化结果存储</span>
</span></span><span style=display:flex><span>results <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>data.frame</span>(
</span></span><span style=display:flex><span>  n <span style=color:#f92672>=</span> <span style=color:#a6e22e>numeric</span>(n_combinations),
</span></span><span style=display:flex><span>  m1 <span style=color:#f92672>=</span> <span style=color:#a6e22e>numeric</span>(n_combinations),
</span></span><span style=display:flex><span>  m2 <span style=color:#f92672>=</span> <span style=color:#a6e22e>numeric</span>(n_combinations),
</span></span><span style=display:flex><span>  SharpeRatio <span style=color:#f92672>=</span> <span style=color:#a6e22e>numeric</span>(n_combinations),
</span></span><span style=display:flex><span>  Return <span style=color:#f92672>=</span> <span style=color:#a6e22e>numeric</span>(n_combinations),
</span></span><span style=display:flex><span>  MaxDrawdown <span style=color:#f92672>=</span> <span style=color:#a6e22e>numeric</span>(n_combinations),
</span></span><span style=display:flex><span>  TradeCount <span style=color:#f92672>=</span> <span style=color:#a6e22e>numeric</span>(n_combinations),
</span></span><span style=display:flex><span>  WinRate <span style=color:#f92672>=</span> <span style=color:#a6e22e>numeric</span>(n_combinations)
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 循环测试不同参数组合</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (i <span style=color:#66d9ef>in</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>n_combinations) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>cat</span>(<span style=color:#a6e22e>paste0</span>(<span style=color:#e6db74>&#34;测试参数组合 &#34;</span>, i, <span style=color:#e6db74>&#34;/&#34;</span>, n_combinations, <span style=color:#e6db74>&#34;: n=&#34;</span>, 
</span></span><span style=display:flex><span>             param_grid<span style=color:#f92672>$</span>n[i], <span style=color:#e6db74>&#34;, m1=&#34;</span>, param_grid<span style=color:#f92672>$</span>m1[i], <span style=color:#e6db74>&#34;, m2=&#34;</span>, param_grid<span style=color:#f92672>$</span>m2[i], <span style=color:#e6db74>&#34;\n&#34;</span>))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e># 重置环境</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>reset_strategy_env</span>()
</span></span><span style=display:flex><span>  <span style=color:#75715e># 设置初始参数</span>
</span></span><span style=display:flex><span>  initEq.st <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>1000000</span>  <span style=color:#75715e># 初始资金</span>
</span></span><span style=display:flex><span>  portfolio.st <span style=color:#f92672>&lt;-</span> <span style=color:#e6db74>&#34;KDJ_Portfolio&#34;</span>
</span></span><span style=display:flex><span>  strategy.st <span style=color:#f92672>&lt;-</span> <span style=color:#e6db74>&#34;KDJ_Strategy&#34;</span>
</span></span><span style=display:flex><span>  account.st <span style=color:#f92672>&lt;-</span> <span style=color:#e6db74>&#34;KDJ_Account&#34;</span>
</span></span><span style=display:flex><span>  symbols.st <span style=color:#f92672>&lt;-</span> <span style=color:#e6db74>&#34;AAPL&#34;</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>currency</span>(<span style=color:#e6db74>&#34;USD&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>stock</span>(symbols.st, currency <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;USD&#34;</span>, multiplier <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>tryCatch</span>({
</span></span><span style=display:flex><span>    <span style=color:#75715e># 初始化投资组合、账户和订单</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>initPortf</span>(portfolio.st, symbols <span style=color:#f92672>=</span> symbols.st)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>initAcct</span>(account.st, portfolios <span style=color:#f92672>=</span> portfolio.st, initEq <span style=color:#f92672>=</span> initEq.st)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>initOrders</span>(portfolio <span style=color:#f92672>=</span> portfolio.st)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>strategy</span>(strategy.st, store <span style=color:#f92672>=</span> <span style=color:#66d9ef>TRUE</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 添加KDJ指标</span>
</span></span><span style=display:flex><span>    indicator_label <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>paste0</span>(<span style=color:#e6db74>&#34;KDJ_&#34;</span>, param_grid<span style=color:#f92672>$</span>n[i], <span style=color:#e6db74>&#34;_&#34;</span>, param_grid<span style=color:#f92672>$</span>m1[i], <span style=color:#e6db74>&#34;_&#34;</span>, param_grid<span style=color:#f92672>$</span>m2[i])
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>add.indicator</span>(strategy.st, 
</span></span><span style=display:flex><span>                  name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;KDJ&#34;</span>, 
</span></span><span style=display:flex><span>                  arguments <span style=color:#f92672>=</span> <span style=color:#a6e22e>list</span>(ohlc <span style=color:#f92672>=</span> <span style=color:#a6e22e>quote</span>(<span style=color:#a6e22e>HLC</span>(AAPL)), 
</span></span><span style=display:flex><span>                                   n <span style=color:#f92672>=</span> param_grid<span style=color:#f92672>$</span>n[i], 
</span></span><span style=display:flex><span>                                   m1 <span style=color:#f92672>=</span> param_grid<span style=color:#f92672>$</span>m1[i],  <span style=color:#75715e># eTTR::KDJ的m1参数（K值平滑因子）</span>
</span></span><span style=display:flex><span>                                   m2 <span style=color:#f92672>=</span> param_grid<span style=color:#f92672>$</span>m2[i]), <span style=color:#75715e># eTTR::KDJ的m2参数（D值平滑因子）</span>
</span></span><span style=display:flex><span>                  label <span style=color:#f92672>=</span> indicator_label)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 生成指标列名</span>
</span></span><span style=display:flex><span>    k_col <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>paste0</span>(<span style=color:#e6db74>&#34;K.&#34;</span>, indicator_label)
</span></span><span style=display:flex><span>    d_col <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>paste0</span>(<span style=color:#e6db74>&#34;D.&#34;</span>, indicator_label)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 买入信号</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>add.signal</span>(strategy.st, <span style=color:#e6db74>&#34;sigCrossover&#34;</span>, 
</span></span><span style=display:flex><span>               <span style=color:#a6e22e>list</span>(columns <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>(k_col, d_col), relationship <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;gte&#34;</span>),
</span></span><span style=display:flex><span>               label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;K_gte_D&#34;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>add.signal</span>(strategy.st, <span style=color:#e6db74>&#34;sigThreshold&#34;</span>, 
</span></span><span style=display:flex><span>               <span style=color:#a6e22e>list</span>(column <span style=color:#f92672>=</span> k_col, threshold <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span>, relationship <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lt&#34;</span>),
</span></span><span style=display:flex><span>               label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;K_lt_20&#34;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>add.signal</span>(strategy.st, <span style=color:#e6db74>&#34;sigThreshold&#34;</span>, 
</span></span><span style=display:flex><span>               <span style=color:#a6e22e>list</span>(column <span style=color:#f92672>=</span> d_col, threshold <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span>, relationship <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lt&#34;</span>),
</span></span><span style=display:flex><span>               label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;D_lt_20&#34;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>add.signal</span>(strategy.st, <span style=color:#e6db74>&#34;sigFormula&#34;</span>, 
</span></span><span style=display:flex><span>               <span style=color:#a6e22e>list</span>(signals <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>(<span style=color:#e6db74>&#34;K_gte_D&#34;</span>, <span style=color:#e6db74>&#34;K_lt_20&#34;</span>, <span style=color:#e6db74>&#34;D_lt_20&#34;</span>), 
</span></span><span style=display:flex><span>                    formula <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;K_gte_D &amp; K_lt_20 &amp; D_lt_20&#34;</span>),
</span></span><span style=display:flex><span>               label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Buy_Signal&#34;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 卖出信号</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>add.signal</span>(strategy.st, <span style=color:#e6db74>&#34;sigCrossover&#34;</span>, 
</span></span><span style=display:flex><span>               <span style=color:#a6e22e>list</span>(columns <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>(k_col, d_col), relationship <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lte&#34;</span>),
</span></span><span style=display:flex><span>               label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;K_lte_D&#34;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>add.signal</span>(strategy.st, <span style=color:#e6db74>&#34;sigThreshold&#34;</span>, 
</span></span><span style=display:flex><span>               <span style=color:#a6e22e>list</span>(column <span style=color:#f92672>=</span> k_col, threshold <span style=color:#f92672>=</span> <span style=color:#ae81ff>70</span>, relationship <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;gt&#34;</span>),
</span></span><span style=display:flex><span>               label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;K_gt_70&#34;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>add.signal</span>(strategy.st, <span style=color:#e6db74>&#34;sigThreshold&#34;</span>, 
</span></span><span style=display:flex><span>               <span style=color:#a6e22e>list</span>(column <span style=color:#f92672>=</span> d_col, threshold <span style=color:#f92672>=</span> <span style=color:#ae81ff>70</span>, relationship <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;gt&#34;</span>),
</span></span><span style=display:flex><span>               label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;D_gt_70&#34;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>add.signal</span>(strategy.st, <span style=color:#e6db74>&#34;sigFormula&#34;</span>, 
</span></span><span style=display:flex><span>               <span style=color:#a6e22e>list</span>(signals <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>(<span style=color:#e6db74>&#34;K_lte_D&#34;</span>, <span style=color:#e6db74>&#34;K_gt_70&#34;</span>, <span style=color:#e6db74>&#34;D_gt_70&#34;</span>),
</span></span><span style=display:flex><span>                    formula <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;K_lte_D &amp; K_gt_70 &amp; D_gt_70&#34;</span>),
</span></span><span style=display:flex><span>               label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Sell_Signal&#34;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 添加交易规则</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>add.rule</span>(strategy.st, <span style=color:#e6db74>&#34;ruleSignal&#34;</span>, 
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>list</span>(sigcol <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Buy_Signal&#34;</span>, sigval <span style=color:#f92672>=</span> <span style=color:#66d9ef>TRUE</span>, 
</span></span><span style=display:flex><span>                  orderqty <span style=color:#f92672>=</span> <span style=color:#ae81ff>250000</span>, ordertype <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;market&#34;</span>, 
</span></span><span style=display:flex><span>                  orderside <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;long&#34;</span>, replace <span style=color:#f92672>=</span> <span style=color:#66d9ef>FALSE</span>),
</span></span><span style=display:flex><span>             type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;enter&#34;</span>, label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Enter_Long&#34;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>add.rule</span>(strategy.st, <span style=color:#e6db74>&#34;ruleSignal&#34;</span>, 
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>list</span>(sigcol <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Sell_Signal&#34;</span>, sigval <span style=color:#f92672>=</span> <span style=color:#66d9ef>TRUE</span>, 
</span></span><span style=display:flex><span>                  orderqty <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;all&#34;</span>, ordertype <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;market&#34;</span>, 
</span></span><span style=display:flex><span>                  orderside <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;long&#34;</span>, replace <span style=color:#f92672>=</span> <span style=color:#66d9ef>FALSE</span>),
</span></span><span style=display:flex><span>             type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;exit&#34;</span>, label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Exit_Long&#34;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 添加止损规则</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>add.rule</span>(strategy.st, <span style=color:#e6db74>&#34;ruleSignal&#34;</span>, 
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>list</span>(threshold <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.10</span>, 
</span></span><span style=display:flex><span>                  sigcol <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Buy_Signal&#34;</span>, 
</span></span><span style=display:flex><span>                  sigval <span style=color:#f92672>=</span> <span style=color:#66d9ef>TRUE</span>,
</span></span><span style=display:flex><span>                  orderqty <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;all&#34;</span>, 
</span></span><span style=display:flex><span>                  ordertype <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;stoplimit&#34;</span>, 
</span></span><span style=display:flex><span>                  orderside <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;long&#34;</span>, 
</span></span><span style=display:flex><span>                  replace <span style=color:#f92672>=</span> <span style=color:#66d9ef>FALSE</span>),
</span></span><span style=display:flex><span>             type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;chain&#34;</span>, 
</span></span><span style=display:flex><span>             parent <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Enter_Long&#34;</span>, 
</span></span><span style=display:flex><span>             label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Stop_Loss_10%&#34;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 运行回测</span>
</span></span><span style=display:flex><span>    out <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>applyStrategy</span>(strategy <span style=color:#f92672>=</span> strategy.st, 
</span></span><span style=display:flex><span>                         portfolios <span style=color:#f92672>=</span> portfolio.st, 
</span></span><span style=display:flex><span>                         mktdata <span style=color:#f92672>=</span> AAPL)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 更新回测结果</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>updatePortf</span>(portfolio.st)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>updateAcct</span>(account.st)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>updateEndEq</span>(account.st)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 获取策略收益</span>
</span></span><span style=display:flex><span>    port_ret <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>PortfReturns</span>(Account <span style=color:#f92672>=</span> account.st)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 计算评估指标</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>nrow</span>(port_ret) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      sharpe_ratio <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>SharpeRatio.annualized</span>(port_ret, Rf <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.02</span>,scale <span style=color:#f92672>=</span> <span style=color:#ae81ff>252</span>)
</span></span><span style=display:flex><span>      total_return <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>Return.cumulative</span>(port_ret)
</span></span><span style=display:flex><span>      max_drawdown <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>maxDrawdown</span>(port_ret)
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e># 交易分析</span>
</span></span><span style=display:flex><span>      trades <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>getTxns</span>(Portfolio <span style=color:#f92672>=</span> portfolio.st, Symbol <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;AAPL&#34;</span>)
</span></span><span style=display:flex><span>      trade_count <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>nrow</span>(trades)
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      win_rate_result <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>calculate_portfolio_win_rates</span>(<span style=color:#a6e22e>tradeStats</span>(portfolio.st))
</span></span><span style=display:flex><span>      win_rate <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>as.numeric</span>(win_rate_result[,<span style=color:#e6db74>&#34;Win_Rate&#34;</span>])
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e># 存储结果</span>
</span></span><span style=display:flex><span>      results[i, ] <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>c</span>(param_grid<span style=color:#f92672>$</span>n[i], param_grid<span style=color:#f92672>$</span>m1[i], param_grid<span style=color:#f92672>$</span>m2[i], 
</span></span><span style=display:flex><span>                        sharpe_ratio, total_return, max_drawdown, trade_count, win_rate)
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>cat</span>(<span style=color:#a6e22e>paste0</span>(<span style=color:#e6db74>&#34;✅ 测试完成 | Sharpe: &#34;</span>, <span style=color:#a6e22e>round</span>(sharpe_ratio, <span style=color:#ae81ff>4</span>), 
</span></span><span style=display:flex><span>                 <span style=color:#e6db74>&#34; | 总收益: &#34;</span>, <span style=color:#a6e22e>round</span>(total_return, <span style=color:#ae81ff>4</span>), 
</span></span><span style=display:flex><span>                 <span style=color:#e6db74>&#34; | 最大回撤: &#34;</span>, <span style=color:#a6e22e>round</span>(max_drawdown, <span style=color:#ae81ff>4</span>), 
</span></span><span style=display:flex><span>                 <span style=color:#e6db74>&#34; | 交易次数: &#34;</span>, trade_count, 
</span></span><span style=display:flex><span>                 <span style=color:#e6db74>&#34; | 胜率: &#34;</span>, <span style=color:#a6e22e>round</span>(win_rate, <span style=color:#ae81ff>2</span>), <span style=color:#e6db74>&#34;\n&#34;</span>))
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>cat</span>(<span style=color:#e6db74>&#34;⚠️ 警告: 无交易记录，可能参数设置过严\n&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }, error <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(e) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cat</span>(<span style=color:#a6e22e>paste0</span>(<span style=color:#e6db74>&#34;❌ 策略执行失败 | 参数组合 &#34;</span>, i, <span style=color:#e6db74>&#34; | 错误: &#34;</span>, e<span style=color:#f92672>$</span>message, <span style=color:#e6db74>&#34;\n&#34;</span>))
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><pre tabindex=0><code>## 测试参数组合 1/64: n=6, m1=2, m2=2
## 策略环境已重置
## [1] &#34;2018-02-01 00:00:00 AAPL 250000 @ 41.9449996948242&#34;
## [1] &#34;2018-02-21 00:00:00 AAPL -250000 @ 42.7675018310547&#34;
## [1] &#34;2018-11-16 00:00:00 AAPL 250000 @ 48.3824996948242&#34;
## [1] &#34;2018-11-27 00:00:00 AAPL 250000 @ 43.560001373291&#34;
## [1] &#34;2019-02-08 00:00:00 AAPL -5e+05 @ 42.6025009155273&#34;
## [1] &#34;2019-05-31 00:00:00 AAPL 250000 @ 43.7675018310547&#34;
## [1] &#34;2019-06-04 00:00:00 AAPL 250000 @ 44.9099998474121&#34;
## [1] &#34;2019-06-14 00:00:00 AAPL -5e+05 @ 48.185001373291&#34;
## [1] &#34;2020-03-02 00:00:00 AAPL 250000 @ 74.7024993896484&#34;
## [1] &#34;2020-03-24 00:00:00 AAPL 250000 @ 61.7200012207031&#34;
## [1] &#34;2020-04-20 00:00:00 AAPL -5e+05 @ 69.2324981689453&#34;
## [1] &#34;2021-09-22 00:00:00 AAPL 250000 @ 145.850006103516&#34;
## [1] &#34;2021-10-25 00:00:00 AAPL -250000 @ 148.639999389648&#34;
## [1] &#34;2022-06-16 00:00:00 AAPL 250000 @ 130.059997558594&#34;
## [1] &#34;2022-06-21 00:00:00 AAPL 250000 @ 135.869995117188&#34;
## [1] &#34;2022-07-12 00:00:00 AAPL -5e+05 @ 145.860000610352&#34;
## [1] &#34;2022-09-02 00:00:00 AAPL 250000 @ 155.809997558594&#34;
## [1] &#34;2022-09-08 00:00:00 AAPL 250000 @ 154.460006713867&#34;
## [1] &#34;2022-10-04 00:00:00 AAPL 250000 @ 146.100006103516&#34;
## [1] &#34;2022-10-27 00:00:00 AAPL -750000 @ 144.800003051758&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: NaN | 总收益: -1.0115 | 最大回撤: 1.0115 | 交易次数: 21 | 胜率: 0.71
## 测试参数组合 2/64: n=18, m1=2, m2=2
## 策略环境已重置
## [1] &#34;2018-02-12 00:00:00 AAPL 250000 @ 40.6775016784668&#34;
## [1] &#34;2018-03-02 00:00:00 AAPL -250000 @ 44.0525016784668&#34;
## [1] &#34;2018-04-04 00:00:00 AAPL 250000 @ 42.9025001525879&#34;
## [1] &#34;2018-04-20 00:00:00 AAPL -250000 @ 41.4300003051758&#34;
## [1] &#34;2018-05-01 00:00:00 AAPL 250000 @ 42.2750015258789&#34;
## [1] &#34;2018-05-15 00:00:00 AAPL -250000 @ 46.6100006103516&#34;
## [1] &#34;2018-11-19 00:00:00 AAPL 250000 @ 46.4650001525879&#34;
## [1] &#34;2018-11-27 00:00:00 AAPL 250000 @ 43.560001373291&#34;
## [1] &#34;2018-12-12 00:00:00 AAPL 250000 @ 42.2750015258789&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-02-08 00:00:00 AAPL -1e+06 @ 42.6025009155273&#34;
## [1] &#34;2019-05-31 00:00:00 AAPL 250000 @ 43.7675018310547&#34;
## [1] &#34;2019-06-04 00:00:00 AAPL 250000 @ 44.9099998474121&#34;
## [1] &#34;2019-06-26 00:00:00 AAPL -5e+05 @ 49.9500007629395&#34;
## [1] &#34;2020-09-16 00:00:00 AAPL 250000 @ 112.129997253418&#34;
## [1] &#34;2020-09-22 00:00:00 AAPL 250000 @ 111.809997558594&#34;
## [1] &#34;2020-10-15 00:00:00 AAPL -5e+05 @ 120.709999084473&#34;
## [1] &#34;2021-03-10 00:00:00 AAPL 250000 @ 119.980003356934&#34;
## [1] &#34;2021-04-15 00:00:00 AAPL -250000 @ 134.5&#34;
## [1] &#34;2021-10-04 00:00:00 AAPL 250000 @ 139.139999389648&#34;
## [1] &#34;2021-10-06 00:00:00 AAPL 250000 @ 142&#34;
## [1] &#34;2021-10-26 00:00:00 AAPL -5e+05 @ 149.320007324219&#34;
## [1] &#34;2022-01-25 00:00:00 AAPL 250000 @ 159.779998779297&#34;
## [1] &#34;2022-02-08 00:00:00 AAPL -250000 @ 174.830001831055&#34;
## [1] &#34;2022-05-16 00:00:00 AAPL 250000 @ 145.539993286133&#34;
## [1] &#34;2022-07-19 00:00:00 AAPL -250000 @ 151&#34;
## [1] &#34;2022-09-12 00:00:00 AAPL 250000 @ 163.429992675781&#34;
## [1] &#34;2022-09-20 00:00:00 AAPL 250000 @ 156.899993896484&#34;
## [1] &#34;2022-10-28 00:00:00 AAPL -5e+05 @ 155.740005493164&#34;
## [1] &#34;2022-12-22 00:00:00 AAPL 250000 @ 132.229995727539&#34;
## [1] &#34;2022-12-30 00:00:00 AAPL 250000 @ 129.929992675781&#34;
## [1] &#34;2023-01-09 00:00:00 AAPL 250000 @ 130.149993896484&#34;
## [1] &#34;2023-01-31 00:00:00 AAPL -750000 @ 144.289993286133&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: -0.1352 | 总收益: -1.0279 | 最大回撤: 1.0108 | 交易次数: 34 | 胜率: 0.75
## 测试参数组合 3/64: n=36, m1=2, m2=2
## 策略环境已重置
## [1] &#34;2018-05-01 00:00:00 AAPL 250000 @ 42.2750015258789&#34;
## [1] &#34;2018-05-15 00:00:00 AAPL -250000 @ 46.6100006103516&#34;
## [1] &#34;2018-11-19 00:00:00 AAPL 250000 @ 46.4650001525879&#34;
## [1] &#34;2018-11-27 00:00:00 AAPL 250000 @ 43.560001373291&#34;
## [1] &#34;2018-12-13 00:00:00 AAPL 250000 @ 42.7374992370605&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-01-09 00:00:00 AAPL 250000 @ 38.3274993896484&#34;
## [1] &#34;2019-02-11 00:00:00 AAPL -1250000 @ 42.3574981689453&#34;
## [1] &#34;2019-06-04 00:00:00 AAPL 250000 @ 44.9099998474121&#34;
## [1] &#34;2019-07-09 00:00:00 AAPL -250000 @ 50.310001373291&#34;
## [1] &#34;2020-03-25 00:00:00 AAPL 250000 @ 61.3800010681152&#34;
## [1] &#34;2020-04-21 00:00:00 AAPL -250000 @ 67.0924987792969&#34;
## [1] &#34;2021-03-10 00:00:00 AAPL 250000 @ 119.980003356934&#34;
## [1] &#34;2021-04-21 00:00:00 AAPL -250000 @ 133.5&#34;
## [1] &#34;2021-06-07 00:00:00 AAPL 250000 @ 125.900001525879&#34;
## [1] &#34;2021-07-07 00:00:00 AAPL -250000 @ 144.570007324219&#34;
## [1] &#34;2021-10-04 00:00:00 AAPL 250000 @ 139.139999389648&#34;
## [1] &#34;2021-10-06 00:00:00 AAPL 250000 @ 142&#34;
## [1] &#34;2021-11-11 00:00:00 AAPL -5e+05 @ 147.869995117188&#34;
## [1] &#34;2022-05-16 00:00:00 AAPL 250000 @ 145.539993286133&#34;
## [1] &#34;2022-05-24 00:00:00 AAPL 250000 @ 140.360000610352&#34;
## [1] &#34;2022-06-22 00:00:00 AAPL 250000 @ 135.350006103516&#34;
## [1] &#34;2022-07-26 00:00:00 AAPL -750000 @ 151.600006103516&#34;
## [1] &#34;2022-09-20 00:00:00 AAPL 250000 @ 156.899993896484&#34;
## [1] &#34;2022-09-29 00:00:00 AAPL 250000 @ 142.479995727539&#34;
## [1] &#34;2022-10-04 00:00:00 AAPL 250000 @ 146.100006103516&#34;
## [1] &#34;2022-10-14 00:00:00 AAPL 250000 @ 138.380004882812&#34;
## [1] &#34;2022-12-22 00:00:00 AAPL 250000 @ 132.229995727539&#34;
## [1] &#34;2022-12-30 00:00:00 AAPL 250000 @ 129.929992675781&#34;
## [1] &#34;2023-01-09 00:00:00 AAPL 250000 @ 130.149993896484&#34;
## [1] &#34;2023-02-07 00:00:00 AAPL -1750000 @ 154.649993896484&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: 41.4412 | 总收益: 3.30279074337661e+25 | 最大回撤: 3126.5533 | 交易次数: 32 | 胜率: 1
## 测试参数组合 4/64: n=55, m1=2, m2=2
## 策略环境已重置
## [1] &#34;2018-11-19 00:00:00 AAPL 250000 @ 46.4650001525879&#34;
## [1] &#34;2018-11-27 00:00:00 AAPL 250000 @ 43.560001373291&#34;
## [1] &#34;2018-12-13 00:00:00 AAPL 250000 @ 42.7374992370605&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-01-09 00:00:00 AAPL 250000 @ 38.3274993896484&#34;
## [1] &#34;2019-01-16 00:00:00 AAPL 250000 @ 38.7350006103516&#34;
## [1] &#34;2019-01-28 00:00:00 AAPL 250000 @ 39.0750007629395&#34;
## [1] &#34;2019-03-07 00:00:00 AAPL -1750000 @ 43.125&#34;
## [1] &#34;2019-06-05 00:00:00 AAPL 250000 @ 45.6349983215332&#34;
## [1] &#34;2019-07-12 00:00:00 AAPL -250000 @ 50.8250007629395&#34;
## [1] &#34;2020-03-25 00:00:00 AAPL 250000 @ 61.3800010681152&#34;
## [1] &#34;2020-05-18 00:00:00 AAPL -250000 @ 78.7399978637695&#34;
## [1] &#34;2021-03-10 00:00:00 AAPL 250000 @ 119.980003356934&#34;
## [1] &#34;2021-03-30 00:00:00 AAPL 250000 @ 119.900001525879&#34;
## [1] &#34;2021-04-01 00:00:00 AAPL 250000 @ 123&#34;
## [1] &#34;2021-04-23 00:00:00 AAPL -750000 @ 134.320007324219&#34;
## [1] &#34;2021-10-04 00:00:00 AAPL 250000 @ 139.139999389648&#34;
## [1] &#34;2021-10-06 00:00:00 AAPL 250000 @ 142&#34;
## [1] &#34;2021-11-29 00:00:00 AAPL -5e+05 @ 160.240005493164&#34;
## [1] &#34;2022-05-16 00:00:00 AAPL 250000 @ 145.539993286133&#34;
## [1] &#34;2022-05-24 00:00:00 AAPL 250000 @ 140.360000610352&#34;
## [1] &#34;2022-06-22 00:00:00 AAPL 250000 @ 135.350006103516&#34;
## [1] &#34;2022-08-09 00:00:00 AAPL -750000 @ 164.919998168945&#34;
## [1] &#34;2022-10-05 00:00:00 AAPL 250000 @ 146.399993896484&#34;
## [1] &#34;2022-10-14 00:00:00 AAPL 250000 @ 138.380004882812&#34;
## [1] &#34;2022-12-22 00:00:00 AAPL 250000 @ 132.229995727539&#34;
## [1] &#34;2022-12-30 00:00:00 AAPL 250000 @ 129.929992675781&#34;
## [1] &#34;2023-01-09 00:00:00 AAPL 250000 @ 130.149993896484&#34;
## [1] &#34;2023-02-10 00:00:00 AAPL -1250000 @ 151.009994506836&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: -0.0517 | 总收益: 126892019.8311 | 最大回撤: 6.8141 | 交易次数: 30 | 胜率: 1
## 测试参数组合 5/64: n=6, m1=3, m2=2
## 策略环境已重置
## [1] &#34;2018-11-27 00:00:00 AAPL 250000 @ 43.560001373291&#34;
## [1] &#34;2019-02-08 00:00:00 AAPL -250000 @ 42.6025009155273&#34;
## [1] &#34;2019-05-31 00:00:00 AAPL 250000 @ 43.7675018310547&#34;
## [1] &#34;2019-06-04 00:00:00 AAPL 250000 @ 44.9099998474121&#34;
## [1] &#34;2019-06-17 00:00:00 AAPL -5e+05 @ 48.4724998474121&#34;
## [1] &#34;2022-09-08 00:00:00 AAPL 250000 @ 154.460006713867&#34;
## [1] &#34;2023-01-19 00:00:00 AAPL -250000 @ 135.270004272461&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: NaN | 总收益: -1 | 最大回撤: 1.2291 | 交易次数: 8 | 胜率: 0.33
## 测试参数组合 6/64: n=18, m1=3, m2=2
## 策略环境已重置
## [1] &#34;2018-02-07 00:00:00 AAPL 250000 @ 39.8849983215332&#34;
## [1] &#34;2018-03-02 00:00:00 AAPL -250000 @ 44.0525016784668&#34;
## [1] &#34;2018-04-04 00:00:00 AAPL 250000 @ 42.9025001525879&#34;
## [1] &#34;2018-04-20 00:00:00 AAPL -250000 @ 41.4300003051758&#34;
## [1] &#34;2018-11-19 00:00:00 AAPL 250000 @ 46.4650001525879&#34;
## [1] &#34;2018-11-28 00:00:00 AAPL 250000 @ 45.2350006103516&#34;
## [1] &#34;2018-12-12 00:00:00 AAPL 250000 @ 42.2750015258789&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-02-08 00:00:00 AAPL -1e+06 @ 42.6025009155273&#34;
## [1] &#34;2019-06-04 00:00:00 AAPL 250000 @ 44.9099998474121&#34;
## [1] &#34;2019-06-26 00:00:00 AAPL -250000 @ 49.9500007629395&#34;
## [1] &#34;2020-09-22 00:00:00 AAPL 250000 @ 111.809997558594&#34;
## [1] &#34;2020-10-16 00:00:00 AAPL -250000 @ 119.019996643066&#34;
## [1] &#34;2021-02-24 00:00:00 AAPL 250000 @ 125.349998474121&#34;
## [1] &#34;2021-03-11 00:00:00 AAPL 250000 @ 121.959999084473&#34;
## [1] &#34;2021-04-15 00:00:00 AAPL -5e+05 @ 134.5&#34;
## [1] &#34;2021-10-07 00:00:00 AAPL 250000 @ 143.289993286133&#34;
## [1] &#34;2021-10-28 00:00:00 AAPL -250000 @ 152.570007324219&#34;
## [1] &#34;2022-01-26 00:00:00 AAPL 250000 @ 159.690002441406&#34;
## [1] &#34;2022-02-14 00:00:00 AAPL -250000 @ 168.880004882812&#34;
## [1] &#34;2022-04-29 00:00:00 AAPL 250000 @ 157.649993896484&#34;
## [1] &#34;2022-05-16 00:00:00 AAPL 250000 @ 145.539993286133&#34;
## [1] &#34;2022-05-24 00:00:00 AAPL 250000 @ 140.360000610352&#34;
## [1] &#34;2022-07-19 00:00:00 AAPL -750000 @ 151&#34;
## [1] &#34;2022-09-12 00:00:00 AAPL 250000 @ 163.429992675781&#34;
## [1] &#34;2022-09-20 00:00:00 AAPL 250000 @ 156.899993896484&#34;
## [1] &#34;2022-10-05 00:00:00 AAPL 250000 @ 146.399993896484&#34;
## [1] &#34;2022-10-14 00:00:00 AAPL 250000 @ 138.380004882812&#34;
## [1] &#34;2022-10-28 00:00:00 AAPL -1e+06 @ 155.740005493164&#34;
## [1] &#34;2022-12-22 00:00:00 AAPL 250000 @ 132.229995727539&#34;
## [1] &#34;2023-01-03 00:00:00 AAPL 250000 @ 125.069999694824&#34;
## [1] &#34;2023-01-09 00:00:00 AAPL 250000 @ 130.149993896484&#34;
## [1] &#34;2023-01-31 00:00:00 AAPL -750000 @ 144.289993286133&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: -0.0869 | 总收益: 1085.4944 | 最大回撤: 2.99 | 交易次数: 34 | 胜率: 0.82
## 测试参数组合 7/64: n=36, m1=3, m2=2
## 策略环境已重置
## [1] &#34;2018-11-19 00:00:00 AAPL 250000 @ 46.4650001525879&#34;
## [1] &#34;2018-11-28 00:00:00 AAPL 250000 @ 45.2350006103516&#34;
## [1] &#34;2018-12-14 00:00:00 AAPL 250000 @ 41.3699989318848&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-01-09 00:00:00 AAPL 250000 @ 38.3274993896484&#34;
## [1] &#34;2019-02-12 00:00:00 AAPL -1250000 @ 42.7224998474121&#34;
## [1] &#34;2019-06-05 00:00:00 AAPL 250000 @ 45.6349983215332&#34;
## [1] &#34;2019-07-10 00:00:00 AAPL -250000 @ 50.8074989318848&#34;
## [1] &#34;2020-03-25 00:00:00 AAPL 250000 @ 61.3800010681152&#34;
## [1] &#34;2020-05-13 00:00:00 AAPL -250000 @ 76.9124984741211&#34;
## [1] &#34;2021-03-12 00:00:00 AAPL 250000 @ 121.029998779297&#34;
## [1] &#34;2021-04-22 00:00:00 AAPL -250000 @ 131.940002441406&#34;
## [1] &#34;2021-10-07 00:00:00 AAPL 250000 @ 143.289993286133&#34;
## [1] &#34;2021-11-11 00:00:00 AAPL -250000 @ 147.869995117188&#34;
## [1] &#34;2022-05-16 00:00:00 AAPL 250000 @ 145.539993286133&#34;
## [1] &#34;2022-05-24 00:00:00 AAPL 250000 @ 140.360000610352&#34;
## [1] &#34;2022-06-22 00:00:00 AAPL 250000 @ 135.350006103516&#34;
## [1] &#34;2022-07-26 00:00:00 AAPL -750000 @ 151.600006103516&#34;
## [1] &#34;2022-10-05 00:00:00 AAPL 250000 @ 146.399993896484&#34;
## [1] &#34;2022-10-14 00:00:00 AAPL 250000 @ 138.380004882812&#34;
## [1] &#34;2023-01-03 00:00:00 AAPL 250000 @ 125.069999694824&#34;
## [1] &#34;2023-01-09 00:00:00 AAPL 250000 @ 130.149993896484&#34;
## [1] &#34;2023-02-10 00:00:00 AAPL -1e+06 @ 151.009994506836&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: -0.1004 | 总收益: -0.9874 | 最大回撤: 4.434 | 交易次数: 24 | 胜率: 1
## 测试参数组合 8/64: n=55, m1=3, m2=2
## 策略环境已重置
## [1] &#34;2018-11-19 00:00:00 AAPL 250000 @ 46.4650001525879&#34;
## [1] &#34;2018-11-28 00:00:00 AAPL 250000 @ 45.2350006103516&#34;
## [1] &#34;2018-12-14 00:00:00 AAPL 250000 @ 41.3699989318848&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-01-09 00:00:00 AAPL 250000 @ 38.3274993896484&#34;
## [1] &#34;2019-01-16 00:00:00 AAPL 250000 @ 38.7350006103516&#34;
## [1] &#34;2019-01-28 00:00:00 AAPL 250000 @ 39.0750007629395&#34;
## [1] &#34;2019-03-08 00:00:00 AAPL -1750000 @ 43.2275009155273&#34;
## [1] &#34;2019-06-05 00:00:00 AAPL 250000 @ 45.6349983215332&#34;
## [1] &#34;2019-08-01 00:00:00 AAPL -250000 @ 52.1074981689453&#34;
## [1] &#34;2020-03-25 00:00:00 AAPL 250000 @ 61.3800010681152&#34;
## [1] &#34;2020-05-28 00:00:00 AAPL -250000 @ 79.5625&#34;
## [1] &#34;2021-03-12 00:00:00 AAPL 250000 @ 121.029998779297&#34;
## [1] &#34;2021-04-01 00:00:00 AAPL 250000 @ 123&#34;
## [1] &#34;2021-05-03 00:00:00 AAPL -5e+05 @ 132.539993286133&#34;
## [1] &#34;2021-10-07 00:00:00 AAPL 250000 @ 143.289993286133&#34;
## [1] &#34;2021-11-29 00:00:00 AAPL -250000 @ 160.240005493164&#34;
## [1] &#34;2022-03-17 00:00:00 AAPL 250000 @ 160.619995117188&#34;
## [1] &#34;2022-04-07 00:00:00 AAPL -250000 @ 172.139999389648&#34;
## [1] &#34;2022-05-17 00:00:00 AAPL 250000 @ 149.240005493164&#34;
## [1] &#34;2022-05-24 00:00:00 AAPL 250000 @ 140.360000610352&#34;
## [1] &#34;2022-06-22 00:00:00 AAPL 250000 @ 135.350006103516&#34;
## [1] &#34;2022-08-10 00:00:00 AAPL -750000 @ 169.240005493164&#34;
## [1] &#34;2022-10-06 00:00:00 AAPL 250000 @ 145.429992675781&#34;
## [1] &#34;2022-10-14 00:00:00 AAPL 250000 @ 138.380004882812&#34;
## [1] &#34;2022-11-11 00:00:00 AAPL 250000 @ 149.699996948242&#34;
## [1] &#34;2023-01-03 00:00:00 AAPL 250000 @ 125.069999694824&#34;
## [1] &#34;2023-01-09 00:00:00 AAPL 250000 @ 130.149993896484&#34;
## [1] &#34;2023-02-13 00:00:00 AAPL -1250000 @ 153.850006103516&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: -0.0429 | 总收益: 1131484107.8157 | 最大回撤: 731.8759 | 交易次数: 30 | 胜率: 1
## 测试参数组合 9/64: n=6, m1=4, m2=2
## 策略环境已重置
## [1] &#34;2018-11-28 00:00:00 AAPL 250000 @ 45.2350006103516&#34;
## [1] &#34;2019-02-08 00:00:00 AAPL -250000 @ 42.6025009155273&#34;
## [1] &#34;2019-06-04 00:00:00 AAPL 250000 @ 44.9099998474121&#34;
## [1] &#34;2019-06-17 00:00:00 AAPL -250000 @ 48.4724998474121&#34;
## [1] &#34;2022-09-08 00:00:00 AAPL 250000 @ 154.460006713867&#34;
## [1] &#34;2023-01-20 00:00:00 AAPL -250000 @ 137.869995117188&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: NaN | 总收益: -1 | 最大回撤: 1.0966 | 交易次数: 7 | 胜率: 0.33
## 测试参数组合 10/64: n=18, m1=4, m2=2
## 策略环境已重置
## [1] &#34;2018-11-29 00:00:00 AAPL 250000 @ 44.8875007629395&#34;
## [1] &#34;2018-12-13 00:00:00 AAPL 250000 @ 42.7374992370605&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-02-08 00:00:00 AAPL -750000 @ 42.6025009155273&#34;
## [1] &#34;2019-06-05 00:00:00 AAPL 250000 @ 45.6349983215332&#34;
## [1] &#34;2019-06-26 00:00:00 AAPL -250000 @ 49.9500007629395&#34;
## [1] &#34;2020-03-25 00:00:00 AAPL 250000 @ 61.3800010681152&#34;
## [1] &#34;2020-04-21 00:00:00 AAPL -250000 @ 67.0924987792969&#34;
## [1] &#34;2020-09-23 00:00:00 AAPL 250000 @ 107.120002746582&#34;
## [1] &#34;2020-09-28 00:00:00 AAPL 250000 @ 114.959999084473&#34;
## [1] &#34;2020-10-19 00:00:00 AAPL -5e+05 @ 115.980003356934&#34;
## [1] &#34;2021-10-07 00:00:00 AAPL 250000 @ 143.289993286133&#34;
## [1] &#34;2021-11-01 00:00:00 AAPL -250000 @ 148.960006713867&#34;
## [1] &#34;2022-04-29 00:00:00 AAPL 250000 @ 157.649993896484&#34;
## [1] &#34;2022-05-03 00:00:00 AAPL 250000 @ 159.479995727539&#34;
## [1] &#34;2022-05-16 00:00:00 AAPL 250000 @ 145.539993286133&#34;
## [1] &#34;2022-05-24 00:00:00 AAPL 250000 @ 140.360000610352&#34;
## [1] &#34;2022-07-26 00:00:00 AAPL -1e+06 @ 151.600006103516&#34;
## [1] &#34;2022-09-20 00:00:00 AAPL 250000 @ 156.899993896484&#34;
## [1] &#34;2022-10-05 00:00:00 AAPL 250000 @ 146.399993896484&#34;
## [1] &#34;2022-10-14 00:00:00 AAPL 250000 @ 138.380004882812&#34;
## [1] &#34;2022-12-22 00:00:00 AAPL 250000 @ 132.229995727539&#34;
## [1] &#34;2023-01-03 00:00:00 AAPL 250000 @ 125.069999694824&#34;
## [1] &#34;2023-01-09 00:00:00 AAPL 250000 @ 130.149993896484&#34;
## [1] &#34;2023-02-07 00:00:00 AAPL -1500000 @ 154.649993896484&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: NaN | 总收益: -1.63824951922408e+31 | 最大回撤: 537.8647 | 交易次数: 26 | 胜率: 1
## 测试参数组合 11/64: n=36, m1=4, m2=2
## 策略环境已重置
## [1] &#34;2018-11-29 00:00:00 AAPL 250000 @ 44.8875007629395&#34;
## [1] &#34;2018-12-14 00:00:00 AAPL 250000 @ 41.3699989318848&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-01-09 00:00:00 AAPL 250000 @ 38.3274993896484&#34;
## [1] &#34;2019-03-07 00:00:00 AAPL -1e+06 @ 43.125&#34;
## [1] &#34;2019-06-05 00:00:00 AAPL 250000 @ 45.6349983215332&#34;
## [1] &#34;2019-07-22 00:00:00 AAPL -250000 @ 51.8050003051758&#34;
## [1] &#34;2020-03-25 00:00:00 AAPL 250000 @ 61.3800010681152&#34;
## [1] &#34;2020-05-14 00:00:00 AAPL -250000 @ 77.3850021362305&#34;
## [1] &#34;2021-03-12 00:00:00 AAPL 250000 @ 121.029998779297&#34;
## [1] &#34;2021-04-23 00:00:00 AAPL -250000 @ 134.320007324219&#34;
## [1] &#34;2021-10-07 00:00:00 AAPL 250000 @ 143.289993286133&#34;
## [1] &#34;2021-11-11 00:00:00 AAPL -250000 @ 147.869995117188&#34;
## [1] &#34;2022-05-18 00:00:00 AAPL 250000 @ 140.820007324219&#34;
## [1] &#34;2022-05-24 00:00:00 AAPL 250000 @ 140.360000610352&#34;
## [1] &#34;2022-06-23 00:00:00 AAPL 250000 @ 138.270004272461&#34;
## [1] &#34;2022-07-27 00:00:00 AAPL -750000 @ 156.789993286133&#34;
## [1] &#34;2022-10-05 00:00:00 AAPL 250000 @ 146.399993896484&#34;
## [1] &#34;2022-10-14 00:00:00 AAPL 250000 @ 138.380004882812&#34;
## [1] &#34;2023-01-03 00:00:00 AAPL 250000 @ 125.069999694824&#34;
## [1] &#34;2023-01-09 00:00:00 AAPL 250000 @ 130.149993896484&#34;
## [1] &#34;2023-02-10 00:00:00 AAPL -1e+06 @ 151.009994506836&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: NaN | 总收益: -2881.9695 | 最大回撤: 77.341 | 交易次数: 23 | 胜率: 1
## 测试参数组合 12/64: n=55, m1=4, m2=2
## 策略环境已重置
## [1] &#34;2018-11-29 00:00:00 AAPL 250000 @ 44.8875007629395&#34;
## [1] &#34;2018-12-14 00:00:00 AAPL 250000 @ 41.3699989318848&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-01-09 00:00:00 AAPL 250000 @ 38.3274993896484&#34;
## [1] &#34;2019-03-08 00:00:00 AAPL -1e+06 @ 43.2275009155273&#34;
## [1] &#34;2019-06-06 00:00:00 AAPL 250000 @ 46.3050003051758&#34;
## [1] &#34;2019-08-01 00:00:00 AAPL -250000 @ 52.1074981689453&#34;
## [1] &#34;2020-03-25 00:00:00 AAPL 250000 @ 61.3800010681152&#34;
## [1] &#34;2020-06-12 00:00:00 AAPL -250000 @ 84.6999969482422&#34;
## [1] &#34;2021-03-12 00:00:00 AAPL 250000 @ 121.029998779297&#34;
## [1] &#34;2021-04-01 00:00:00 AAPL 250000 @ 123&#34;
## [1] &#34;2021-05-03 00:00:00 AAPL -5e+05 @ 132.539993286133&#34;
## [1] &#34;2021-10-08 00:00:00 AAPL 250000 @ 142.899993896484&#34;
## [1] &#34;2021-11-29 00:00:00 AAPL -250000 @ 160.240005493164&#34;
## [1] &#34;2022-05-18 00:00:00 AAPL 250000 @ 140.820007324219&#34;
## [1] &#34;2022-05-24 00:00:00 AAPL 250000 @ 140.360000610352&#34;
## [1] &#34;2022-06-23 00:00:00 AAPL 250000 @ 138.270004272461&#34;
## [1] &#34;2022-08-19 00:00:00 AAPL -750000 @ 171.520004272461&#34;
## [1] &#34;2022-10-06 00:00:00 AAPL 250000 @ 145.429992675781&#34;
## [1] &#34;2022-10-14 00:00:00 AAPL 250000 @ 138.380004882812&#34;
## [1] &#34;2022-10-18 00:00:00 AAPL 250000 @ 143.75&#34;
## [1] &#34;2022-11-11 00:00:00 AAPL 250000 @ 149.699996948242&#34;
## [1] &#34;2023-01-03 00:00:00 AAPL 250000 @ 125.069999694824&#34;
## [1] &#34;2023-01-09 00:00:00 AAPL 250000 @ 130.149993896484&#34;
## [1] &#34;2023-02-22 00:00:00 AAPL -1500000 @ 148.910003662109&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: 14.5922 | 总收益: 5.15945247500254e+22 | 最大回撤: 537.8647 | 交易次数: 26 | 胜率: 1
## 测试参数组合 13/64: n=6, m1=5, m2=2
## 策略环境已重置
## [1] &#34;2018-11-28 00:00:00 AAPL 250000 @ 45.2350006103516&#34;
## [1] &#34;2019-02-08 00:00:00 AAPL -250000 @ 42.6025009155273&#34;
## [1] &#34;2022-09-09 00:00:00 AAPL 250000 @ 157.369995117188&#34;
## [1] &#34;2023-01-31 00:00:00 AAPL -250000 @ 144.289993286133&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: NaN | 总收益: -1 | 最大回撤: 1.0252 | 交易次数: 5 | 胜率: 0
## 测试参数组合 14/64: n=18, m1=5, m2=2
## 策略环境已重置
## [1] &#34;2018-11-29 00:00:00 AAPL 250000 @ 44.8875007629395&#34;
## [1] &#34;2018-12-13 00:00:00 AAPL 250000 @ 42.7374992370605&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-02-11 00:00:00 AAPL -750000 @ 42.3574981689453&#34;
## [1] &#34;2019-06-05 00:00:00 AAPL 250000 @ 45.6349983215332&#34;
## [1] &#34;2019-07-01 00:00:00 AAPL -250000 @ 50.3875007629395&#34;
## [1] &#34;2020-09-28 00:00:00 AAPL 250000 @ 114.959999084473&#34;
## [1] &#34;2020-10-19 00:00:00 AAPL -250000 @ 115.980003356934&#34;
## [1] &#34;2021-10-07 00:00:00 AAPL 250000 @ 143.289993286133&#34;
## [1] &#34;2021-11-02 00:00:00 AAPL -250000 @ 150.020004272461&#34;
## [1] &#34;2022-05-17 00:00:00 AAPL 250000 @ 149.240005493164&#34;
## [1] &#34;2022-05-24 00:00:00 AAPL 250000 @ 140.360000610352&#34;
## [1] &#34;2022-07-27 00:00:00 AAPL -5e+05 @ 156.789993286133&#34;
## [1] &#34;2022-09-20 00:00:00 AAPL 250000 @ 156.899993896484&#34;
## [1] &#34;2022-10-05 00:00:00 AAPL 250000 @ 146.399993896484&#34;
## [1] &#34;2022-10-14 00:00:00 AAPL 250000 @ 138.380004882812&#34;
## [1] &#34;2023-01-03 00:00:00 AAPL 250000 @ 125.069999694824&#34;
## [1] &#34;2023-01-09 00:00:00 AAPL 250000 @ 130.149993896484&#34;
## [1] &#34;2023-02-07 00:00:00 AAPL -1250000 @ 154.649993896484&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: 0.3329 | 总收益: 2693125516525510 | 最大回撤: 731.8759 | 交易次数: 20 | 胜率: 1
## 测试参数组合 15/64: n=36, m1=5, m2=2
## 策略环境已重置
## [1] &#34;2018-11-29 00:00:00 AAPL 250000 @ 44.8875007629395&#34;
## [1] &#34;2018-12-14 00:00:00 AAPL 250000 @ 41.3699989318848&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-01-09 00:00:00 AAPL 250000 @ 38.3274993896484&#34;
## [1] &#34;2019-03-07 00:00:00 AAPL -1e+06 @ 43.125&#34;
## [1] &#34;2019-06-05 00:00:00 AAPL 250000 @ 45.6349983215332&#34;
## [1] &#34;2019-07-29 00:00:00 AAPL -250000 @ 52.4199981689453&#34;
## [1] &#34;2020-03-25 00:00:00 AAPL 250000 @ 61.3800010681152&#34;
## [1] &#34;2020-05-14 00:00:00 AAPL -250000 @ 77.3850021362305&#34;
## [1] &#34;2021-03-12 00:00:00 AAPL 250000 @ 121.029998779297&#34;
## [1] &#34;2021-04-30 00:00:00 AAPL -250000 @ 131.460006713867&#34;
## [1] &#34;2021-10-08 00:00:00 AAPL 250000 @ 142.899993896484&#34;
## [1] &#34;2021-11-11 00:00:00 AAPL -250000 @ 147.869995117188&#34;
## [1] &#34;2022-05-18 00:00:00 AAPL 250000 @ 140.820007324219&#34;
## [1] &#34;2022-05-24 00:00:00 AAPL 250000 @ 140.360000610352&#34;
## [1] &#34;2022-06-24 00:00:00 AAPL 250000 @ 141.660003662109&#34;
## [1] &#34;2022-08-10 00:00:00 AAPL -750000 @ 169.240005493164&#34;
## [1] &#34;2022-10-05 00:00:00 AAPL 250000 @ 146.399993896484&#34;
## [1] &#34;2022-10-14 00:00:00 AAPL 250000 @ 138.380004882812&#34;
## [1] &#34;2023-01-09 00:00:00 AAPL 250000 @ 130.149993896484&#34;
## [1] &#34;2023-02-22 00:00:00 AAPL -750000 @ 148.910003662109&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: -0.0977 | 总收益: 4241.9639 | 最大回撤: 77.341 | 交易次数: 22 | 胜率: 1
## 测试参数组合 16/64: n=55, m1=5, m2=2
## 策略环境已重置
## [1] &#34;2018-11-29 00:00:00 AAPL 250000 @ 44.8875007629395&#34;
## [1] &#34;2018-12-14 00:00:00 AAPL 250000 @ 41.3699989318848&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-01-09 00:00:00 AAPL 250000 @ 38.3274993896484&#34;
## [1] &#34;2019-03-25 00:00:00 AAPL -1e+06 @ 47.185001373291&#34;
## [1] &#34;2019-06-06 00:00:00 AAPL 250000 @ 46.3050003051758&#34;
## [1] &#34;2019-08-01 00:00:00 AAPL -250000 @ 52.1074981689453&#34;
## [1] &#34;2020-03-25 00:00:00 AAPL 250000 @ 61.3800010681152&#34;
## [1] &#34;2020-06-12 00:00:00 AAPL -250000 @ 84.6999969482422&#34;
## [1] &#34;2021-03-16 00:00:00 AAPL 250000 @ 125.569999694824&#34;
## [1] &#34;2021-04-05 00:00:00 AAPL 250000 @ 125.900001525879&#34;
## [1] &#34;2021-05-05 00:00:00 AAPL -5e+05 @ 128.100006103516&#34;
## [1] &#34;2021-10-08 00:00:00 AAPL 250000 @ 142.899993896484&#34;
## [1] &#34;2021-11-29 00:00:00 AAPL -250000 @ 160.240005493164&#34;
## [1] &#34;2022-05-18 00:00:00 AAPL 250000 @ 140.820007324219&#34;
## [1] &#34;2022-05-24 00:00:00 AAPL 250000 @ 140.360000610352&#34;
## [1] &#34;2022-06-24 00:00:00 AAPL 250000 @ 141.660003662109&#34;
## [1] &#34;2022-08-22 00:00:00 AAPL -750000 @ 167.570007324219&#34;
## [1] &#34;2022-10-18 00:00:00 AAPL 250000 @ 143.75&#34;
## [1] &#34;2023-01-09 00:00:00 AAPL 250000 @ 130.149993896484&#34;
## [1] &#34;2023-02-22 00:00:00 AAPL -5e+05 @ 148.910003662109&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: -0.1193 | 总收益: -1 | 最大回撤: 37.159 | 交易次数: 22 | 胜率: 1
## 测试参数组合 17/64: n=6, m1=2, m2=3
## 策略环境已重置
## [1] &#34;2018-11-27 00:00:00 AAPL 250000 @ 43.560001373291&#34;
## [1] &#34;2019-02-08 00:00:00 AAPL -250000 @ 42.6025009155273&#34;
## [1] &#34;2019-05-31 00:00:00 AAPL 250000 @ 43.7675018310547&#34;
## [1] &#34;2019-06-04 00:00:00 AAPL 250000 @ 44.9099998474121&#34;
## [1] &#34;2019-06-17 00:00:00 AAPL -5e+05 @ 48.4724998474121&#34;
## [1] &#34;2022-09-08 00:00:00 AAPL 250000 @ 154.460006713867&#34;
## [1] &#34;2023-01-19 00:00:00 AAPL -250000 @ 135.270004272461&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: NaN | 总收益: -1 | 最大回撤: 1.2291 | 交易次数: 8 | 胜率: 0.33
## 测试参数组合 18/64: n=18, m1=2, m2=3
## 策略环境已重置
## [1] &#34;2018-04-04 00:00:00 AAPL 250000 @ 42.9025001525879&#34;
## [1] &#34;2018-04-20 00:00:00 AAPL -250000 @ 41.4300003051758&#34;
## [1] &#34;2018-11-19 00:00:00 AAPL 250000 @ 46.4650001525879&#34;
## [1] &#34;2018-11-28 00:00:00 AAPL 250000 @ 45.2350006103516&#34;
## [1] &#34;2018-12-12 00:00:00 AAPL 250000 @ 42.2750015258789&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-02-08 00:00:00 AAPL -1e+06 @ 42.6025009155273&#34;
## [1] &#34;2019-06-04 00:00:00 AAPL 250000 @ 44.9099998474121&#34;
## [1] &#34;2019-06-26 00:00:00 AAPL -250000 @ 49.9500007629395&#34;
## [1] &#34;2020-09-22 00:00:00 AAPL 250000 @ 111.809997558594&#34;
## [1] &#34;2020-10-16 00:00:00 AAPL -250000 @ 119.019996643066&#34;
## [1] &#34;2021-03-11 00:00:00 AAPL 250000 @ 121.959999084473&#34;
## [1] &#34;2021-04-15 00:00:00 AAPL -250000 @ 134.5&#34;
## [1] &#34;2022-01-26 00:00:00 AAPL 250000 @ 159.690002441406&#34;
## [1] &#34;2022-02-14 00:00:00 AAPL -250000 @ 168.880004882812&#34;
## [1] &#34;2022-05-16 00:00:00 AAPL 250000 @ 145.539993286133&#34;
## [1] &#34;2022-07-19 00:00:00 AAPL -250000 @ 151&#34;
## [1] &#34;2022-09-12 00:00:00 AAPL 250000 @ 163.429992675781&#34;
## [1] &#34;2022-09-20 00:00:00 AAPL 250000 @ 156.899993896484&#34;
## [1] &#34;2022-10-28 00:00:00 AAPL -5e+05 @ 155.740005493164&#34;
## [1] &#34;2022-12-22 00:00:00 AAPL 250000 @ 132.229995727539&#34;
## [1] &#34;2023-01-03 00:00:00 AAPL 250000 @ 125.069999694824&#34;
## [1] &#34;2023-01-09 00:00:00 AAPL 250000 @ 130.149993896484&#34;
## [1] &#34;2023-01-31 00:00:00 AAPL -750000 @ 144.289993286133&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: -0.1471 | 总收益: -1 | 最大回撤: 1.0039 | 交易次数: 25 | 胜率: 0.67
## 测试参数组合 19/64: n=36, m1=2, m2=3
## 策略环境已重置
## [1] &#34;2018-11-19 00:00:00 AAPL 250000 @ 46.4650001525879&#34;
## [1] &#34;2018-11-28 00:00:00 AAPL 250000 @ 45.2350006103516&#34;
## [1] &#34;2018-12-14 00:00:00 AAPL 250000 @ 41.3699989318848&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-01-09 00:00:00 AAPL 250000 @ 38.3274993896484&#34;
## [1] &#34;2019-02-12 00:00:00 AAPL -1250000 @ 42.7224998474121&#34;
## [1] &#34;2019-06-05 00:00:00 AAPL 250000 @ 45.6349983215332&#34;
## [1] &#34;2019-07-10 00:00:00 AAPL -250000 @ 50.8074989318848&#34;
## [1] &#34;2020-03-25 00:00:00 AAPL 250000 @ 61.3800010681152&#34;
## [1] &#34;2020-05-13 00:00:00 AAPL -250000 @ 76.9124984741211&#34;
## [1] &#34;2021-03-12 00:00:00 AAPL 250000 @ 121.029998779297&#34;
## [1] &#34;2021-04-22 00:00:00 AAPL -250000 @ 131.940002441406&#34;
## [1] &#34;2021-10-07 00:00:00 AAPL 250000 @ 143.289993286133&#34;
## [1] &#34;2021-11-11 00:00:00 AAPL -250000 @ 147.869995117188&#34;
## [1] &#34;2022-05-16 00:00:00 AAPL 250000 @ 145.539993286133&#34;
## [1] &#34;2022-05-24 00:00:00 AAPL 250000 @ 140.360000610352&#34;
## [1] &#34;2022-06-22 00:00:00 AAPL 250000 @ 135.350006103516&#34;
## [1] &#34;2022-07-26 00:00:00 AAPL -750000 @ 151.600006103516&#34;
## [1] &#34;2022-10-05 00:00:00 AAPL 250000 @ 146.399993896484&#34;
## [1] &#34;2022-10-14 00:00:00 AAPL 250000 @ 138.380004882812&#34;
## [1] &#34;2023-01-03 00:00:00 AAPL 250000 @ 125.069999694824&#34;
## [1] &#34;2023-01-09 00:00:00 AAPL 250000 @ 130.149993896484&#34;
## [1] &#34;2023-02-10 00:00:00 AAPL -1e+06 @ 151.009994506836&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: -0.1004 | 总收益: -0.9874 | 最大回撤: 4.434 | 交易次数: 24 | 胜率: 1
## 测试参数组合 20/64: n=55, m1=2, m2=3
## 策略环境已重置
## [1] &#34;2018-11-19 00:00:00 AAPL 250000 @ 46.4650001525879&#34;
## [1] &#34;2018-11-28 00:00:00 AAPL 250000 @ 45.2350006103516&#34;
## [1] &#34;2018-12-14 00:00:00 AAPL 250000 @ 41.3699989318848&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-01-09 00:00:00 AAPL 250000 @ 38.3274993896484&#34;
## [1] &#34;2019-01-16 00:00:00 AAPL 250000 @ 38.7350006103516&#34;
## [1] &#34;2019-01-28 00:00:00 AAPL 250000 @ 39.0750007629395&#34;
## [1] &#34;2019-03-08 00:00:00 AAPL -1750000 @ 43.2275009155273&#34;
## [1] &#34;2019-06-05 00:00:00 AAPL 250000 @ 45.6349983215332&#34;
## [1] &#34;2019-08-01 00:00:00 AAPL -250000 @ 52.1074981689453&#34;
## [1] &#34;2020-03-25 00:00:00 AAPL 250000 @ 61.3800010681152&#34;
## [1] &#34;2020-05-28 00:00:00 AAPL -250000 @ 79.5625&#34;
## [1] &#34;2021-03-12 00:00:00 AAPL 250000 @ 121.029998779297&#34;
## [1] &#34;2021-04-01 00:00:00 AAPL 250000 @ 123&#34;
## [1] &#34;2021-05-03 00:00:00 AAPL -5e+05 @ 132.539993286133&#34;
## [1] &#34;2021-10-07 00:00:00 AAPL 250000 @ 143.289993286133&#34;
## [1] &#34;2021-11-29 00:00:00 AAPL -250000 @ 160.240005493164&#34;
## [1] &#34;2022-05-17 00:00:00 AAPL 250000 @ 149.240005493164&#34;
## [1] &#34;2022-05-24 00:00:00 AAPL 250000 @ 140.360000610352&#34;
## [1] &#34;2022-06-22 00:00:00 AAPL 250000 @ 135.350006103516&#34;
## [1] &#34;2022-08-10 00:00:00 AAPL -750000 @ 169.240005493164&#34;
## [1] &#34;2022-10-06 00:00:00 AAPL 250000 @ 145.429992675781&#34;
## [1] &#34;2022-10-14 00:00:00 AAPL 250000 @ 138.380004882812&#34;
## [1] &#34;2023-01-03 00:00:00 AAPL 250000 @ 125.069999694824&#34;
## [1] &#34;2023-01-09 00:00:00 AAPL 250000 @ 130.149993896484&#34;
## [1] &#34;2023-02-13 00:00:00 AAPL -1e+06 @ 153.850006103516&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: -0.0912 | 总收益: -0.9686 | 最大回撤: 8.3985 | 交易次数: 27 | 胜率: 1
## 测试参数组合 21/64: n=6, m1=3, m2=3
## 策略环境已重置
## [1] &#34;2018-11-28 00:00:00 AAPL 250000 @ 45.2350006103516&#34;
## [1] &#34;2019-02-08 00:00:00 AAPL -250000 @ 42.6025009155273&#34;
## [1] &#34;2022-09-08 00:00:00 AAPL 250000 @ 154.460006713867&#34;
## [1] &#34;2023-01-20 00:00:00 AAPL -250000 @ 137.869995117188&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: NaN | 总收益: -1 | 最大回撤: 1.0435 | 交易次数: 5 | 胜率: 0
## 测试参数组合 22/64: n=18, m1=3, m2=3
## 策略环境已重置
## [1] &#34;2018-11-29 00:00:00 AAPL 250000 @ 44.8875007629395&#34;
## [1] &#34;2018-12-13 00:00:00 AAPL 250000 @ 42.7374992370605&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-02-11 00:00:00 AAPL -750000 @ 42.3574981689453&#34;
## [1] &#34;2019-06-05 00:00:00 AAPL 250000 @ 45.6349983215332&#34;
## [1] &#34;2019-06-26 00:00:00 AAPL -250000 @ 49.9500007629395&#34;
## [1] &#34;2020-09-23 00:00:00 AAPL 250000 @ 107.120002746582&#34;
## [1] &#34;2020-09-28 00:00:00 AAPL 250000 @ 114.959999084473&#34;
## [1] &#34;2020-10-19 00:00:00 AAPL -5e+05 @ 115.980003356934&#34;
## [1] &#34;2021-10-07 00:00:00 AAPL 250000 @ 143.289993286133&#34;
## [1] &#34;2021-11-01 00:00:00 AAPL -250000 @ 148.960006713867&#34;
## [1] &#34;2022-04-29 00:00:00 AAPL 250000 @ 157.649993896484&#34;
## [1] &#34;2022-05-03 00:00:00 AAPL 250000 @ 159.479995727539&#34;
## [1] &#34;2022-05-17 00:00:00 AAPL 250000 @ 149.240005493164&#34;
## [1] &#34;2022-05-24 00:00:00 AAPL 250000 @ 140.360000610352&#34;
## [1] &#34;2022-07-26 00:00:00 AAPL -1e+06 @ 151.600006103516&#34;
## [1] &#34;2022-09-20 00:00:00 AAPL 250000 @ 156.899993896484&#34;
## [1] &#34;2022-10-05 00:00:00 AAPL 250000 @ 146.399993896484&#34;
## [1] &#34;2022-10-14 00:00:00 AAPL 250000 @ 138.380004882812&#34;
## [1] &#34;2023-01-03 00:00:00 AAPL 250000 @ 125.069999694824&#34;
## [1] &#34;2023-01-09 00:00:00 AAPL 250000 @ 130.149993896484&#34;
## [1] &#34;2023-02-07 00:00:00 AAPL -1250000 @ 154.649993896484&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: NaN | 总收益: -8.66122433252946e+30 | 最大回撤: 1530.7447 | 交易次数: 23 | 胜率: 0.83
## 测试参数组合 23/64: n=36, m1=3, m2=3
## 策略环境已重置
## [1] &#34;2018-11-29 00:00:00 AAPL 250000 @ 44.8875007629395&#34;
## [1] &#34;2018-12-14 00:00:00 AAPL 250000 @ 41.3699989318848&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-01-09 00:00:00 AAPL 250000 @ 38.3274993896484&#34;
## [1] &#34;2019-03-07 00:00:00 AAPL -1e+06 @ 43.125&#34;
## [1] &#34;2019-06-05 00:00:00 AAPL 250000 @ 45.6349983215332&#34;
## [1] &#34;2019-07-22 00:00:00 AAPL -250000 @ 51.8050003051758&#34;
## [1] &#34;2020-03-25 00:00:00 AAPL 250000 @ 61.3800010681152&#34;
## [1] &#34;2020-05-14 00:00:00 AAPL -250000 @ 77.3850021362305&#34;
## [1] &#34;2021-03-12 00:00:00 AAPL 250000 @ 121.029998779297&#34;
## [1] &#34;2021-04-23 00:00:00 AAPL -250000 @ 134.320007324219&#34;
## [1] &#34;2021-10-07 00:00:00 AAPL 250000 @ 143.289993286133&#34;
## [1] &#34;2021-11-11 00:00:00 AAPL -250000 @ 147.869995117188&#34;
## [1] &#34;2022-05-18 00:00:00 AAPL 250000 @ 140.820007324219&#34;
## [1] &#34;2022-05-24 00:00:00 AAPL 250000 @ 140.360000610352&#34;
## [1] &#34;2022-06-23 00:00:00 AAPL 250000 @ 138.270004272461&#34;
## [1] &#34;2022-07-27 00:00:00 AAPL -750000 @ 156.789993286133&#34;
## [1] &#34;2022-10-05 00:00:00 AAPL 250000 @ 146.399993896484&#34;
## [1] &#34;2022-10-14 00:00:00 AAPL 250000 @ 138.380004882812&#34;
## [1] &#34;2023-01-03 00:00:00 AAPL 250000 @ 125.069999694824&#34;
## [1] &#34;2023-01-09 00:00:00 AAPL 250000 @ 130.149993896484&#34;
## [1] &#34;2023-02-13 00:00:00 AAPL -1e+06 @ 153.850006103516&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: NaN | 总收益: -11063.9561 | 最大回撤: 77.341 | 交易次数: 23 | 胜率: 1
## 测试参数组合 24/64: n=55, m1=3, m2=3
## 策略环境已重置
## [1] &#34;2018-11-29 00:00:00 AAPL 250000 @ 44.8875007629395&#34;
## [1] &#34;2018-12-14 00:00:00 AAPL 250000 @ 41.3699989318848&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-01-09 00:00:00 AAPL 250000 @ 38.3274993896484&#34;
## [1] &#34;2019-03-08 00:00:00 AAPL -1e+06 @ 43.2275009155273&#34;
## [1] &#34;2019-06-06 00:00:00 AAPL 250000 @ 46.3050003051758&#34;
## [1] &#34;2019-08-01 00:00:00 AAPL -250000 @ 52.1074981689453&#34;
## [1] &#34;2020-03-25 00:00:00 AAPL 250000 @ 61.3800010681152&#34;
## [1] &#34;2020-06-12 00:00:00 AAPL -250000 @ 84.6999969482422&#34;
## [1] &#34;2021-03-12 00:00:00 AAPL 250000 @ 121.029998779297&#34;
## [1] &#34;2021-04-05 00:00:00 AAPL 250000 @ 125.900001525879&#34;
## [1] &#34;2021-05-03 00:00:00 AAPL -5e+05 @ 132.539993286133&#34;
## [1] &#34;2021-10-08 00:00:00 AAPL 250000 @ 142.899993896484&#34;
## [1] &#34;2021-11-29 00:00:00 AAPL -250000 @ 160.240005493164&#34;
## [1] &#34;2022-05-18 00:00:00 AAPL 250000 @ 140.820007324219&#34;
## [1] &#34;2022-05-24 00:00:00 AAPL 250000 @ 140.360000610352&#34;
## [1] &#34;2022-06-24 00:00:00 AAPL 250000 @ 141.660003662109&#34;
## [1] &#34;2022-08-22 00:00:00 AAPL -750000 @ 167.570007324219&#34;
## [1] &#34;2022-10-07 00:00:00 AAPL 250000 @ 140.089996337891&#34;
## [1] &#34;2022-10-14 00:00:00 AAPL 250000 @ 138.380004882812&#34;
## [1] &#34;2022-10-18 00:00:00 AAPL 250000 @ 143.75&#34;
## [1] &#34;2022-11-11 00:00:00 AAPL 250000 @ 149.699996948242&#34;
## [1] &#34;2023-01-09 00:00:00 AAPL 250000 @ 130.149993896484&#34;
## [1] &#34;2023-02-22 00:00:00 AAPL -1250000 @ 148.910003662109&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: 15.9522 | 总收益: 1.24184050378993e+23 | 最大回撤: 1530.7447 | 交易次数: 25 | 胜率: 1
## 测试参数组合 25/64: n=6, m1=4, m2=3
## 策略环境已重置
## [1] &#34;2022-09-09 00:00:00 AAPL 250000 @ 157.369995117188&#34;
## [1] &#34;2022-11-01 00:00:00 AAPL -250000 @ 150.649993896484&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: -0.3884 | 总收益: -0.9997 | 最大回撤: 2.9111 | 交易次数: 3 | 胜率: 0
## 测试参数组合 26/64: n=18, m1=4, m2=3
## 策略环境已重置
## [1] &#34;2018-11-29 00:00:00 AAPL 250000 @ 44.8875007629395&#34;
## [1] &#34;2018-12-13 00:00:00 AAPL 250000 @ 42.7374992370605&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-02-11 00:00:00 AAPL -750000 @ 42.3574981689453&#34;
## [1] &#34;2019-06-05 00:00:00 AAPL 250000 @ 45.6349983215332&#34;
## [1] &#34;2019-07-01 00:00:00 AAPL -250000 @ 50.3875007629395&#34;
## [1] &#34;2020-03-25 00:00:00 AAPL 250000 @ 61.3800010681152&#34;
## [1] &#34;2020-04-22 00:00:00 AAPL -250000 @ 69.0250015258789&#34;
## [1] &#34;2020-09-28 00:00:00 AAPL 250000 @ 114.959999084473&#34;
## [1] &#34;2020-10-20 00:00:00 AAPL -250000 @ 117.51000213623&#34;
## [1] &#34;2021-10-07 00:00:00 AAPL 250000 @ 143.289993286133&#34;
## [1] &#34;2021-11-02 00:00:00 AAPL -250000 @ 150.020004272461&#34;
## [1] &#34;2022-05-24 00:00:00 AAPL 250000 @ 140.360000610352&#34;
## [1] &#34;2022-07-27 00:00:00 AAPL -250000 @ 156.789993286133&#34;
## [1] &#34;2022-09-20 00:00:00 AAPL 250000 @ 156.899993896484&#34;
## [1] &#34;2022-10-05 00:00:00 AAPL 250000 @ 146.399993896484&#34;
## [1] &#34;2022-10-14 00:00:00 AAPL 250000 @ 138.380004882812&#34;
## [1] &#34;2023-01-09 00:00:00 AAPL 250000 @ 130.149993896484&#34;
## [1] &#34;2023-02-07 00:00:00 AAPL -1e+06 @ 154.649993896484&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: -0.073 | 总收益: 19654821.038 | 最大回撤: 283.8463 | 交易次数: 20 | 胜率: 1
## 测试参数组合 27/64: n=36, m1=4, m2=3
## 策略环境已重置
## [1] &#34;2018-11-29 00:00:00 AAPL 250000 @ 44.8875007629395&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-01-08 00:00:00 AAPL 250000 @ 37.6875&#34;
## [1] &#34;2019-03-07 00:00:00 AAPL -750000 @ 43.125&#34;
## [1] &#34;2019-06-05 00:00:00 AAPL 250000 @ 45.6349983215332&#34;
## [1] &#34;2019-07-29 00:00:00 AAPL -250000 @ 52.4199981689453&#34;
## [1] &#34;2020-03-25 00:00:00 AAPL 250000 @ 61.3800010681152&#34;
## [1] &#34;2020-05-14 00:00:00 AAPL -250000 @ 77.3850021362305&#34;
## [1] &#34;2021-03-15 00:00:00 AAPL 250000 @ 123.98999786377&#34;
## [1] &#34;2021-04-30 00:00:00 AAPL -250000 @ 131.460006713867&#34;
## [1] &#34;2021-10-08 00:00:00 AAPL 250000 @ 142.899993896484&#34;
## [1] &#34;2021-11-12 00:00:00 AAPL -250000 @ 149.990005493164&#34;
## [1] &#34;2022-05-18 00:00:00 AAPL 250000 @ 140.820007324219&#34;
## [1] &#34;2022-05-24 00:00:00 AAPL 250000 @ 140.360000610352&#34;
## [1] &#34;2022-06-24 00:00:00 AAPL 250000 @ 141.660003662109&#34;
## [1] &#34;2022-08-10 00:00:00 AAPL -750000 @ 169.240005493164&#34;
## [1] &#34;2022-10-05 00:00:00 AAPL 250000 @ 146.399993896484&#34;
## [1] &#34;2022-10-14 00:00:00 AAPL 250000 @ 138.380004882812&#34;
## [1] &#34;2023-01-09 00:00:00 AAPL 250000 @ 130.149993896484&#34;
## [1] &#34;2023-02-22 00:00:00 AAPL -750000 @ 148.910003662109&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: -0.0957 | 总收益: 71537.7174 | 最大回撤: 77.341 | 交易次数: 21 | 胜率: 1
## 测试参数组合 28/64: n=55, m1=4, m2=3
## 策略环境已重置
## [1] &#34;2018-11-29 00:00:00 AAPL 250000 @ 44.8875007629395&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-01-09 00:00:00 AAPL 250000 @ 38.3274993896484&#34;
## [1] &#34;2019-03-25 00:00:00 AAPL -750000 @ 47.185001373291&#34;
## [1] &#34;2019-06-06 00:00:00 AAPL 250000 @ 46.3050003051758&#34;
## [1] &#34;2019-08-02 00:00:00 AAPL -250000 @ 51.0050010681152&#34;
## [1] &#34;2020-03-26 00:00:00 AAPL 250000 @ 64.6100006103516&#34;
## [1] &#34;2020-06-12 00:00:00 AAPL -250000 @ 84.6999969482422&#34;
## [1] &#34;2021-03-16 00:00:00 AAPL 250000 @ 125.569999694824&#34;
## [1] &#34;2021-04-05 00:00:00 AAPL 250000 @ 125.900001525879&#34;
## [1] &#34;2021-05-05 00:00:00 AAPL -5e+05 @ 128.100006103516&#34;
## [1] &#34;2021-10-08 00:00:00 AAPL 250000 @ 142.899993896484&#34;
## [1] &#34;2021-12-06 00:00:00 AAPL -250000 @ 165.320007324219&#34;
## [1] &#34;2022-05-25 00:00:00 AAPL 250000 @ 140.520004272461&#34;
## [1] &#34;2022-06-24 00:00:00 AAPL 250000 @ 141.660003662109&#34;
## [1] &#34;2022-08-22 00:00:00 AAPL -5e+05 @ 167.570007324219&#34;
## [1] &#34;2022-10-18 00:00:00 AAPL 250000 @ 143.75&#34;
## [1] &#34;2023-01-09 00:00:00 AAPL 250000 @ 130.149993896484&#34;
## [1] &#34;2023-02-22 00:00:00 AAPL -5e+05 @ 148.910003662109&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: NaN | 总收益: -1 | 最大回撤: 13.259 | 交易次数: 20 | 胜率: 1
## 测试参数组合 29/64: n=6, m1=5, m2=3
## 策略环境已重置
## ❌ 策略执行失败 | 参数组合 29 | 错误: 输入必须是tradeStats函数的输出数据框
## 测试参数组合 30/64: n=18, m1=5, m2=3
## 策略环境已重置
## [1] &#34;2018-11-29 00:00:00 AAPL 250000 @ 44.8875007629395&#34;
## [1] &#34;2018-12-13 00:00:00 AAPL 250000 @ 42.7374992370605&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-02-12 00:00:00 AAPL -750000 @ 42.7224998474121&#34;
## [1] &#34;2019-06-05 00:00:00 AAPL 250000 @ 45.6349983215332&#34;
## [1] &#34;2019-07-09 00:00:00 AAPL -250000 @ 50.310001373291&#34;
## [1] &#34;2022-05-24 00:00:00 AAPL 250000 @ 140.360000610352&#34;
## [1] &#34;2022-07-27 00:00:00 AAPL -250000 @ 156.789993286133&#34;
## [1] &#34;2022-10-05 00:00:00 AAPL 250000 @ 146.399993896484&#34;
## [1] &#34;2022-10-14 00:00:00 AAPL 250000 @ 138.380004882812&#34;
## [1] &#34;2023-01-09 00:00:00 AAPL 250000 @ 130.149993896484&#34;
## [1] &#34;2023-02-09 00:00:00 AAPL -750000 @ 150.869995117188&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: -0.1318 | 总收益: -0.6638 | 最大回撤: 2.0731 | 交易次数: 13 | 胜率: 1
## 测试参数组合 31/64: n=36, m1=5, m2=3
## 策略环境已重置
## [1] &#34;2018-11-29 00:00:00 AAPL 250000 @ 44.8875007629395&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-03-08 00:00:00 AAPL -5e+05 @ 43.2275009155273&#34;
## [1] &#34;2019-06-06 00:00:00 AAPL 250000 @ 46.3050003051758&#34;
## [1] &#34;2019-07-31 00:00:00 AAPL -250000 @ 53.2599983215332&#34;
## [1] &#34;2020-03-26 00:00:00 AAPL 250000 @ 64.6100006103516&#34;
## [1] &#34;2020-05-15 00:00:00 AAPL -250000 @ 76.9274978637695&#34;
## [1] &#34;2021-03-16 00:00:00 AAPL 250000 @ 125.569999694824&#34;
## [1] &#34;2021-04-30 00:00:00 AAPL -250000 @ 131.460006713867&#34;
## [1] &#34;2021-10-08 00:00:00 AAPL 250000 @ 142.899993896484&#34;
## [1] &#34;2021-11-12 00:00:00 AAPL -250000 @ 149.990005493164&#34;
## [1] &#34;2022-05-25 00:00:00 AAPL 250000 @ 140.520004272461&#34;
## [1] &#34;2022-06-24 00:00:00 AAPL 250000 @ 141.660003662109&#34;
## [1] &#34;2022-08-22 00:00:00 AAPL -5e+05 @ 167.570007324219&#34;
## [1] &#34;2022-10-06 00:00:00 AAPL 250000 @ 145.429992675781&#34;
## [1] &#34;2022-10-14 00:00:00 AAPL 250000 @ 138.380004882812&#34;
## [1] &#34;2022-10-18 00:00:00 AAPL 250000 @ 143.75&#34;
## [1] &#34;2023-01-10 00:00:00 AAPL 250000 @ 130.729995727539&#34;
## [1] &#34;2023-02-22 00:00:00 AAPL -1e+06 @ 148.910003662109&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: NaN | 总收益: -394550425625.057 | 最大回撤: 283.8463 | 交易次数: 20 | 胜率: 1
## 测试参数组合 32/64: n=55, m1=5, m2=3
## 策略环境已重置
## [1] &#34;2018-11-29 00:00:00 AAPL 250000 @ 44.8875007629395&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-01-09 00:00:00 AAPL 250000 @ 38.3274993896484&#34;
## [1] &#34;2019-03-25 00:00:00 AAPL -750000 @ 47.185001373291&#34;
## [1] &#34;2020-03-26 00:00:00 AAPL 250000 @ 64.6100006103516&#34;
## [1] &#34;2020-06-12 00:00:00 AAPL -250000 @ 84.6999969482422&#34;
## [1] &#34;2021-03-16 00:00:00 AAPL 250000 @ 125.569999694824&#34;
## [1] &#34;2021-04-05 00:00:00 AAPL 250000 @ 125.900001525879&#34;
## [1] &#34;2021-05-05 00:00:00 AAPL -5e+05 @ 128.100006103516&#34;
## [1] &#34;2022-05-27 00:00:00 AAPL 250000 @ 149.639999389648&#34;
## [1] &#34;2022-06-27 00:00:00 AAPL 250000 @ 141.660003662109&#34;
## [1] &#34;2022-08-22 00:00:00 AAPL -5e+05 @ 167.570007324219&#34;
## [1] &#34;2022-10-19 00:00:00 AAPL 250000 @ 143.860000610352&#34;
## [1] &#34;2023-01-10 00:00:00 AAPL 250000 @ 130.729995727539&#34;
## [1] &#34;2023-02-22 00:00:00 AAPL -5e+05 @ 148.910003662109&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: -0.1586 | 总收益: -1 | 最大回撤: 8.6726 | 交易次数: 16 | 胜率: 1
## 测试参数组合 33/64: n=6, m1=2, m2=4
## 策略环境已重置
## [1] &#34;2018-11-28 00:00:00 AAPL 250000 @ 45.2350006103516&#34;
## [1] &#34;2019-02-08 00:00:00 AAPL -250000 @ 42.6025009155273&#34;
## [1] &#34;2019-06-04 00:00:00 AAPL 250000 @ 44.9099998474121&#34;
## [1] &#34;2019-06-17 00:00:00 AAPL -250000 @ 48.4724998474121&#34;
## [1] &#34;2022-09-08 00:00:00 AAPL 250000 @ 154.460006713867&#34;
## [1] &#34;2023-01-31 00:00:00 AAPL -250000 @ 144.289993286133&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: NaN | 总收益: -1 | 最大回撤: 1.0966 | 交易次数: 7 | 胜率: 0.33
## 测试参数组合 34/64: n=18, m1=2, m2=4
## 策略环境已重置
## [1] &#34;2018-11-29 00:00:00 AAPL 250000 @ 44.8875007629395&#34;
## [1] &#34;2018-12-13 00:00:00 AAPL 250000 @ 42.7374992370605&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-02-08 00:00:00 AAPL -750000 @ 42.6025009155273&#34;
## [1] &#34;2019-06-05 00:00:00 AAPL 250000 @ 45.6349983215332&#34;
## [1] &#34;2019-06-26 00:00:00 AAPL -250000 @ 49.9500007629395&#34;
## [1] &#34;2020-09-23 00:00:00 AAPL 250000 @ 107.120002746582&#34;
## [1] &#34;2020-10-19 00:00:00 AAPL -250000 @ 115.980003356934&#34;
## [1] &#34;2022-05-03 00:00:00 AAPL 250000 @ 159.479995727539&#34;
## [1] &#34;2022-05-16 00:00:00 AAPL 250000 @ 145.539993286133&#34;
## [1] &#34;2022-07-26 00:00:00 AAPL -5e+05 @ 151.600006103516&#34;
## [1] &#34;2022-09-20 00:00:00 AAPL 250000 @ 156.899993896484&#34;
## [1] &#34;2022-12-22 00:00:00 AAPL 250000 @ 132.229995727539&#34;
## [1] &#34;2023-01-03 00:00:00 AAPL 250000 @ 125.069999694824&#34;
## [1] &#34;2023-01-09 00:00:00 AAPL 250000 @ 130.149993896484&#34;
## [1] &#34;2023-02-07 00:00:00 AAPL -1e+06 @ 154.649993896484&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: NaN | 总收益: -0.9996 | 最大回撤: 3.1034 | 交易次数: 17 | 胜率: 0.8
## 测试参数组合 35/64: n=36, m1=2, m2=4
## 策略环境已重置
## [1] &#34;2018-11-29 00:00:00 AAPL 250000 @ 44.8875007629395&#34;
## [1] &#34;2018-12-14 00:00:00 AAPL 250000 @ 41.3699989318848&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-01-09 00:00:00 AAPL 250000 @ 38.3274993896484&#34;
## [1] &#34;2019-03-07 00:00:00 AAPL -1e+06 @ 43.125&#34;
## [1] &#34;2019-06-05 00:00:00 AAPL 250000 @ 45.6349983215332&#34;
## [1] &#34;2019-07-22 00:00:00 AAPL -250000 @ 51.8050003051758&#34;
## [1] &#34;2020-03-25 00:00:00 AAPL 250000 @ 61.3800010681152&#34;
## [1] &#34;2020-05-14 00:00:00 AAPL -250000 @ 77.3850021362305&#34;
## [1] &#34;2021-03-12 00:00:00 AAPL 250000 @ 121.029998779297&#34;
## [1] &#34;2021-04-23 00:00:00 AAPL -250000 @ 134.320007324219&#34;
## [1] &#34;2021-10-07 00:00:00 AAPL 250000 @ 143.289993286133&#34;
## [1] &#34;2021-11-11 00:00:00 AAPL -250000 @ 147.869995117188&#34;
## [1] &#34;2022-05-24 00:00:00 AAPL 250000 @ 140.360000610352&#34;
## [1] &#34;2022-06-23 00:00:00 AAPL 250000 @ 138.270004272461&#34;
## [1] &#34;2022-07-27 00:00:00 AAPL -5e+05 @ 156.789993286133&#34;
## [1] &#34;2022-10-05 00:00:00 AAPL 250000 @ 146.399993896484&#34;
## [1] &#34;2022-10-14 00:00:00 AAPL 250000 @ 138.380004882812&#34;
## [1] &#34;2023-01-03 00:00:00 AAPL 250000 @ 125.069999694824&#34;
## [1] &#34;2023-01-09 00:00:00 AAPL 250000 @ 130.149993896484&#34;
## [1] &#34;2023-02-10 00:00:00 AAPL -1e+06 @ 151.009994506836&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: -0.1125 | 总收益: -0.8153 | 最大回撤: 2.6909 | 交易次数: 22 | 胜率: 1
## 测试参数组合 36/64: n=55, m1=2, m2=4
## 策略环境已重置
## [1] &#34;2018-11-29 00:00:00 AAPL 250000 @ 44.8875007629395&#34;
## [1] &#34;2018-12-14 00:00:00 AAPL 250000 @ 41.3699989318848&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-01-09 00:00:00 AAPL 250000 @ 38.3274993896484&#34;
## [1] &#34;2019-03-08 00:00:00 AAPL -1e+06 @ 43.2275009155273&#34;
## [1] &#34;2020-03-25 00:00:00 AAPL 250000 @ 61.3800010681152&#34;
## [1] &#34;2020-06-12 00:00:00 AAPL -250000 @ 84.6999969482422&#34;
## [1] &#34;2021-03-12 00:00:00 AAPL 250000 @ 121.029998779297&#34;
## [1] &#34;2021-04-01 00:00:00 AAPL 250000 @ 123&#34;
## [1] &#34;2021-05-03 00:00:00 AAPL -5e+05 @ 132.539993286133&#34;
## [1] &#34;2022-05-24 00:00:00 AAPL 250000 @ 140.360000610352&#34;
## [1] &#34;2022-06-23 00:00:00 AAPL 250000 @ 138.270004272461&#34;
## [1] &#34;2022-08-19 00:00:00 AAPL -5e+05 @ 171.520004272461&#34;
## [1] &#34;2022-10-06 00:00:00 AAPL 250000 @ 145.429992675781&#34;
## [1] &#34;2022-10-14 00:00:00 AAPL 250000 @ 138.380004882812&#34;
## [1] &#34;2022-10-18 00:00:00 AAPL 250000 @ 143.75&#34;
## [1] &#34;2023-01-03 00:00:00 AAPL 250000 @ 125.069999694824&#34;
## [1] &#34;2023-01-09 00:00:00 AAPL 250000 @ 130.149993896484&#34;
## [1] &#34;2023-02-22 00:00:00 AAPL -1250000 @ 148.910003662109&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: NaN | 总收益: -652899478681.471 | 最大回撤: 731.8759 | 交易次数: 20 | 胜率: 1
## 测试参数组合 37/64: n=6, m1=3, m2=4
## 策略环境已重置
## [1] &#34;2022-09-09 00:00:00 AAPL 250000 @ 157.369995117188&#34;
## [1] &#34;2022-11-01 00:00:00 AAPL -250000 @ 150.649993896484&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: -0.3884 | 总收益: -0.9997 | 最大回撤: 2.9111 | 交易次数: 3 | 胜率: 0
## 测试参数组合 38/64: n=18, m1=3, m2=4
## 策略环境已重置
## [1] &#34;2018-11-29 00:00:00 AAPL 250000 @ 44.8875007629395&#34;
## [1] &#34;2018-12-13 00:00:00 AAPL 250000 @ 42.7374992370605&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-02-11 00:00:00 AAPL -750000 @ 42.3574981689453&#34;
## [1] &#34;2019-06-05 00:00:00 AAPL 250000 @ 45.6349983215332&#34;
## [1] &#34;2019-07-01 00:00:00 AAPL -250000 @ 50.3875007629395&#34;
## [1] &#34;2020-09-28 00:00:00 AAPL 250000 @ 114.959999084473&#34;
## [1] &#34;2020-12-11 00:00:00 AAPL -250000 @ 122.410003662109&#34;
## [1] &#34;2021-10-07 00:00:00 AAPL 250000 @ 143.289993286133&#34;
## [1] &#34;2021-11-02 00:00:00 AAPL -250000 @ 150.020004272461&#34;
## [1] &#34;2022-05-24 00:00:00 AAPL 250000 @ 140.360000610352&#34;
## [1] &#34;2022-07-27 00:00:00 AAPL -250000 @ 156.789993286133&#34;
## [1] &#34;2022-09-20 00:00:00 AAPL 250000 @ 156.899993896484&#34;
## [1] &#34;2022-10-05 00:00:00 AAPL 250000 @ 146.399993896484&#34;
## [1] &#34;2022-10-14 00:00:00 AAPL 250000 @ 138.380004882812&#34;
## [1] &#34;2023-01-09 00:00:00 AAPL 250000 @ 130.149993896484&#34;
## [1] &#34;2023-02-07 00:00:00 AAPL -1e+06 @ 154.649993896484&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: -0.0737 | 总收益: 13116774.6652 | 最大回撤: 283.8463 | 交易次数: 18 | 胜率: 1
## 测试参数组合 39/64: n=36, m1=3, m2=4
## 策略环境已重置
## [1] &#34;2018-11-29 00:00:00 AAPL 250000 @ 44.8875007629395&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-01-08 00:00:00 AAPL 250000 @ 37.6875&#34;
## [1] &#34;2019-03-07 00:00:00 AAPL -750000 @ 43.125&#34;
## [1] &#34;2019-06-05 00:00:00 AAPL 250000 @ 45.6349983215332&#34;
## [1] &#34;2019-07-29 00:00:00 AAPL -250000 @ 52.4199981689453&#34;
## [1] &#34;2020-03-25 00:00:00 AAPL 250000 @ 61.3800010681152&#34;
## [1] &#34;2020-05-14 00:00:00 AAPL -250000 @ 77.3850021362305&#34;
## [1] &#34;2021-03-15 00:00:00 AAPL 250000 @ 123.98999786377&#34;
## [1] &#34;2021-04-30 00:00:00 AAPL -250000 @ 131.460006713867&#34;
## [1] &#34;2021-10-08 00:00:00 AAPL 250000 @ 142.899993896484&#34;
## [1] &#34;2021-11-12 00:00:00 AAPL -250000 @ 149.990005493164&#34;
## [1] &#34;2022-05-18 00:00:00 AAPL 250000 @ 140.820007324219&#34;
## [1] &#34;2022-05-24 00:00:00 AAPL 250000 @ 140.360000610352&#34;
## [1] &#34;2022-06-24 00:00:00 AAPL 250000 @ 141.660003662109&#34;
## [1] &#34;2022-08-10 00:00:00 AAPL -750000 @ 169.240005493164&#34;
## [1] &#34;2022-10-05 00:00:00 AAPL 250000 @ 146.399993896484&#34;
## [1] &#34;2022-10-14 00:00:00 AAPL 250000 @ 138.380004882812&#34;
## [1] &#34;2023-01-09 00:00:00 AAPL 250000 @ 130.149993896484&#34;
## [1] &#34;2023-02-22 00:00:00 AAPL -750000 @ 148.910003662109&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: -0.0957 | 总收益: 71537.7174 | 最大回撤: 77.341 | 交易次数: 21 | 胜率: 1
## 测试参数组合 40/64: n=55, m1=3, m2=4
## 策略环境已重置
## [1] &#34;2018-11-29 00:00:00 AAPL 250000 @ 44.8875007629395&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-01-09 00:00:00 AAPL 250000 @ 38.3274993896484&#34;
## [1] &#34;2019-03-25 00:00:00 AAPL -750000 @ 47.185001373291&#34;
## [1] &#34;2019-06-06 00:00:00 AAPL 250000 @ 46.3050003051758&#34;
## [1] &#34;2019-08-02 00:00:00 AAPL -250000 @ 51.0050010681152&#34;
## [1] &#34;2021-03-16 00:00:00 AAPL 250000 @ 125.569999694824&#34;
## [1] &#34;2021-04-05 00:00:00 AAPL 250000 @ 125.900001525879&#34;
## [1] &#34;2021-05-05 00:00:00 AAPL -5e+05 @ 128.100006103516&#34;
## [1] &#34;2021-10-08 00:00:00 AAPL 250000 @ 142.899993896484&#34;
## [1] &#34;2021-12-06 00:00:00 AAPL -250000 @ 165.320007324219&#34;
## [1] &#34;2022-05-25 00:00:00 AAPL 250000 @ 140.520004272461&#34;
## [1] &#34;2022-06-24 00:00:00 AAPL 250000 @ 141.660003662109&#34;
## [1] &#34;2022-08-22 00:00:00 AAPL -5e+05 @ 167.570007324219&#34;
## [1] &#34;2022-10-18 00:00:00 AAPL 250000 @ 143.75&#34;
## [1] &#34;2023-01-09 00:00:00 AAPL 250000 @ 130.149993896484&#34;
## [1] &#34;2023-02-22 00:00:00 AAPL -5e+05 @ 148.910003662109&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: -0.1566 | 总收益: -1 | 最大回撤: 8.6726 | 交易次数: 18 | 胜率: 1
## 测试参数组合 41/64: n=6, m1=4, m2=4
## 策略环境已重置
## ❌ 策略执行失败 | 参数组合 41 | 错误: 输入必须是tradeStats函数的输出数据框
## 测试参数组合 42/64: n=18, m1=4, m2=4
## 策略环境已重置
## [1] &#34;2018-11-29 00:00:00 AAPL 250000 @ 44.8875007629395&#34;
## [1] &#34;2018-12-13 00:00:00 AAPL 250000 @ 42.7374992370605&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-02-12 00:00:00 AAPL -750000 @ 42.7224998474121&#34;
## [1] &#34;2019-06-05 00:00:00 AAPL 250000 @ 45.6349983215332&#34;
## [1] &#34;2019-07-09 00:00:00 AAPL -250000 @ 50.310001373291&#34;
## [1] &#34;2022-05-24 00:00:00 AAPL 250000 @ 140.360000610352&#34;
## [1] &#34;2022-07-27 00:00:00 AAPL -250000 @ 156.789993286133&#34;
## [1] &#34;2022-10-05 00:00:00 AAPL 250000 @ 146.399993896484&#34;
## [1] &#34;2022-10-14 00:00:00 AAPL 250000 @ 138.380004882812&#34;
## [1] &#34;2023-01-09 00:00:00 AAPL 250000 @ 130.149993896484&#34;
## [1] &#34;2023-02-09 00:00:00 AAPL -750000 @ 150.869995117188&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: -0.1318 | 总收益: -0.6638 | 最大回撤: 2.0731 | 交易次数: 13 | 胜率: 1
## 测试参数组合 43/64: n=36, m1=4, m2=4
## 策略环境已重置
## [1] &#34;2018-11-29 00:00:00 AAPL 250000 @ 44.8875007629395&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-03-08 00:00:00 AAPL -5e+05 @ 43.2275009155273&#34;
## [1] &#34;2019-06-06 00:00:00 AAPL 250000 @ 46.3050003051758&#34;
## [1] &#34;2019-07-31 00:00:00 AAPL -250000 @ 53.2599983215332&#34;
## [1] &#34;2020-03-26 00:00:00 AAPL 250000 @ 64.6100006103516&#34;
## [1] &#34;2020-05-15 00:00:00 AAPL -250000 @ 76.9274978637695&#34;
## [1] &#34;2021-03-16 00:00:00 AAPL 250000 @ 125.569999694824&#34;
## [1] &#34;2021-04-30 00:00:00 AAPL -250000 @ 131.460006713867&#34;
## [1] &#34;2021-10-11 00:00:00 AAPL 250000 @ 142.809997558594&#34;
## [1] &#34;2021-11-12 00:00:00 AAPL -250000 @ 149.990005493164&#34;
## [1] &#34;2022-05-25 00:00:00 AAPL 250000 @ 140.520004272461&#34;
## [1] &#34;2022-06-24 00:00:00 AAPL 250000 @ 141.660003662109&#34;
## [1] &#34;2022-08-22 00:00:00 AAPL -5e+05 @ 167.570007324219&#34;
## [1] &#34;2022-10-06 00:00:00 AAPL 250000 @ 145.429992675781&#34;
## [1] &#34;2022-10-14 00:00:00 AAPL 250000 @ 138.380004882812&#34;
## [1] &#34;2022-10-18 00:00:00 AAPL 250000 @ 143.75&#34;
## [1] &#34;2023-01-10 00:00:00 AAPL 250000 @ 130.729995727539&#34;
## [1] &#34;2023-02-22 00:00:00 AAPL -1e+06 @ 148.910003662109&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: NaN | 总收益: -403631770935.152 | 最大回撤: 283.8463 | 交易次数: 20 | 胜率: 1
## 测试参数组合 44/64: n=55, m1=4, m2=4
## 策略环境已重置
## [1] &#34;2018-11-29 00:00:00 AAPL 250000 @ 44.8875007629395&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-01-09 00:00:00 AAPL 250000 @ 38.3274993896484&#34;
## [1] &#34;2019-03-25 00:00:00 AAPL -750000 @ 47.185001373291&#34;
## [1] &#34;2020-03-26 00:00:00 AAPL 250000 @ 64.6100006103516&#34;
## [1] &#34;2020-06-12 00:00:00 AAPL -250000 @ 84.6999969482422&#34;
## [1] &#34;2021-03-16 00:00:00 AAPL 250000 @ 125.569999694824&#34;
## [1] &#34;2021-04-05 00:00:00 AAPL 250000 @ 125.900001525879&#34;
## [1] &#34;2021-05-05 00:00:00 AAPL -5e+05 @ 128.100006103516&#34;
## [1] &#34;2022-05-27 00:00:00 AAPL 250000 @ 149.639999389648&#34;
## [1] &#34;2022-06-27 00:00:00 AAPL 250000 @ 141.660003662109&#34;
## [1] &#34;2022-08-22 00:00:00 AAPL -5e+05 @ 167.570007324219&#34;
## [1] &#34;2022-10-19 00:00:00 AAPL 250000 @ 143.860000610352&#34;
## [1] &#34;2023-01-10 00:00:00 AAPL 250000 @ 130.729995727539&#34;
## [1] &#34;2023-02-22 00:00:00 AAPL -5e+05 @ 148.910003662109&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: -0.1586 | 总收益: -1 | 最大回撤: 8.6726 | 交易次数: 16 | 胜率: 1
## 测试参数组合 45/64: n=6, m1=5, m2=4
## 策略环境已重置
## ❌ 策略执行失败 | 参数组合 45 | 错误: 输入必须是tradeStats函数的输出数据框
## 测试参数组合 46/64: n=18, m1=5, m2=4
## 策略环境已重置
## [1] &#34;2018-11-30 00:00:00 AAPL 250000 @ 44.6450004577637&#34;
## [1] &#34;2018-12-13 00:00:00 AAPL 250000 @ 42.7374992370605&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-02-13 00:00:00 AAPL -750000 @ 42.5449981689453&#34;
## [1] &#34;2019-06-05 00:00:00 AAPL 250000 @ 45.6349983215332&#34;
## [1] &#34;2019-07-09 00:00:00 AAPL -250000 @ 50.310001373291&#34;
## [1] &#34;2022-05-24 00:00:00 AAPL 250000 @ 140.360000610352&#34;
## [1] &#34;2022-08-10 00:00:00 AAPL -250000 @ 169.240005493164&#34;
## [1] &#34;2022-10-05 00:00:00 AAPL 250000 @ 146.399993896484&#34;
## [1] &#34;2022-10-14 00:00:00 AAPL 250000 @ 138.380004882812&#34;
## [1] &#34;2023-01-10 00:00:00 AAPL 250000 @ 130.729995727539&#34;
## [1] &#34;2023-02-10 00:00:00 AAPL -750000 @ 151.009994506836&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: -0.1304 | 总收益: 0.4396 | 最大回撤: 2.8766 | 交易次数: 13 | 胜率: 1
## 测试参数组合 47/64: n=36, m1=5, m2=4
## 策略环境已重置
## [1] &#34;2018-11-30 00:00:00 AAPL 250000 @ 44.6450004577637&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-03-08 00:00:00 AAPL -5e+05 @ 43.2275009155273&#34;
## [1] &#34;2019-06-06 00:00:00 AAPL 250000 @ 46.3050003051758&#34;
## [1] &#34;2019-07-31 00:00:00 AAPL -250000 @ 53.2599983215332&#34;
## [1] &#34;2021-03-16 00:00:00 AAPL 250000 @ 125.569999694824&#34;
## [1] &#34;2021-05-03 00:00:00 AAPL -250000 @ 132.539993286133&#34;
## [1] &#34;2022-05-27 00:00:00 AAPL 250000 @ 149.639999389648&#34;
## [1] &#34;2022-08-22 00:00:00 AAPL -250000 @ 167.570007324219&#34;
## [1] &#34;2022-10-06 00:00:00 AAPL 250000 @ 145.429992675781&#34;
## [1] &#34;2022-10-18 00:00:00 AAPL 250000 @ 143.75&#34;
## [1] &#34;2023-01-10 00:00:00 AAPL 250000 @ 130.729995727539&#34;
## [1] &#34;2023-02-22 00:00:00 AAPL -750000 @ 148.910003662109&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: -0.1293 | 总收益: -1.0006 | 最大回撤: 3.6896 | 交易次数: 14 | 胜率: 1
## 测试参数组合 48/64: n=55, m1=5, m2=4
## 策略环境已重置
## [1] &#34;2018-11-30 00:00:00 AAPL 250000 @ 44.6450004577637&#34;
## [1] &#34;2018-12-28 00:00:00 AAPL 250000 @ 39.0574989318848&#34;
## [1] &#34;2019-03-26 00:00:00 AAPL -5e+05 @ 46.6974983215332&#34;
## [1] &#34;2021-04-05 00:00:00 AAPL 250000 @ 125.900001525879&#34;
## [1] &#34;2021-05-05 00:00:00 AAPL -250000 @ 128.100006103516&#34;
## [1] &#34;2022-05-27 00:00:00 AAPL 250000 @ 149.639999389648&#34;
## [1] &#34;2022-06-27 00:00:00 AAPL 250000 @ 141.660003662109&#34;
## [1] &#34;2022-08-23 00:00:00 AAPL -5e+05 @ 167.229995727539&#34;
## [1] &#34;2022-10-19 00:00:00 AAPL 250000 @ 143.860000610352&#34;
## [1] &#34;2023-01-10 00:00:00 AAPL 250000 @ 130.729995727539&#34;
## [1] &#34;2023-02-23 00:00:00 AAPL -5e+05 @ 149.399993896484&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: -0.1732 | 总收益: -1 | 最大回撤: 9.2317 | 交易次数: 12 | 胜率: 1
## 测试参数组合 49/64: n=6, m1=2, m2=5
## 策略环境已重置
## [1] &#34;2018-11-28 00:00:00 AAPL 250000 @ 45.2350006103516&#34;
## [1] &#34;2019-02-08 00:00:00 AAPL -250000 @ 42.6025009155273&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: NaN | 总收益: -0.9937 | 最大回撤: 0.9986 | 交易次数: 3 | 胜率: 0
## 测试参数组合 50/64: n=18, m1=2, m2=5
## 策略环境已重置
## [1] &#34;2018-11-29 00:00:00 AAPL 250000 @ 44.8875007629395&#34;
## [1] &#34;2018-12-13 00:00:00 AAPL 250000 @ 42.7374992370605&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-02-11 00:00:00 AAPL -750000 @ 42.3574981689453&#34;
## [1] &#34;2019-06-05 00:00:00 AAPL 250000 @ 45.6349983215332&#34;
## [1] &#34;2019-07-01 00:00:00 AAPL -250000 @ 50.3875007629395&#34;
## [1] &#34;2022-05-17 00:00:00 AAPL 250000 @ 149.240005493164&#34;
## [1] &#34;2022-07-27 00:00:00 AAPL -250000 @ 156.789993286133&#34;
## [1] &#34;2022-09-20 00:00:00 AAPL 250000 @ 156.899993896484&#34;
## [1] &#34;2023-01-03 00:00:00 AAPL 250000 @ 125.069999694824&#34;
## [1] &#34;2023-01-09 00:00:00 AAPL 250000 @ 130.149993896484&#34;
## [1] &#34;2023-02-07 00:00:00 AAPL -750000 @ 154.649993896484&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: NaN | 总收益: -1 | 最大回撤: 1.2053 | 交易次数: 13 | 胜率: 1
## 测试参数组合 51/64: n=36, m1=2, m2=5
## 策略环境已重置
## [1] &#34;2018-11-29 00:00:00 AAPL 250000 @ 44.8875007629395&#34;
## [1] &#34;2018-12-14 00:00:00 AAPL 250000 @ 41.3699989318848&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-01-09 00:00:00 AAPL 250000 @ 38.3274993896484&#34;
## [1] &#34;2019-03-07 00:00:00 AAPL -1e+06 @ 43.125&#34;
## [1] &#34;2019-06-05 00:00:00 AAPL 250000 @ 45.6349983215332&#34;
## [1] &#34;2019-07-29 00:00:00 AAPL -250000 @ 52.4199981689453&#34;
## [1] &#34;2020-03-25 00:00:00 AAPL 250000 @ 61.3800010681152&#34;
## [1] &#34;2020-05-14 00:00:00 AAPL -250000 @ 77.3850021362305&#34;
## [1] &#34;2021-03-12 00:00:00 AAPL 250000 @ 121.029998779297&#34;
## [1] &#34;2021-04-30 00:00:00 AAPL -250000 @ 131.460006713867&#34;
## [1] &#34;2022-05-24 00:00:00 AAPL 250000 @ 140.360000610352&#34;
## [1] &#34;2022-06-24 00:00:00 AAPL 250000 @ 141.660003662109&#34;
## [1] &#34;2022-08-10 00:00:00 AAPL -5e+05 @ 169.240005493164&#34;
## [1] &#34;2022-10-05 00:00:00 AAPL 250000 @ 146.399993896484&#34;
## [1] &#34;2022-10-14 00:00:00 AAPL 250000 @ 138.380004882812&#34;
## [1] &#34;2023-01-09 00:00:00 AAPL 250000 @ 130.149993896484&#34;
## [1] &#34;2023-02-22 00:00:00 AAPL -750000 @ 148.910003662109&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: -0.1159 | 总收益: 0.1361 | 最大回撤: 5.4834 | 交易次数: 19 | 胜率: 1
## 测试参数组合 52/64: n=55, m1=2, m2=5
## 策略环境已重置
## [1] &#34;2018-11-29 00:00:00 AAPL 250000 @ 44.8875007629395&#34;
## [1] &#34;2018-12-14 00:00:00 AAPL 250000 @ 41.3699989318848&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-01-09 00:00:00 AAPL 250000 @ 38.3274993896484&#34;
## [1] &#34;2019-03-25 00:00:00 AAPL -1e+06 @ 47.185001373291&#34;
## [1] &#34;2020-03-25 00:00:00 AAPL 250000 @ 61.3800010681152&#34;
## [1] &#34;2020-06-12 00:00:00 AAPL -250000 @ 84.6999969482422&#34;
## [1] &#34;2022-05-24 00:00:00 AAPL 250000 @ 140.360000610352&#34;
## [1] &#34;2022-06-24 00:00:00 AAPL 250000 @ 141.660003662109&#34;
## [1] &#34;2022-08-22 00:00:00 AAPL -5e+05 @ 167.570007324219&#34;
## [1] &#34;2022-10-18 00:00:00 AAPL 250000 @ 143.75&#34;
## [1] &#34;2023-01-09 00:00:00 AAPL 250000 @ 130.149993896484&#34;
## [1] &#34;2023-02-22 00:00:00 AAPL -5e+05 @ 148.910003662109&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: NaN | 总收益: -1 | 最大回撤: 1.8988 | 交易次数: 14 | 胜率: 1
## 测试参数组合 53/64: n=6, m1=3, m2=5
## 策略环境已重置
## ❌ 策略执行失败 | 参数组合 53 | 错误: 输入必须是tradeStats函数的输出数据框
## 测试参数组合 54/64: n=18, m1=3, m2=5
## 策略环境已重置
## [1] &#34;2018-11-29 00:00:00 AAPL 250000 @ 44.8875007629395&#34;
## [1] &#34;2018-12-13 00:00:00 AAPL 250000 @ 42.7374992370605&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-02-12 00:00:00 AAPL -750000 @ 42.7224998474121&#34;
## [1] &#34;2019-06-05 00:00:00 AAPL 250000 @ 45.6349983215332&#34;
## [1] &#34;2019-07-09 00:00:00 AAPL -250000 @ 50.310001373291&#34;
## [1] &#34;2022-05-24 00:00:00 AAPL 250000 @ 140.360000610352&#34;
## [1] &#34;2022-07-27 00:00:00 AAPL -250000 @ 156.789993286133&#34;
## [1] &#34;2022-10-05 00:00:00 AAPL 250000 @ 146.399993896484&#34;
## [1] &#34;2022-10-14 00:00:00 AAPL 250000 @ 138.380004882812&#34;
## [1] &#34;2023-01-09 00:00:00 AAPL 250000 @ 130.149993896484&#34;
## [1] &#34;2023-02-09 00:00:00 AAPL -750000 @ 150.869995117188&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: -0.1318 | 总收益: -0.6638 | 最大回撤: 2.0731 | 交易次数: 13 | 胜率: 1
## 测试参数组合 55/64: n=36, m1=3, m2=5
## 策略环境已重置
## [1] &#34;2018-11-29 00:00:00 AAPL 250000 @ 44.8875007629395&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-03-08 00:00:00 AAPL -5e+05 @ 43.2275009155273&#34;
## [1] &#34;2019-06-06 00:00:00 AAPL 250000 @ 46.3050003051758&#34;
## [1] &#34;2019-07-31 00:00:00 AAPL -250000 @ 53.2599983215332&#34;
## [1] &#34;2021-03-16 00:00:00 AAPL 250000 @ 125.569999694824&#34;
## [1] &#34;2021-04-30 00:00:00 AAPL -250000 @ 131.460006713867&#34;
## [1] &#34;2021-10-08 00:00:00 AAPL 250000 @ 142.899993896484&#34;
## [1] &#34;2021-11-12 00:00:00 AAPL -250000 @ 149.990005493164&#34;
## [1] &#34;2022-05-25 00:00:00 AAPL 250000 @ 140.520004272461&#34;
## [1] &#34;2022-06-24 00:00:00 AAPL 250000 @ 141.660003662109&#34;
## [1] &#34;2022-08-22 00:00:00 AAPL -5e+05 @ 167.570007324219&#34;
## [1] &#34;2022-10-06 00:00:00 AAPL 250000 @ 145.429992675781&#34;
## [1] &#34;2022-10-14 00:00:00 AAPL 250000 @ 138.380004882812&#34;
## [1] &#34;2022-10-18 00:00:00 AAPL 250000 @ 143.75&#34;
## [1] &#34;2023-01-10 00:00:00 AAPL 250000 @ 130.729995727539&#34;
## [1] &#34;2023-02-22 00:00:00 AAPL -1e+06 @ 148.910003662109&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: NaN | 总收益: -611931530531.85 | 最大回撤: 283.8463 | 交易次数: 18 | 胜率: 1
## 测试参数组合 56/64: n=55, m1=3, m2=5
## 策略环境已重置
## [1] &#34;2018-11-29 00:00:00 AAPL 250000 @ 44.8875007629395&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-01-09 00:00:00 AAPL 250000 @ 38.3274993896484&#34;
## [1] &#34;2019-03-25 00:00:00 AAPL -750000 @ 47.185001373291&#34;
## [1] &#34;2021-03-16 00:00:00 AAPL 250000 @ 125.569999694824&#34;
## [1] &#34;2021-04-05 00:00:00 AAPL 250000 @ 125.900001525879&#34;
## [1] &#34;2021-05-05 00:00:00 AAPL -5e+05 @ 128.100006103516&#34;
## [1] &#34;2022-05-27 00:00:00 AAPL 250000 @ 149.639999389648&#34;
## [1] &#34;2022-06-27 00:00:00 AAPL 250000 @ 141.660003662109&#34;
## [1] &#34;2022-08-22 00:00:00 AAPL -5e+05 @ 167.570007324219&#34;
## [1] &#34;2022-10-19 00:00:00 AAPL 250000 @ 143.860000610352&#34;
## [1] &#34;2023-01-10 00:00:00 AAPL 250000 @ 130.729995727539&#34;
## [1] &#34;2023-02-22 00:00:00 AAPL -5e+05 @ 148.910003662109&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: NaN | 总收益: -1 | 最大回撤: 8.6726 | 交易次数: 14 | 胜率: 1
## 测试参数组合 57/64: n=6, m1=4, m2=5
## 策略环境已重置
## ❌ 策略执行失败 | 参数组合 57 | 错误: 输入必须是tradeStats函数的输出数据框
## 测试参数组合 58/64: n=18, m1=4, m2=5
## 策略环境已重置
## [1] &#34;2018-11-30 00:00:00 AAPL 250000 @ 44.6450004577637&#34;
## [1] &#34;2018-12-13 00:00:00 AAPL 250000 @ 42.7374992370605&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-02-13 00:00:00 AAPL -750000 @ 42.5449981689453&#34;
## [1] &#34;2019-06-05 00:00:00 AAPL 250000 @ 45.6349983215332&#34;
## [1] &#34;2019-07-09 00:00:00 AAPL -250000 @ 50.310001373291&#34;
## [1] &#34;2022-05-24 00:00:00 AAPL 250000 @ 140.360000610352&#34;
## [1] &#34;2022-08-10 00:00:00 AAPL -250000 @ 169.240005493164&#34;
## [1] &#34;2022-10-05 00:00:00 AAPL 250000 @ 146.399993896484&#34;
## [1] &#34;2022-10-14 00:00:00 AAPL 250000 @ 138.380004882812&#34;
## [1] &#34;2023-01-10 00:00:00 AAPL 250000 @ 130.729995727539&#34;
## [1] &#34;2023-02-10 00:00:00 AAPL -750000 @ 151.009994506836&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: -0.1304 | 总收益: 0.4396 | 最大回撤: 2.8766 | 交易次数: 13 | 胜率: 1
## 测试参数组合 59/64: n=36, m1=4, m2=5
## 策略环境已重置
## [1] &#34;2018-11-30 00:00:00 AAPL 250000 @ 44.6450004577637&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-03-08 00:00:00 AAPL -5e+05 @ 43.2275009155273&#34;
## [1] &#34;2019-06-06 00:00:00 AAPL 250000 @ 46.3050003051758&#34;
## [1] &#34;2019-07-31 00:00:00 AAPL -250000 @ 53.2599983215332&#34;
## [1] &#34;2021-03-16 00:00:00 AAPL 250000 @ 125.569999694824&#34;
## [1] &#34;2021-05-03 00:00:00 AAPL -250000 @ 132.539993286133&#34;
## [1] &#34;2022-05-27 00:00:00 AAPL 250000 @ 149.639999389648&#34;
## [1] &#34;2022-08-22 00:00:00 AAPL -250000 @ 167.570007324219&#34;
## [1] &#34;2022-10-06 00:00:00 AAPL 250000 @ 145.429992675781&#34;
## [1] &#34;2022-10-18 00:00:00 AAPL 250000 @ 143.75&#34;
## [1] &#34;2023-01-10 00:00:00 AAPL 250000 @ 130.729995727539&#34;
## [1] &#34;2023-02-22 00:00:00 AAPL -750000 @ 148.910003662109&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: -0.1293 | 总收益: -1.0006 | 最大回撤: 3.6896 | 交易次数: 14 | 胜率: 1
## 测试参数组合 60/64: n=55, m1=4, m2=5
## 策略环境已重置
## [1] &#34;2018-11-30 00:00:00 AAPL 250000 @ 44.6450004577637&#34;
## [1] &#34;2018-12-28 00:00:00 AAPL 250000 @ 39.0574989318848&#34;
## [1] &#34;2019-03-26 00:00:00 AAPL -5e+05 @ 46.6974983215332&#34;
## [1] &#34;2021-04-05 00:00:00 AAPL 250000 @ 125.900001525879&#34;
## [1] &#34;2021-05-05 00:00:00 AAPL -250000 @ 128.100006103516&#34;
## [1] &#34;2022-05-27 00:00:00 AAPL 250000 @ 149.639999389648&#34;
## [1] &#34;2022-06-27 00:00:00 AAPL 250000 @ 141.660003662109&#34;
## [1] &#34;2022-08-23 00:00:00 AAPL -5e+05 @ 167.229995727539&#34;
## [1] &#34;2022-10-19 00:00:00 AAPL 250000 @ 143.860000610352&#34;
## [1] &#34;2023-01-10 00:00:00 AAPL 250000 @ 130.729995727539&#34;
## [1] &#34;2023-02-23 00:00:00 AAPL -5e+05 @ 149.399993896484&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: -0.1732 | 总收益: -1 | 最大回撤: 9.2317 | 交易次数: 12 | 胜率: 1
## 测试参数组合 61/64: n=6, m1=5, m2=5
## 策略环境已重置
## ❌ 策略执行失败 | 参数组合 61 | 错误: 输入必须是tradeStats函数的输出数据框
## 测试参数组合 62/64: n=18, m1=5, m2=5
## 策略环境已重置
## [1] &#34;2018-11-30 00:00:00 AAPL 250000 @ 44.6450004577637&#34;
## [1] &#34;2018-12-13 00:00:00 AAPL 250000 @ 42.7374992370605&#34;
## [1] &#34;2018-12-28 00:00:00 AAPL 250000 @ 39.0574989318848&#34;
## [1] &#34;2019-02-15 00:00:00 AAPL -750000 @ 42.6049995422363&#34;
## [1] &#34;2019-06-06 00:00:00 AAPL 250000 @ 46.3050003051758&#34;
## [1] &#34;2019-07-09 00:00:00 AAPL -250000 @ 50.310001373291&#34;
## [1] &#34;2022-05-25 00:00:00 AAPL 250000 @ 140.520004272461&#34;
## [1] &#34;2022-08-10 00:00:00 AAPL -250000 @ 169.240005493164&#34;
## [1] &#34;2022-10-05 00:00:00 AAPL 250000 @ 146.399993896484&#34;
## [1] &#34;2023-01-10 00:00:00 AAPL 250000 @ 130.729995727539&#34;
## [1] &#34;2023-02-10 00:00:00 AAPL -5e+05 @ 151.009994506836&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: NaN | 总收益: -1 | 最大回撤: 1.7904 | 交易次数: 12 | 胜率: 1
## 测试参数组合 63/64: n=36, m1=5, m2=5
## 策略环境已重置
## [1] &#34;2018-11-30 00:00:00 AAPL 250000 @ 44.6450004577637&#34;
## [1] &#34;2018-12-28 00:00:00 AAPL 250000 @ 39.0574989318848&#34;
## [1] &#34;2019-03-08 00:00:00 AAPL -5e+05 @ 43.2275009155273&#34;
## [1] &#34;2019-06-07 00:00:00 AAPL 250000 @ 47.5374984741211&#34;
## [1] &#34;2019-08-01 00:00:00 AAPL -250000 @ 52.1074981689453&#34;
## [1] &#34;2022-05-27 00:00:00 AAPL 250000 @ 149.639999389648&#34;
## [1] &#34;2022-08-22 00:00:00 AAPL -250000 @ 167.570007324219&#34;
## [1] &#34;2022-10-07 00:00:00 AAPL 250000 @ 140.089996337891&#34;
## [1] &#34;2022-10-18 00:00:00 AAPL 250000 @ 143.75&#34;
## [1] &#34;2023-01-11 00:00:00 AAPL 250000 @ 133.490005493164&#34;
## [1] &#34;2023-02-23 00:00:00 AAPL -750000 @ 149.399993896484&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: -0.1314 | 总收益: -1.02 | 最大回撤: 3.0459 | 交易次数: 12 | 胜率: 1
## 测试参数组合 64/64: n=55, m1=5, m2=5
## 策略环境已重置
## [1] &#34;2018-12-04 00:00:00 AAPL 250000 @ 44.1725006103516&#34;
## [1] &#34;2018-12-28 00:00:00 AAPL 250000 @ 39.0574989318848&#34;
## [1] &#34;2019-03-26 00:00:00 AAPL -5e+05 @ 46.6974983215332&#34;
## [1] &#34;2021-04-05 00:00:00 AAPL 250000 @ 125.900001525879&#34;
## [1] &#34;2021-07-20 00:00:00 AAPL -250000 @ 146.149993896484&#34;
## [1] &#34;2022-06-27 00:00:00 AAPL 250000 @ 141.660003662109&#34;
## [1] &#34;2022-08-23 00:00:00 AAPL -250000 @ 167.229995727539&#34;
## [1] &#34;2022-10-20 00:00:00 AAPL 250000 @ 143.389999389648&#34;
## [1] &#34;2023-01-11 00:00:00 AAPL 250000 @ 133.490005493164&#34;
## [1] &#34;2023-02-24 00:00:00 AAPL -5e+05 @ 146.710006713867&#34;
## === 基于tradeStats的胜率计算结果 ===
## ✅ 测试完成 | Sharpe: NaN | 总收益: -1 | 最大回撤: 14.6622 | 交易次数: 11 | 胜率: 1
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#75715e># 输出最佳参数组合</span>
</span></span><span style=display:flex><span>best_params_order <span style=color:#f92672>&lt;-</span> results<span style=color:#a6e22e>[order</span>(<span style=color:#f92672>-</span>results<span style=color:#f92672>$</span>SharpeRatio), ]
</span></span><span style=display:flex><span><span style=color:#a6e22e>print</span>(<span style=color:#e6db74>&#34;=== 最优参数组合 (按夏普比率降序) ===&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;=== 最优参数组合 (按夏普比率降序) ===&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#a6e22e>print</span>(<span style=color:#a6e22e>head</span>(best_params_order, <span style=color:#ae81ff>3</span>))
</span></span></code></pre></div><pre tabindex=0><code>##     n m1 m2 SharpeRatio       Return MaxDrawdown TradeCount WinRate
## 3  36  2  2    41.44119 3.302791e+25   3126.5533         32       1
## 24 55  3  3    15.95223 1.241841e+23   1530.7447         25       1
## 12 55  4  2    14.59218 5.159452e+22    537.8647         26       1
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#75715e># 可视化不同参数的夏普比率</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>library</span>(ggplot2)
</span></span><span style=display:flex><span><span style=color:#a6e22e>ggplot</span>(results, <span style=color:#a6e22e>aes</span>(x <span style=color:#f92672>=</span> <span style=color:#a6e22e>factor</span>(n), y <span style=color:#f92672>=</span> SharpeRatio, color <span style=color:#f92672>=</span> <span style=color:#a6e22e>factor</span>(m1), shape <span style=color:#f92672>=</span> <span style=color:#a6e22e>factor</span>(m2))) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>geom_point</span>(size <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>labs</span>(title <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;KDJ策略参数优化结果&#34;</span>, 
</span></span><span style=display:flex><span>       x <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;RSV周期(n)&#34;</span>, y <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;夏普比率&#34;</span>,
</span></span><span style=display:flex><span>       color <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;K值平滑因子(m1)&#34;</span>, shape <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;D值平滑因子(m2)&#34;</span>) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>theme_minimal</span>()
</span></span></code></pre></div><img src=/post/kdj_files/figure-html/optimization-1.png width=90% style=display:block;margin:auto><h1 id=基于最佳参数的回测>基于最佳参数的回测</h1><p>根据参数优化结果，我们使用最佳参数组合重新进行回测，并详细分析策略表现：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#75715e># 清理历史环境对象</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>reset_strategy_env</span>()
</span></span></code></pre></div><pre tabindex=0><code>## 策略环境已重置
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#75715e># 初始化quantstrat</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>rm</span>(list <span style=color:#f92672>=</span> <span style=color:#a6e22e>ls</span>(.blotter))
</span></span><span style=display:flex><span><span style=color:#a6e22e>rm</span>(list <span style=color:#f92672>=</span> <span style=color:#a6e22e>ls</span>(.strategy))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 设置初始参数</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>currency</span>(<span style=color:#e6db74>&#34;USD&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;USD&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#a6e22e>stock</span>(<span style=color:#e6db74>&#34;AAPL&#34;</span>, currency <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;USD&#34;</span>, multiplier <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;AAPL&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span>initEq.st <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>1000000</span>  <span style=color:#75715e># 初始资金</span>
</span></span><span style=display:flex><span>portfolio.st <span style=color:#f92672>&lt;-</span> <span style=color:#e6db74>&#34;KDJ_Portfolio_Best&#34;</span>
</span></span><span style=display:flex><span>strategy.st <span style=color:#f92672>&lt;-</span> <span style=color:#e6db74>&#34;KDJ_Strategy_Best&#34;</span>
</span></span><span style=display:flex><span>account.st <span style=color:#f92672>&lt;-</span> <span style=color:#e6db74>&#34;KDJ_Account_Best&#34;</span>
</span></span><span style=display:flex><span>symbols.st <span style=color:#f92672>&lt;-</span> <span style=color:#e6db74>&#34;AAPL&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>best_params <span style=color:#f92672>&lt;-</span> best_params_order[1,]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>initPortf</span>(portfolio.st, symbols <span style=color:#f92672>=</span> symbols.st)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;KDJ_Portfolio_Best&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#a6e22e>initAcct</span>(account.st, portfolios <span style=color:#f92672>=</span> portfolio.st, initEq <span style=color:#f92672>=</span> initEq.st)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;KDJ_Account_Best&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#a6e22e>initOrders</span>(portfolio <span style=color:#f92672>=</span> portfolio.st)
</span></span><span style=display:flex><span><span style=color:#a6e22e>strategy</span>(strategy.st, store <span style=color:#f92672>=</span> <span style=color:#66d9ef>TRUE</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 生成指标名字</span>
</span></span><span style=display:flex><span>indicator_label <span style=color:#f92672>&lt;-</span>  <span style=color:#a6e22e>paste0</span>(<span style=color:#e6db74>&#34;KDJ_&#34;</span>, best_params<span style=color:#f92672>$</span>n, <span style=color:#e6db74>&#34;_&#34;</span>, best_params<span style=color:#f92672>$</span>m1, <span style=color:#e6db74>&#34;_&#34;</span>, best_params<span style=color:#f92672>$</span>m2)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 添加KDJ指标，使用最佳参数</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>add.indicator</span>(strategy.st, 
</span></span><span style=display:flex><span>              name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;KDJ&#34;</span>, 
</span></span><span style=display:flex><span>              arguments <span style=color:#f92672>=</span> <span style=color:#a6e22e>list</span>(ohlc <span style=color:#f92672>=</span> <span style=color:#a6e22e>quote</span>(<span style=color:#a6e22e>HLC</span>(AAPL)), 
</span></span><span style=display:flex><span>                               n <span style=color:#f92672>=</span> best_params<span style=color:#f92672>$</span>n, 
</span></span><span style=display:flex><span>                               m1 <span style=color:#f92672>=</span> best_params<span style=color:#f92672>$</span>m1, 
</span></span><span style=display:flex><span>                               m2 <span style=color:#f92672>=</span> best_params<span style=color:#f92672>$</span>m2),
</span></span><span style=display:flex><span>              label <span style=color:#f92672>=</span> indicator_label)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;KDJ_Strategy_Best&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#75715e># 生成指标列名</span>
</span></span><span style=display:flex><span>  k_col <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>paste0</span>(<span style=color:#e6db74>&#34;K.&#34;</span>, indicator_label)
</span></span><span style=display:flex><span>  d_col <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>paste0</span>(<span style=color:#e6db74>&#34;D.&#34;</span>, indicator_label)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#75715e># 买入信号</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>add.signal</span>(strategy.st, <span style=color:#e6db74>&#34;sigCrossover&#34;</span>, 
</span></span><span style=display:flex><span>               <span style=color:#a6e22e>list</span>(columns <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>(k_col, d_col), relationship <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;gte&#34;</span>),
</span></span><span style=display:flex><span>               label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;K_gte_D&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;KDJ_Strategy_Best&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span>    <span style=color:#a6e22e>add.signal</span>(strategy.st, <span style=color:#e6db74>&#34;sigThreshold&#34;</span>, 
</span></span><span style=display:flex><span>               <span style=color:#a6e22e>list</span>(column <span style=color:#f92672>=</span> k_col, threshold <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span>, relationship <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lt&#34;</span>),
</span></span><span style=display:flex><span>               label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;K_lt_20&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;KDJ_Strategy_Best&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span>    <span style=color:#a6e22e>add.signal</span>(strategy.st, <span style=color:#e6db74>&#34;sigThreshold&#34;</span>, 
</span></span><span style=display:flex><span>               <span style=color:#a6e22e>list</span>(column <span style=color:#f92672>=</span> d_col, threshold <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span>, relationship <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lt&#34;</span>),
</span></span><span style=display:flex><span>               label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;D_lt_20&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;KDJ_Strategy_Best&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span>    <span style=color:#a6e22e>add.signal</span>(strategy.st, <span style=color:#e6db74>&#34;sigFormula&#34;</span>, 
</span></span><span style=display:flex><span>               <span style=color:#a6e22e>list</span>(signals <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>(<span style=color:#e6db74>&#34;K_gte_D&#34;</span>, <span style=color:#e6db74>&#34;K_lt_20&#34;</span>, <span style=color:#e6db74>&#34;D_lt_20&#34;</span>), 
</span></span><span style=display:flex><span>                    formula <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;K_gte_D &amp; K_lt_20 &amp; D_lt_20&#34;</span>),
</span></span><span style=display:flex><span>               label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Buy_Signal&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;KDJ_Strategy_Best&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span>    <span style=color:#75715e># 卖出信号</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>add.signal</span>(strategy.st, <span style=color:#e6db74>&#34;sigCrossover&#34;</span>, 
</span></span><span style=display:flex><span>               <span style=color:#a6e22e>list</span>(columns <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>(k_col, d_col), relationship <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lte&#34;</span>),
</span></span><span style=display:flex><span>               label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;K_lte_D&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;KDJ_Strategy_Best&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span>    <span style=color:#a6e22e>add.signal</span>(strategy.st, <span style=color:#e6db74>&#34;sigThreshold&#34;</span>, 
</span></span><span style=display:flex><span>               <span style=color:#a6e22e>list</span>(column <span style=color:#f92672>=</span> k_col, threshold <span style=color:#f92672>=</span> <span style=color:#ae81ff>70</span>, relationship <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;gt&#34;</span>),
</span></span><span style=display:flex><span>               label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;K_gt_70&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;KDJ_Strategy_Best&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span>    <span style=color:#a6e22e>add.signal</span>(strategy.st, <span style=color:#e6db74>&#34;sigThreshold&#34;</span>, 
</span></span><span style=display:flex><span>               <span style=color:#a6e22e>list</span>(column <span style=color:#f92672>=</span> d_col, threshold <span style=color:#f92672>=</span> <span style=color:#ae81ff>70</span>, relationship <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;gt&#34;</span>),
</span></span><span style=display:flex><span>               label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;D_gt_70&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;KDJ_Strategy_Best&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span>    <span style=color:#a6e22e>add.signal</span>(strategy.st, <span style=color:#e6db74>&#34;sigFormula&#34;</span>, 
</span></span><span style=display:flex><span>               <span style=color:#a6e22e>list</span>(signals <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>(<span style=color:#e6db74>&#34;K_lte_D&#34;</span>, <span style=color:#e6db74>&#34;K_gt_70&#34;</span>, <span style=color:#e6db74>&#34;D_gt_70&#34;</span>),
</span></span><span style=display:flex><span>                    formula <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;K_lte_D &amp; K_gt_70 &amp; D_gt_70&#34;</span>),
</span></span><span style=display:flex><span>               label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Sell_Signal&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;KDJ_Strategy_Best&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span>    <span style=color:#75715e># 添加交易规则</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>add.rule</span>(strategy.st, <span style=color:#e6db74>&#34;ruleSignal&#34;</span>, 
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>list</span>(sigcol <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Buy_Signal&#34;</span>, sigval <span style=color:#f92672>=</span> <span style=color:#66d9ef>TRUE</span>, 
</span></span><span style=display:flex><span>                  orderqty <span style=color:#f92672>=</span> <span style=color:#ae81ff>250000</span>, ordertype <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;market&#34;</span>, 
</span></span><span style=display:flex><span>                  orderside <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;long&#34;</span>, replace <span style=color:#f92672>=</span> <span style=color:#66d9ef>FALSE</span>),
</span></span><span style=display:flex><span>             type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;enter&#34;</span>, label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Enter_Long&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;KDJ_Strategy_Best&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span>    <span style=color:#a6e22e>add.rule</span>(strategy.st, <span style=color:#e6db74>&#34;ruleSignal&#34;</span>, 
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>list</span>(sigcol <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Sell_Signal&#34;</span>, sigval <span style=color:#f92672>=</span> <span style=color:#66d9ef>TRUE</span>, 
</span></span><span style=display:flex><span>                  orderqty <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;all&#34;</span>, ordertype <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;market&#34;</span>, 
</span></span><span style=display:flex><span>                  orderside <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;long&#34;</span>, replace <span style=color:#f92672>=</span> <span style=color:#66d9ef>FALSE</span>),
</span></span><span style=display:flex><span>             type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;exit&#34;</span>, label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Exit_Long&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;KDJ_Strategy_Best&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span>    <span style=color:#75715e># 添加止损规则</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>add.rule</span>(strategy.st, <span style=color:#e6db74>&#34;ruleSignal&#34;</span>, 
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>list</span>(threshold <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.10</span>, 
</span></span><span style=display:flex><span>                  sigcol <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Buy_Signal&#34;</span>, 
</span></span><span style=display:flex><span>                  sigval <span style=color:#f92672>=</span> <span style=color:#66d9ef>TRUE</span>,
</span></span><span style=display:flex><span>                  orderqty <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;all&#34;</span>, 
</span></span><span style=display:flex><span>                  ordertype <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;stoplimit&#34;</span>, 
</span></span><span style=display:flex><span>                  orderside <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;long&#34;</span>, 
</span></span><span style=display:flex><span>                  replace <span style=color:#f92672>=</span> <span style=color:#66d9ef>FALSE</span>),
</span></span><span style=display:flex><span>             type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;chain&#34;</span>, 
</span></span><span style=display:flex><span>             parent <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Enter_Long&#34;</span>, 
</span></span><span style=display:flex><span>             label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Stop_Loss_10%&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;KDJ_Strategy_Best&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#75715e># 运行回测</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>applyStrategy</span>(strategy <span style=color:#f92672>=</span> strategy.st, portfolios <span style=color:#f92672>=</span> portfolio.st)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;2018-05-01 00:00:00 AAPL 250000 @ 42.2750015258789&#34;
## [1] &#34;2018-05-15 00:00:00 AAPL -250000 @ 46.6100006103516&#34;
## [1] &#34;2018-11-19 00:00:00 AAPL 250000 @ 46.4650001525879&#34;
## [1] &#34;2018-11-27 00:00:00 AAPL 250000 @ 43.560001373291&#34;
## [1] &#34;2018-12-13 00:00:00 AAPL 250000 @ 42.7374992370605&#34;
## [1] &#34;2018-12-27 00:00:00 AAPL 250000 @ 39.0374984741211&#34;
## [1] &#34;2019-01-09 00:00:00 AAPL 250000 @ 38.3274993896484&#34;
## [1] &#34;2019-02-11 00:00:00 AAPL -1250000 @ 42.3574981689453&#34;
## [1] &#34;2019-06-04 00:00:00 AAPL 250000 @ 44.9099998474121&#34;
## [1] &#34;2019-07-09 00:00:00 AAPL -250000 @ 50.310001373291&#34;
## [1] &#34;2020-03-25 00:00:00 AAPL 250000 @ 61.3800010681152&#34;
## [1] &#34;2020-04-21 00:00:00 AAPL -250000 @ 67.0924987792969&#34;
## [1] &#34;2021-03-10 00:00:00 AAPL 250000 @ 119.980003356934&#34;
## [1] &#34;2021-04-21 00:00:00 AAPL -250000 @ 133.5&#34;
## [1] &#34;2021-06-07 00:00:00 AAPL 250000 @ 125.900001525879&#34;
## [1] &#34;2021-07-07 00:00:00 AAPL -250000 @ 144.570007324219&#34;
## [1] &#34;2021-10-04 00:00:00 AAPL 250000 @ 139.139999389648&#34;
## [1] &#34;2021-10-06 00:00:00 AAPL 250000 @ 142&#34;
## [1] &#34;2021-11-11 00:00:00 AAPL -5e+05 @ 147.869995117188&#34;
## [1] &#34;2022-05-16 00:00:00 AAPL 250000 @ 145.539993286133&#34;
## [1] &#34;2022-05-24 00:00:00 AAPL 250000 @ 140.360000610352&#34;
## [1] &#34;2022-06-22 00:00:00 AAPL 250000 @ 135.350006103516&#34;
## [1] &#34;2022-07-26 00:00:00 AAPL -750000 @ 151.600006103516&#34;
## [1] &#34;2022-09-20 00:00:00 AAPL 250000 @ 156.899993896484&#34;
## [1] &#34;2022-09-29 00:00:00 AAPL 250000 @ 142.479995727539&#34;
## [1] &#34;2022-10-04 00:00:00 AAPL 250000 @ 146.100006103516&#34;
## [1] &#34;2022-10-14 00:00:00 AAPL 250000 @ 138.380004882812&#34;
## [1] &#34;2022-12-22 00:00:00 AAPL 250000 @ 132.229995727539&#34;
## [1] &#34;2022-12-30 00:00:00 AAPL 250000 @ 129.929992675781&#34;
## [1] &#34;2023-01-09 00:00:00 AAPL 250000 @ 130.149993896484&#34;
## [1] &#34;2023-02-07 00:00:00 AAPL -1750000 @ 154.649993896484&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#a6e22e>updatePortf</span>(portfolio.st)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;KDJ_Portfolio_Best&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#a6e22e>updateAcct</span>(account.st)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;KDJ_Account_Best&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#a6e22e>updateEndEq</span>(account.st)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;KDJ_Account_Best&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#75715e># 获取策略收益</span>
</span></span><span style=display:flex><span>port_ret_best <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>PortfReturns</span>(account.st)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 计算评估指标</span>
</span></span><span style=display:flex><span>sharpe_ratio_best <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>SharpeRatio.annualized</span>(port_ret_best)
</span></span><span style=display:flex><span>total_return_best <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>Return.cumulative</span>(port_ret_best)
</span></span><span style=display:flex><span>max_drawdown_best <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>maxDrawdown</span>(port_ret_best)
</span></span><span style=display:flex><span>trade_count_best <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>length</span>(<span style=color:#a6e22e>index</span>(<span style=color:#a6e22e>getTxns</span>(Portfolio <span style=color:#f92672>=</span> portfolio.st, 
</span></span><span style=display:flex><span>                                         Symbol <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;AAPL&#34;</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 计算买入持有策略的收益作为基准</span>
</span></span><span style=display:flex><span>buy_hold_ret <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>dailyReturn</span>(<span style=color:#a6e22e>Cl</span>(AAPL))
</span></span><span style=display:flex><span>sharpe_ratio_bh <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>SharpeRatio.annualized</span>(buy_hold_ret)
</span></span><span style=display:flex><span>total_return_bh <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>Return.cumulative</span>(buy_hold_ret)
</span></span><span style=display:flex><span>max_drawdown_bh <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>maxDrawdown</span>(buy_hold_ret)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 输出评估结果</span>
</span></span><span style=display:flex><span>results_df <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>data.frame</span>(
</span></span><span style=display:flex><span>  Strategy <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>(<span style=color:#e6db74>&#34;KDJ策略&#34;</span>, <span style=color:#e6db74>&#34;买入持有&#34;</span>),
</span></span><span style=display:flex><span>  年化夏普比率 <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>(sharpe_ratio_best, sharpe_ratio_bh),
</span></span><span style=display:flex><span>  总收益率 <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>(total_return_best, total_return_bh),
</span></span><span style=display:flex><span>  最大回撤 <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>(max_drawdown_best, max_drawdown_bh),
</span></span><span style=display:flex><span>  交易次数 <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>(trade_count_best, <span style=color:#66d9ef>NA</span>)
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>print</span>(<span style=color:#e6db74>&#34;策略评估结果:&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;策略评估结果:&#34;
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#a6e22e>print</span>(results_df)
</span></span></code></pre></div><pre tabindex=0><code>##   Strategy 年化夏普比率     总收益率     最大回撤 交易次数
## 1  KDJ策略 3217.8410168 3.302791e+25 3126.5533119       32
## 2 买入持有    0.9126001 3.115871e+00    0.3872969       NA
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#75715e># 可视化策略收益</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>charts.PerformanceSummary</span>(<span style=color:#a6e22e>cbind</span>(port_ret_best, buy_hold_ret), 
</span></span><span style=display:flex><span>                          main <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;KDJ策略与买入持有策略收益对比&#34;</span>,
</span></span><span style=display:flex><span>                          colorset <span style=color:#f92672>=</span> bluefocus, 
</span></span><span style=display:flex><span>                          wealth.index <span style=color:#f92672>=</span> <span style=color:#66d9ef>TRUE</span>)
</span></span></code></pre></div><img src=/post/kdj_files/figure-html/backtest-1.png width=90% style=display:block;margin:auto><h1 id=交易信号可视化>交易信号可视化</h1><p>为了更直观地理解KDJ指标的交易信号，我们将可视化价格走势和KDJ指标，并标记买卖点：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span>price_data <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>Cl</span>(AAPL)
</span></span><span style=display:flex><span><span style=color:#75715e># 提取KDJ指标值</span>
</span></span><span style=display:flex><span>kdj_data <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>KDJ</span>(<span style=color:#a6e22e>HLC</span>(AAPL), 
</span></span><span style=display:flex><span>                  n <span style=color:#f92672>=</span> best_params<span style=color:#f92672>$</span>n, 
</span></span><span style=display:flex><span>                  m1 <span style=color:#f92672>=</span> best_params<span style=color:#f92672>$</span>m1, 
</span></span><span style=display:flex><span>                  m2 <span style=color:#f92672>=</span> best_params<span style=color:#f92672>$</span>m2)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>merge_data <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>merge</span>(price_data, kdj_data)
</span></span><span style=display:flex><span><span style=color:#75715e># 提取交易信号</span>
</span></span><span style=display:flex><span>signals <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>generateSimpleSignalChain</span>(<span style=color:#a6e22e>getTxns</span>(portfolio.st,<span style=color:#e6db74>&#34;AAPL&#34;</span>),
</span></span><span style=display:flex><span>                                     type<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;numeric&#34;</span>
</span></span><span style=display:flex><span>                                     )[<span style=color:#ae81ff>-1</span>,]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>merged_xts <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>merge</span>(merge_data, signals, fill <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 转换xts为data.frame并添加日期列</span>
</span></span><span style=display:flex><span>plot_data <span style=color:#f92672>&lt;-</span> merged_xts <span style=color:#f92672>%&gt;%</span> 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>as.data.frame</span>() <span style=color:#f92672>%&gt;%</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>rownames_to_column</span>(var <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Date&#34;</span>) <span style=color:#f92672>%&gt;%</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>mutate</span>(Date <span style=color:#f92672>=</span> <span style=color:#a6e22e>as.Date</span>(Date))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 提取买卖点数据</span>
</span></span><span style=display:flex><span>buy_points <span style=color:#f92672>&lt;-</span> plot_data <span style=color:#f92672>%&gt;%</span> <span style=color:#a6e22e>filter</span>(Signal <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>)  <span style=color:#75715e># 假设Signal=1表示买入</span>
</span></span><span style=display:flex><span>sell_points <span style=color:#f92672>&lt;-</span> plot_data <span style=color:#f92672>%&gt;%</span> <span style=color:#a6e22e>filter</span>(Signal <span style=color:#f92672>==</span> <span style=color:#ae81ff>-1</span>)  <span style=color:#75715e># 假设Signal=-1表示卖出</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 1. 价格与交易信号图</span>
</span></span><span style=display:flex><span>price_plot <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>ggplot</span>(plot_data, <span style=color:#a6e22e>aes</span>(x <span style=color:#f92672>=</span> Date, y <span style=color:#f92672>=</span> Close)) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># 绘制价格线</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>geom_line</span>(color <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;black&#34;</span>, size <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># 添加价格趋势带（20日移动平均线上下波动）</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>geom_ribbon</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>aes</span>(ymin <span style=color:#f92672>=</span> Close <span style=color:#f92672>-</span> <span style=color:#ae81ff>0.1</span> <span style=color:#f92672>*</span> Close, ymax <span style=color:#f92672>=</span> Close <span style=color:#f92672>+</span> <span style=color:#ae81ff>0.1</span> <span style=color:#f92672>*</span> Close),
</span></span><span style=display:flex><span>    alpha <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.1</span>, fill <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;blue&#34;</span>
</span></span><span style=display:flex><span>  ) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># 标记买卖点</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>geom_point</span>(data <span style=color:#f92672>=</span> buy_points, <span style=color:#a6e22e>aes</span>(y <span style=color:#f92672>=</span> Close), 
</span></span><span style=display:flex><span>             color <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;green&#34;</span>, size <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>, shape <span style=color:#f92672>=</span> <span style=color:#ae81ff>16</span>, alpha <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.8</span>) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>geom_point</span>(data <span style=color:#f92672>=</span> sell_points, <span style=color:#a6e22e>aes</span>(y <span style=color:#f92672>=</span> Close), 
</span></span><span style=display:flex><span>             color <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;red&#34;</span>, size <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>, shape <span style=color:#f92672>=</span> <span style=color:#ae81ff>16</span>, alpha <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.8</span>) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># 添加买卖点标记文本</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>geom_text</span>(data <span style=color:#f92672>=</span> buy_points, <span style=color:#a6e22e>aes</span>(y <span style=color:#f92672>=</span> Close <span style=color:#f92672>+</span> <span style=color:#ae81ff>5</span>, label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;B&#34;</span>), 
</span></span><span style=display:flex><span>            color <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;darkgreen&#34;</span>, size <span style=color:#f92672>=</span> <span style=color:#ae81ff>3.5</span>, fontface <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;bold&#34;</span>) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>geom_text</span>(data <span style=color:#f92672>=</span> sell_points, <span style=color:#a6e22e>aes</span>(y <span style=color:#f92672>=</span> Close <span style=color:#f92672>-</span> <span style=color:#ae81ff>5</span>, label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;S&#34;</span>), 
</span></span><span style=display:flex><span>            color <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;darkred&#34;</span>, size <span style=color:#f92672>=</span> <span style=color:#ae81ff>3.5</span>, fontface <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;bold&#34;</span>) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># 设置标题和坐标轴标签</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>labs</span>(
</span></span><span style=display:flex><span>    title <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;苹果公司股票价格走势与交易信号&#34;</span>,
</span></span><span style=display:flex><span>    subtitle <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;2018-2023年期间基于KDJ指标的交易信号&#34;</span>,
</span></span><span style=display:flex><span>    y <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;收盘价 (USD)&#34;</span>,
</span></span><span style=display:flex><span>    x <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>  ) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># 自定义主题</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>theme_minimal</span>() <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>theme</span>(
</span></span><span style=display:flex><span>    plot.title <span style=color:#f92672>=</span> <span style=color:#a6e22e>element_text</span>(hjust <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.5</span>, size <span style=color:#f92672>=</span> <span style=color:#ae81ff>16</span>, face <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;bold&#34;</span>),
</span></span><span style=display:flex><span>    plot.subtitle <span style=color:#f92672>=</span> <span style=color:#a6e22e>element_text</span>(hjust <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.5</span>, size <span style=color:#f92672>=</span> <span style=color:#ae81ff>12</span>, color <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;gray40&#34;</span>),
</span></span><span style=display:flex><span>    axis.text <span style=color:#f92672>=</span> <span style=color:#a6e22e>element_text</span>(size <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span>    legend.position <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;top&#34;</span>,
</span></span><span style=display:flex><span>    panel.grid.minor <span style=color:#f92672>=</span> <span style=color:#a6e22e>element_blank</span>()
</span></span><span style=display:flex><span>  ) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># 设置x轴日期格式</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>scale_x_date</span>(
</span></span><span style=display:flex><span>    date_breaks <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;3 months&#34;</span>,
</span></span><span style=display:flex><span>    date_labels <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;%b %Y&#34;</span>,
</span></span><span style=display:flex><span>    expand <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>10</span>)  <span style=color:#75715e># 扩展x轴边界</span>
</span></span><span style=display:flex><span>  ) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># 添加价格参考线</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>geom_hline</span>(yintercept <span style=color:#f92672>=</span> <span style=color:#a6e22e>mean</span>(plot_data<span style=color:#f92672>$</span>Close), 
</span></span><span style=display:flex><span>             color <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;gray&#34;</span>, linetype <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;dashed&#34;</span>, size <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.7</span>) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>annotate</span>(<span style=color:#e6db74>&#34;text&#34;</span>, x <span style=color:#f92672>=</span> <span style=color:#a6e22e>max</span>(plot_data<span style=color:#f92672>$</span>Date), y <span style=color:#f92672>=</span> <span style=color:#a6e22e>mean</span>(plot_data<span style=color:#f92672>$</span>Close) <span style=color:#f92672>+</span> <span style=color:#ae81ff>5</span>, 
</span></span><span style=display:flex><span>           label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;平均价格&#34;</span>, color <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;gray&#34;</span>, size <span style=color:#f92672>=</span> <span style=color:#ae81ff>3.5</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2. KDJ指标图</span>
</span></span><span style=display:flex><span>kdj_plot <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>ggplot</span>(plot_data, <span style=color:#a6e22e>aes</span>(x <span style=color:#f92672>=</span> Date)) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># 绘制KDJ线</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>geom_line</span>(<span style=color:#a6e22e>aes</span>(y <span style=color:#f92672>=</span> K, color <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;K线&#34;</span>), size <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>geom_line</span>(<span style=color:#a6e22e>aes</span>(y <span style=color:#f92672>=</span> D, color <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;D线&#34;</span>), size <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>geom_line</span>(<span style=color:#a6e22e>aes</span>(y <span style=color:#f92672>=</span> J, color <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;J线&#34;</span>), size <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># 添加超买超卖区域</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>geom_ribbon</span>(<span style=color:#a6e22e>aes</span>(ymin <span style=color:#f92672>=</span> <span style=color:#ae81ff>80</span>, ymax <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span>), fill <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;salmon&#34;</span>, alpha <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.3</span>) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>geom_ribbon</span>(<span style=color:#a6e22e>aes</span>(ymin <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>, ymax <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span>), fill <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lightgreen&#34;</span>, alpha <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.3</span>) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># 添加超买超卖线</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>geom_hline</span>(yintercept <span style=color:#f92672>=</span> <span style=color:#ae81ff>80</span>, color <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;salmon&#34;</span>, linetype <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;dashed&#34;</span>, size <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.8</span>) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>geom_hline</span>(yintercept <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span>, color <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lightgreen&#34;</span>, linetype <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;dashed&#34;</span>, size <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.8</span>) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># 添加标记文本</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>annotate</span>(<span style=color:#e6db74>&#34;text&#34;</span>, x <span style=color:#f92672>=</span> <span style=color:#a6e22e>min</span>(plot_data<span style=color:#f92672>$</span>Date), y <span style=color:#f92672>=</span> <span style=color:#ae81ff>90</span>, label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;超买区域&#34;</span>, 
</span></span><span style=display:flex><span>           color <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;red&#34;</span>, size <span style=color:#f92672>=</span> <span style=color:#ae81ff>3.5</span>) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>annotate</span>(<span style=color:#e6db74>&#34;text&#34;</span>, x <span style=color:#f92672>=</span> <span style=color:#a6e22e>min</span>(plot_data<span style=color:#f92672>$</span>Date), y <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>, label <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;超卖区域&#34;</span>, 
</span></span><span style=display:flex><span>           color <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;green&#34;</span>, size <span style=color:#f92672>=</span> <span style=color:#ae81ff>3.5</span>) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># 标记买卖点对应的KDJ值</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>geom_point</span>(data <span style=color:#f92672>=</span> buy_points, <span style=color:#a6e22e>aes</span>(x <span style=color:#f92672>=</span> Date, y <span style=color:#f92672>=</span> K), 
</span></span><span style=display:flex><span>             color <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;green&#34;</span>, size <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>, shape <span style=color:#f92672>=</span> <span style=color:#ae81ff>16</span>, alpha <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.6</span>) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>geom_point</span>(data <span style=color:#f92672>=</span> sell_points, <span style=color:#a6e22e>aes</span>(x <span style=color:#f92672>=</span> Date, y <span style=color:#f92672>=</span> K), 
</span></span><span style=display:flex><span>             color <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;red&#34;</span>, size <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>, shape <span style=color:#f92672>=</span> <span style=color:#ae81ff>16</span>, alpha <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.6</span>) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># 设置标题和坐标轴标签</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>labs</span>(
</span></span><span style=display:flex><span>    title <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;KDJ技术指标&#34;</span>,
</span></span><span style=display:flex><span>    y <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;指标值&#34;</span>,
</span></span><span style=display:flex><span>    x <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;日期&#34;</span>
</span></span><span style=display:flex><span>  ) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># 自定义主题</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>theme_minimal</span>() <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>theme</span>(
</span></span><span style=display:flex><span>    plot.title <span style=color:#f92672>=</span> <span style=color:#a6e22e>element_text</span>(hjust <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.5</span>, size <span style=color:#f92672>=</span> <span style=color:#ae81ff>16</span>, face <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;bold&#34;</span>),
</span></span><span style=display:flex><span>    axis.text <span style=color:#f92672>=</span> <span style=color:#a6e22e>element_text</span>(size <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span>    legend.position <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;top&#34;</span>,
</span></span><span style=display:flex><span>    panel.grid.minor <span style=color:#f92672>=</span> <span style=color:#a6e22e>element_blank</span>()
</span></span><span style=display:flex><span>  ) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># 设置x轴日期格式和y轴范围</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>scale_x_date</span>(
</span></span><span style=display:flex><span>    date_breaks <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;3 months&#34;</span>,
</span></span><span style=display:flex><span>    date_labels <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;%b %Y&#34;</span>,
</span></span><span style=display:flex><span>    expand <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span>  ) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>scale_y_continuous</span>(limits <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>100</span>)) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>scale_color_manual</span>(
</span></span><span style=display:flex><span>    values <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>(<span style=color:#e6db74>&#34;K线&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#3366CC&#34;</span>, <span style=color:#e6db74>&#34;D线&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#DC3912&#34;</span>, <span style=color:#e6db74>&#34;J线&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#FF9900&#34;</span>),
</span></span><span style=display:flex><span>    labels <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>(<span style=color:#e6db74>&#34;K线 (快速随机指标)&#34;</span>, <span style=color:#e6db74>&#34;D线 (慢速随机指标)&#34;</span>, <span style=color:#e6db74>&#34;J线 (KDJ专用线)&#34;</span>)
</span></span><span style=display:flex><span>  )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 3. 组合图表</span>
</span></span><span style=display:flex><span>combined_plot <span style=color:#f92672>&lt;-</span> gridExtra<span style=color:#f92672>::</span><span style=color:#a6e22e>grid.arrange</span>(
</span></span><span style=display:flex><span>  price_plot, kdj_plot, 
</span></span><span style=display:flex><span>  nrow <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>, 
</span></span><span style=display:flex><span>  heights <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>1.5</span>),
</span></span><span style=display:flex><span>  top <span style=color:#f92672>=</span> grid<span style=color:#f92672>::</span><span style=color:#a6e22e>textGrob</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;基于KDJ指标的股票交易信号分析&#34;</span>, 
</span></span><span style=display:flex><span>    gp <span style=color:#f92672>=</span> grid<span style=color:#f92672>::</span><span style=color:#a6e22e>gpar</span>(fontsize <span style=color:#f92672>=</span> <span style=color:#ae81ff>18</span>, fontface <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;bold&#34;</span>)
</span></span><span style=display:flex><span>  )
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><img src=/post/kdj_files/figure-html/visualization-1.png width=90% style=display:block;margin:auto><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#a6e22e>print</span>(combined_plot)
</span></span></code></pre></div><pre tabindex=0><code>## TableGrob (3 x 1) &#34;arrange&#34;: 3 grobs
##   z     cells    name                grob
## 1 1 (2-2,1-1) arrange      gtable[layout]
## 2 2 (3-3,1-1) arrange      gtable[layout]
## 3 3 (1-1,1-1) arrange text[GRID.text.216]
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#75715e># 保存图表（可选）</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ggsave(&#34;KDJ_Trading_Analysis.png&#34;, combined_plot, width = 14, height = 10, dpi = 300)</span>
</span></span></code></pre></div><h1 id=交易频率分析>交易频率分析</h1><p>接下来，我们分析交易频率和持有期，这对于评估策略的实用性非常重要：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#75715e># 假设getTxns(portfolio.st,&#34;AAPL&#34;)已获取交易数据</span>
</span></span><span style=display:flex><span>trades <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>getTxns</span>(portfolio.st,<span style=color:#e6db74>&#34;AAPL&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 数据预处理</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>nrow</span>(trades) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>  <span style=color:#75715e># 转换为data.frame并添加日期列</span>
</span></span><span style=display:flex><span>  trades_df <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>as.data.frame</span>(trades)
</span></span><span style=display:flex><span>  trades_df<span style=color:#f92672>$</span>Date <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>as.Date</span>(<span style=color:#a6e22e>index</span>(trades))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e># 提取买卖交易</span>
</span></span><span style=display:flex><span>  buy_trades <span style=color:#f92672>&lt;-</span> trades_df[trades_df<span style=color:#f92672>$</span>Txn.Qty <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>, ]
</span></span><span style=display:flex><span>  sell_trades <span style=color:#f92672>&lt;-</span> trades_df[trades_df<span style=color:#f92672>$</span>Txn.Qty <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>, ]
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e># 确保买卖交易数量匹配</span>
</span></span><span style=display:flex><span>  n_trades <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>min</span>(<span style=color:#a6e22e>nrow</span>(buy_trades), <span style=color:#a6e22e>nrow</span>(sell_trades))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (n_trades <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e># 按时间排序</span>
</span></span><span style=display:flex><span>    buy_trades <span style=color:#f92672>&lt;-</span> buy_trades<span style=color:#a6e22e>[order</span>(buy_trades<span style=color:#f92672>$</span>Date), ]
</span></span><span style=display:flex><span>    sell_trades <span style=color:#f92672>&lt;-</span> sell_trades<span style=color:#a6e22e>[order</span>(sell_trades<span style=color:#f92672>$</span>Date), ]
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 取前n_trades笔交易进行匹配</span>
</span></span><span style=display:flex><span>    buy_trades <span style=color:#f92672>&lt;-</span> buy_trades[1<span style=color:#f92672>:</span>n_trades, ]
</span></span><span style=display:flex><span>    sell_trades <span style=color:#f92672>&lt;-</span> sell_trades[1<span style=color:#f92672>:</span>n_trades, ]
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 计算持有期（天数）</span>
</span></span><span style=display:flex><span>    hold_periods <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>as.numeric</span>(sell_trades<span style=color:#f92672>$</span>Date <span style=color:#f92672>-</span> buy_trades<span style=color:#f92672>$</span>Date)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 计算持有期统计数据</span>
</span></span><span style=display:flex><span>    stats <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>data.frame</span>(
</span></span><span style=display:flex><span>      总交易次数 <span style=color:#f92672>=</span> n_trades,
</span></span><span style=display:flex><span>      平均持有期 <span style=color:#f92672>=</span> <span style=color:#a6e22e>round</span>(<span style=color:#a6e22e>mean</span>(hold_periods), <span style=color:#ae81ff>1</span>),
</span></span><span style=display:flex><span>      最长持有期 <span style=color:#f92672>=</span> <span style=color:#a6e22e>max</span>(hold_periods),
</span></span><span style=display:flex><span>      最短持有期 <span style=color:#f92672>=</span> <span style=color:#a6e22e>min</span>(hold_periods),
</span></span><span style=display:flex><span>      持有期标准差 <span style=color:#f92672>=</span> <span style=color:#a6e22e>round</span>(<span style=color:#a6e22e>sd</span>(hold_periods), <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 输出统计结果</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>print</span>(<span style=color:#e6db74>&#34;交易持有期统计:&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>print</span>(stats)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 1. 持有期分布直方图 - 使用ggplot2</span>
</span></span><span style=display:flex><span>    hold_dist_plot <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>ggplot</span>(<span style=color:#a6e22e>data.frame</span>(hold_periods), <span style=color:#a6e22e>aes</span>(x <span style=color:#f92672>=</span> hold_periods)) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>geom_histogram</span>(<span style=color:#a6e22e>aes</span>(y <span style=color:#f92672>=</span> ..density..), bins <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span>, fill <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#3366CC&#34;</span>, color <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;white&#34;</span>) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>geom_density</span>(alpha <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.2</span>, fill <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#FF9900&#34;</span>) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>geom_vline</span>(xintercept <span style=color:#f92672>=</span> <span style=color:#a6e22e>mean</span>(hold_periods), color <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;red&#34;</span>, linetype <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;dashed&#34;</span>, size <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>labs</span>(
</span></span><span style=display:flex><span>        title <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;交易持有期分布&#34;</span>,
</span></span><span style=display:flex><span>        x <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;持有天数&#34;</span>,
</span></span><span style=display:flex><span>        y <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;密度&#34;</span>,
</span></span><span style=display:flex><span>        subtitle <span style=color:#f92672>=</span> <span style=color:#a6e22e>paste</span>(<span style=color:#e6db74>&#34;平均持有期: &#34;</span>, <span style=color:#a6e22e>mean</span>(hold_periods), <span style=color:#e6db74>&#34;天&#34;</span>)
</span></span><span style=display:flex><span>      ) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>theme_minimal</span>() <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>theme</span>(
</span></span><span style=display:flex><span>        plot.title <span style=color:#f92672>=</span> <span style=color:#a6e22e>element_text</span>(hjust <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.5</span>, size <span style=color:#f92672>=</span> <span style=color:#ae81ff>16</span>, face <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;bold&#34;</span>),
</span></span><span style=display:flex><span>        plot.subtitle <span style=color:#f92672>=</span> <span style=color:#a6e22e>element_text</span>(hjust <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.5</span>, size <span style=color:#f92672>=</span> <span style=color:#ae81ff>12</span>),
</span></span><span style=display:flex><span>        axis.text <span style=color:#f92672>=</span> <span style=color:#a6e22e>element_text</span>(size <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span>        panel.grid.minor <span style=color:#f92672>=</span> <span style=color:#a6e22e>element_blank</span>()
</span></span><span style=display:flex><span>      )
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 2. 持有期箱线图 - 展示分布特征</span>
</span></span><span style=display:flex><span>    hold_boxplot <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>ggplot</span>(<span style=color:#a6e22e>data.frame</span>(hold_periods), <span style=color:#a6e22e>aes</span>(x <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>, y <span style=color:#f92672>=</span> hold_periods)) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>geom_boxplot</span>(fill <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#3366CC&#34;</span>, alpha <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.7</span>) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>geom_jitter</span>(color <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#FF9900&#34;</span>, alpha <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.5</span>) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>labs</span>(
</span></span><span style=display:flex><span>        title <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;持有期分布箱线图&#34;</span>,
</span></span><span style=display:flex><span>        y <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;持有天数&#34;</span>
</span></span><span style=display:flex><span>      ) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>theme_minimal</span>() <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>theme</span>(
</span></span><span style=display:flex><span>        plot.title <span style=color:#f92672>=</span> <span style=color:#a6e22e>element_text</span>(hjust <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.5</span>, size <span style=color:#f92672>=</span> <span style=color:#ae81ff>16</span>, face <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;bold&#34;</span>),
</span></span><span style=display:flex><span>        axis.text.x <span style=color:#f92672>=</span> <span style=color:#a6e22e>element_blank</span>(),
</span></span><span style=display:flex><span>        panel.grid.minor <span style=color:#f92672>=</span> <span style=color:#a6e22e>element_blank</span>()
</span></span><span style=display:flex><span>      )
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 3. 交易频率分析 - 按月统计</span>
</span></span><span style=display:flex><span>    trades_df<span style=color:#f92672>$</span>YearMonth <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>format</span>(trades_df<span style=color:#f92672>$</span>Date, <span style=color:#e6db74>&#34;%Y-%m&#34;</span>)
</span></span><span style=display:flex><span>    trade_frequency <span style=color:#f92672>&lt;-</span> trades_df <span style=color:#f92672>%&gt;%</span> 
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>group_by</span>(YearMonth) <span style=color:#f92672>%&gt;%</span> 
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>summarise</span>(交易次数 <span style=color:#f92672>=</span> <span style=color:#a6e22e>n</span>())
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 交易频率柱状图</span>
</span></span><span style=display:flex><span>    freq_barplot <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>ggplot</span>(trade_frequency, <span style=color:#a6e22e>aes</span>(x <span style=color:#f92672>=</span> YearMonth, y <span style=color:#f92672>=</span> 交易次数)) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>geom_bar</span>(stat <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;identity&#34;</span>, fill <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#33CC99&#34;</span>, color <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;white&#34;</span>) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>labs</span>(
</span></span><span style=display:flex><span>        title <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;月度交易频率&#34;</span>,
</span></span><span style=display:flex><span>        x <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;年月&#34;</span>,
</span></span><span style=display:flex><span>        y <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;交易次数&#34;</span>
</span></span><span style=display:flex><span>      ) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>theme_minimal</span>() <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>theme</span>(
</span></span><span style=display:flex><span>        plot.title <span style=color:#f92672>=</span> <span style=color:#a6e22e>element_text</span>(hjust <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.5</span>, size <span style=color:#f92672>=</span> <span style=color:#ae81ff>16</span>, face <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;bold&#34;</span>),
</span></span><span style=display:flex><span>        axis.text.x <span style=color:#f92672>=</span> <span style=color:#a6e22e>element_text</span>(angle <span style=color:#f92672>=</span> <span style=color:#ae81ff>45</span>, hjust <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>, size <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>),
</span></span><span style=display:flex><span>        panel.grid.minor <span style=color:#f92672>=</span> <span style=color:#a6e22e>element_blank</span>()
</span></span><span style=display:flex><span>      )
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 4. 组合图表</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>library</span>(patchwork)
</span></span><span style=display:flex><span>    combined_plot <span style=color:#f92672>&lt;-</span> (hold_dist_plot <span style=color:#f92672>+</span> hold_boxplot) <span style=color:#f92672>/</span> freq_barplot <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>plot_annotation</span>(title <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;AAPL交易持有期与交易频率分析&#34;</span>,
</span></span><span style=display:flex><span>                      theme <span style=color:#f92672>=</span> <span style=color:#a6e22e>theme</span>(plot.title <span style=color:#f92672>=</span> <span style=color:#a6e22e>element_text</span>(hjust <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.5</span>, size <span style=color:#f92672>=</span> <span style=color:#ae81ff>18</span>, face <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;bold&#34;</span>)))
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 显示图表</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>print</span>(combined_plot)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 保存图表（可选）</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># ggsave(&#34;trading_analysis.png&#34;, combined_plot, width = 12, height = 8, dpi = 300)</span>
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cat</span>(<span style=color:#e6db74>&#34;没有足够的买卖交易对进行分析\n&#34;</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>cat</span>(<span style=color:#e6db74>&#34;没有交易数据可供分析\n&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><pre tabindex=0><code>## [1] &#34;交易持有期统计:&#34;
##   总交易次数 平均持有期 最长持有期 最短持有期 持有期标准差
## 1          9      557.3        910         14        364.1
</code></pre><img src=/post/kdj_files/figure-html/trade_analysis-1.png width=90% style=display:block;margin:auto><h1 id=结论与展望>结论与展望</h1><h2 id=研究结论>研究结论</h2><p>通过对KDJ指标的参数优化和回测分析，我们得出以下结论：</p><ol><li>在研究期间内，基于KDJ指标的择时策略在特定参数组合下能够取得优于简单买入持有策略的风险调整后收益。</li><li>最佳参数组合显示，RSV周期(n)、K值平滑因子(k)和D值平滑因子(d)对策略表现有显著影响。</li><li>策略的交易频率适中，平均持有期符合中短期投资风格。</li></ol><h2 id=策略局限性>策略局限性</h2><p>尽管KDJ指标在某些市场环境下表现良好，但仍存在以下局限性：</p><ol><li>回测结果受历史数据限制，未来表现可能与历史表现不同。</li><li>策略在剧烈波动的市场环境中可能产生更多的虚假信号。</li><li>交易成本和滑点未被充分考虑，实际应用中可能降低策略收益。</li></ol><h2 id=未来研究方向>未来研究方向</h2><ol><li>结合其他技术指标（如MACD、布林带等）构建多指标复合策略。</li><li>研究不同市场环境下KDJ指标的适用性，开发自适应参数机制。</li><li>考虑交易成本、滑点和税费等实际因素，优化策略实现。</li></ol><p>通过本研究，我们展示了如何使用R语言和相关金融包实现技术指标的回测和优化，为量化交易策略的开发提供了实用的方法和思路。</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M4 0h8s2 0 4 2l15 15s2 2 0 4L21 31s-2 2-4 0L2 16s-2-2-2-4V3s0-3 4-3m3 10a3 3 0 000-6 3 3 0 000 6"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/r/ rel=tag>R</a></li><li class=tags__item><a class="tags__link btn" href=/tags/kdj/ rel=tag>KDJ</a></li><li class=tags__item><a class="tags__link btn" href=/tags/%E6%8B%A9%E6%97%B6/ rel=tag>择时</a></li></ul></div></footer></article><script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js async></script><script>window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,tags:"ams"},svg:{fontCache:"global"}}</script></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2025 R-Finance中国.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script><script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js async></script><script>window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,tags:"ams"},svg:{fontCache:"global"}}</script></body></html>