<!doctype html><html class=no-js lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>均值回归策略有效性分析 - R-Finance中国</title><script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:url" content="https://rfinance.org.cn/docs/mean-reverse/"><meta property="og:site_name" content="R-Finance中国"><meta property="og:title" content="均值回归策略有效性分析"><meta property="og:description" content='引言 均值回归是金融市场中的一种重要现象，指资产价格或收益率在长期内趋向于回归其历史平 均值。基于这一理论的交易策略通常假设价格偏离其均值后会回归，因此可以通过买入低价 资产、卖出高价资产来获利。
本文将通过R语言实现均值回归策略，并验证其有效性。我们将选取多只股票作为样本，优化 策略参数，并在样本外数据上验证策略的表现。
数据准备与分析 首先加载必要的R包并获取股票数据。我们将选取几只具有代表性的美国科技股作为研究对象。
# 加载必要的R包 library(quantmod) library(PerformanceAnalytics) library(foreach) library(doParallel) library(ggplot2) library(dplyr) library(tidyr) library(eTTR) library(zoo) 接下来，我们获取多只股票的历史数据。这里选择了苹果(AAPL)、微软(MSFT)、谷歌(GOOG)、 亚马逊(AMZN)和特斯拉(TSLA)作为样本。
# 设置起止日期 start_date <- "2018-01-01" end_date <- "2023-01-01" out_of_sample_date <- "2023-01-02" end_oos_date <- "2023-12-31" # 股票代码列表 stock_symbols <- c("AAPL", "MSFT", "GOOG", "AMZN", "TSLA") # 获取股票数据 stock_data <- list() for (symbol in stock_symbols) { data_raw <- getSymbols(symbol, from = start_date, to = end_date, auto.assign = FALSE) colnames(data_raw) <- c("Open", "High", "Low", "Close", "Volume", "Adjusted") stock_data[[symbol]] <- data_raw } # 获取样本外数据 oos_data <- list() for (symbol in stock_symbols) { data_raw <- getSymbols(symbol, from = out_of_sample_date, to = end_oos_date, auto.assign = FALSE) colnames(data_raw) <- c("Open", "High", "Low", "Close", "Volume", "Adjusted") oos_data[[symbol]] <- data_raw } 让我们可视化这些股票的价格走势，以便对数据有一个直观的了解。'><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:published_time" content="2025-06-10T15:36:25+00:00"><meta property="article:modified_time" content="2025-06-10T15:36:25+00:00"><meta property="article:tag" content="R"><meta property="article:tag" content="金融"><meta property="article:tag" content="均值回复"><meta property="article:tag" content="有效性"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title=R-Finance中国 rel=home><div class="logo__item logo__text"><div class=logo__title>R-Finance中国</div><div class=logo__tagline>R语言与金融深度融合的堡垒站点</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/conference/><span class=menu__text>会议</span></a></li><li class=menu__item><a class=menu__link href=/salon/><span class=menu__text>沙龙</span></a></li><li class=menu__item><a class=menu__link href=/bootcamp/><span class=menu__text>训练坊</span></a></li><li class=menu__item><a class=menu__link href=/media/><span class=menu__text>媒体矩阵</span></a></li><li class=menu__item><a class=menu__link href=/about/><span class=menu__text>关于本站</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>均值回归策略有效性分析</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0a14 14 0 110 28 1 1 0 010-28m0 3a3 3 0 100 22 3 3 0 000-22m1 4h-2v8.4l6.8 4.4L22 18l-6-3.8z"/></svg><time class=meta__text datetime=2025-06-10T15:36:25Z>June 10, 2025</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class=meta__text><a class=meta__link href=/categories/r%E8%AF%AD%E8%A8%80/ rel=category>R语言</a>, <a class=meta__link href=/categories/%E9%87%91%E8%9E%8D%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/ rel=category>金融数据分析</a></span></div></div></header><div class="content post__content clearfix"><h1 id=引言>引言</h1><p>均值回归是金融市场中的一种重要现象，指资产价格或收益率在长期内趋向于回归其历史平
均值。基于这一理论的交易策略通常假设价格偏离其均值后会回归，因此可以通过买入低价
资产、卖出高价资产来获利。</p><p>本文将通过R语言实现均值回归策略，并验证其有效性。我们将选取多只股票作为样本，优化
策略参数，并在样本外数据上验证策略的表现。</p><h1 id=数据准备与分析>数据准备与分析</h1><p>首先加载必要的R包并获取股票数据。我们将选取几只具有代表性的美国科技股作为研究对象。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#75715e># 加载必要的R包</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>library</span>(quantmod)
</span></span><span style=display:flex><span><span style=color:#a6e22e>library</span>(PerformanceAnalytics)
</span></span><span style=display:flex><span><span style=color:#a6e22e>library</span>(foreach)
</span></span><span style=display:flex><span><span style=color:#a6e22e>library</span>(doParallel)
</span></span><span style=display:flex><span><span style=color:#a6e22e>library</span>(ggplot2)
</span></span><span style=display:flex><span><span style=color:#a6e22e>library</span>(dplyr)
</span></span><span style=display:flex><span><span style=color:#a6e22e>library</span>(tidyr)
</span></span><span style=display:flex><span><span style=color:#a6e22e>library</span>(eTTR)
</span></span><span style=display:flex><span><span style=color:#a6e22e>library</span>(zoo)
</span></span></code></pre></div><p>接下来，我们获取多只股票的历史数据。这里选择了苹果(AAPL)、微软(MSFT)、谷歌(GOOG)、
亚马逊(AMZN)和特斯拉(TSLA)作为样本。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#75715e># 设置起止日期</span>
</span></span><span style=display:flex><span>start_date <span style=color:#f92672>&lt;-</span> <span style=color:#e6db74>&#34;2018-01-01&#34;</span>
</span></span><span style=display:flex><span>end_date <span style=color:#f92672>&lt;-</span> <span style=color:#e6db74>&#34;2023-01-01&#34;</span>
</span></span><span style=display:flex><span>out_of_sample_date <span style=color:#f92672>&lt;-</span> <span style=color:#e6db74>&#34;2023-01-02&#34;</span>
</span></span><span style=display:flex><span>end_oos_date <span style=color:#f92672>&lt;-</span> <span style=color:#e6db74>&#34;2023-12-31&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 股票代码列表</span>
</span></span><span style=display:flex><span>stock_symbols <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>c</span>(<span style=color:#e6db74>&#34;AAPL&#34;</span>, <span style=color:#e6db74>&#34;MSFT&#34;</span>, <span style=color:#e6db74>&#34;GOOG&#34;</span>, <span style=color:#e6db74>&#34;AMZN&#34;</span>, <span style=color:#e6db74>&#34;TSLA&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 获取股票数据</span>
</span></span><span style=display:flex><span>stock_data <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>list</span>()
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (symbol <span style=color:#66d9ef>in</span> stock_symbols) {
</span></span><span style=display:flex><span>   data_raw <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>getSymbols</span>(symbol, from <span style=color:#f92672>=</span> start_date, to <span style=color:#f92672>=</span> end_date, auto.assign <span style=color:#f92672>=</span> <span style=color:#66d9ef>FALSE</span>)
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>colnames</span>(data_raw) <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>c</span>(<span style=color:#e6db74>&#34;Open&#34;</span>, <span style=color:#e6db74>&#34;High&#34;</span>, <span style=color:#e6db74>&#34;Low&#34;</span>, <span style=color:#e6db74>&#34;Close&#34;</span>, <span style=color:#e6db74>&#34;Volume&#34;</span>, <span style=color:#e6db74>&#34;Adjusted&#34;</span>)
</span></span><span style=display:flex><span>   stock_data[[symbol]] <span style=color:#f92672>&lt;-</span> data_raw
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 获取样本外数据</span>
</span></span><span style=display:flex><span>oos_data <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>list</span>()
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (symbol <span style=color:#66d9ef>in</span> stock_symbols) {
</span></span><span style=display:flex><span>   data_raw <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>getSymbols</span>(symbol, from <span style=color:#f92672>=</span> out_of_sample_date, to <span style=color:#f92672>=</span> end_oos_date, auto.assign <span style=color:#f92672>=</span> <span style=color:#66d9ef>FALSE</span>)
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>colnames</span>(data_raw) <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>c</span>(<span style=color:#e6db74>&#34;Open&#34;</span>, <span style=color:#e6db74>&#34;High&#34;</span>, <span style=color:#e6db74>&#34;Low&#34;</span>, <span style=color:#e6db74>&#34;Close&#34;</span>, <span style=color:#e6db74>&#34;Volume&#34;</span>, <span style=color:#e6db74>&#34;Adjusted&#34;</span>)
</span></span><span style=display:flex><span>   oos_data[[symbol]] <span style=color:#f92672>&lt;-</span> data_raw
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>让我们可视化这些股票的价格走势，以便对数据有一个直观的了解。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#75715e># 创建一个图表展示所有股票的价格走势</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>par</span>(mfrow <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>(<span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>2</span>), mar <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>(<span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>1</span>))
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (symbol <span style=color:#66d9ef>in</span> stock_symbols) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>chartSeries</span>(stock_data[[symbol]], theme <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;white&#34;</span>, name <span style=color:#f92672>=</span> symbol, 
</span></span><span style=display:flex><span>              TA <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;addBBands(); addRSI(); addMACD()&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img src=/docs/mean-reverse_files/figure-html/visualize-data-1.png width=90% style=display:block;margin:auto><img src=/docs/mean-reverse_files/figure-html/visualize-data-2.png width=90% style=display:block;margin:auto><img src=/docs/mean-reverse_files/figure-html/visualize-data-3.png width=90% style=display:block;margin:auto><img src=/docs/mean-reverse_files/figure-html/visualize-data-4.png width=90% style=display:block;margin:auto><img src=/docs/mean-reverse_files/figure-html/visualize-data-5.png width=90% style=display:block;margin:auto></p><h1 id=均值回归策略实现>均值回归策略实现</h1><p>下面我们实现一个简单的均值回归策略，基于布林带指标。该策略的核心思想是：当价格触
及下轨时买入，触及上轨时卖出。</p><p>首先定义一个函数来实现这个策略：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#75715e># 定义均值回归策略函数</span>
</span></span><span style=display:flex><span>mean_reversion_strategy <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>function</span>(data, ma_period <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span>, sd_mult <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>, 
</span></span><span style=display:flex><span>                                    trade_size <span style=color:#f92672>=</span> <span style=color:#ae81ff>10000</span>, commission <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.001</span>) {
</span></span><span style=display:flex><span>  <span style=color:#75715e># 计算布林带</span>
</span></span><span style=display:flex><span>  bbands <span style=color:#f92672>&lt;-</span> eTTR<span style=color:#f92672>::</span><span style=color:#a6e22e>BBands</span>(data[, <span style=color:#e6db74>&#34;Close&#34;</span>], n <span style=color:#f92672>=</span> ma_period, sd <span style=color:#f92672>=</span> sd_mult)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e># 初始化信号和持仓</span>
</span></span><span style=display:flex><span>  signals <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>rep</span>(<span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>nrow</span>(data))
</span></span><span style=display:flex><span>  position <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>rep</span>(<span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>nrow</span>(data))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e># 生成交易信号</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (i <span style=color:#66d9ef>in</span> (ma_period <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>)<span style=color:#f92672>:</span><span style=color:#a6e22e>nrow</span>(data)) {
</span></span><span style=display:flex><span>    <span style=color:#75715e># 当价格低于下轨时买入</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (data[i, <span style=color:#e6db74>&#34;Close&#34;</span>] <span style=color:#f92672>&lt;</span> bbands[i, <span style=color:#e6db74>&#34;dn&#34;</span>]) {
</span></span><span style=display:flex><span>      signals[i] <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e># 当价格高于上轨时卖出</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (data[i, <span style=color:#e6db74>&#34;Close&#34;</span>] <span style=color:#f92672>&gt;</span> bbands[i, <span style=color:#e6db74>&#34;up&#34;</span>]) {
</span></span><span style=display:flex><span>      signals[i] <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>-1</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e># 生成持仓</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (i <span style=color:#66d9ef>in</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>:</span><span style=color:#a6e22e>nrow</span>(data)) {
</span></span><span style=display:flex><span>    position[i] <span style=color:#f92672>&lt;-</span> position[i<span style=color:#ae81ff>-1</span>] <span style=color:#f92672>+</span> signals[i]
</span></span><span style=display:flex><span>    <span style=color:#75715e># 限制持仓为-1, 0, 1</span>
</span></span><span style=display:flex><span>    position[i] <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>max</span>(<span style=color:#ae81ff>-1</span>, <span style=color:#a6e22e>min</span>(<span style=color:#ae81ff>1</span>, position[i]))
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e># 计算每日收益</span>
</span></span><span style=display:flex><span>  returns <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>diff</span>(<span style=color:#a6e22e>log</span>(data[, <span style=color:#e6db74>&#34;Close&#34;</span>]))
</span></span><span style=display:flex><span>  returns <span style=color:#f92672>&lt;-</span> zoo<span style=color:#f92672>::</span><span style=color:#a6e22e>na.fill</span>(returns, <span style=color:#ae81ff>0</span>)  <span style=color:#75715e># 将 NA 填充为 0</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># 计算策略收益</span>
</span></span><span style=display:flex><span>  strategy_returns <span style=color:#f92672>&lt;-</span> position <span style=color:#f92672>*</span> returns
</span></span><span style=display:flex><span>  strategy_returns <span style=color:#f92672>&lt;-</span> zoo<span style=color:#f92672>::</span><span style=color:#a6e22e>na.fill</span>(strategy_returns, <span style=color:#ae81ff>0</span>)  <span style=color:#75715e># 将 NA 填充为 0</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># 考虑交易成本</span>
</span></span><span style=display:flex><span>  trades <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>abs</span>(<span style=color:#a6e22e>diff</span>(position)) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>  trades <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>c</span>(<span style=color:#ae81ff>0</span>, trades)
</span></span><span style=display:flex><span>  commission_cost <span style=color:#f92672>&lt;-</span> trades <span style=color:#f92672>*</span> commission <span style=color:#f92672>*</span> trade_size
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e># 计算净收益</span>
</span></span><span style=display:flex><span>  net_returns <span style=color:#f92672>&lt;-</span> strategy_returns <span style=color:#f92672>-</span> commission_cost <span style=color:#f92672>/</span> trade_size
</span></span><span style=display:flex><span>  net_returns <span style=color:#f92672>&lt;-</span> zoo<span style=color:#f92672>::</span><span style=color:#a6e22e>na.fill</span>(net_returns, <span style=color:#ae81ff>0</span>)  <span style=color:#75715e># 将 NA 填充为 0</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># 计算累积收益</span>
</span></span><span style=display:flex><span>  cumulative_returns <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>exp</span>(<span style=color:#a6e22e>cumsum</span>(net_returns))<span style=color:#ae81ff>-1</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e># 返回结果</span>
</span></span><span style=display:flex><span>  results <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>data.frame</span>(
</span></span><span style=display:flex><span>    Date <span style=color:#f92672>=</span> zoo<span style=color:#f92672>::</span><span style=color:#a6e22e>index</span>(data),
</span></span><span style=display:flex><span>    Close <span style=color:#f92672>=</span> zoo<span style=color:#f92672>::</span><span style=color:#a6e22e>coredata</span>(data)[, <span style=color:#e6db74>&#34;Close&#34;</span>],
</span></span><span style=display:flex><span>    Signal <span style=color:#f92672>=</span> signals,
</span></span><span style=display:flex><span>    Position <span style=color:#f92672>=</span> position,
</span></span><span style=display:flex><span>    Returns <span style=color:#f92672>=</span> returns,
</span></span><span style=display:flex><span>    Strategy_Returns <span style=color:#f92672>=</span> strategy_returns,
</span></span><span style=display:flex><span>    Commission_Cost <span style=color:#f92672>=</span> commission_cost,
</span></span><span style=display:flex><span>    Net_Returns <span style=color:#f92672>=</span> net_returns,
</span></span><span style=display:flex><span>    Cumulative_Returns <span style=color:#f92672>=</span> cumulative_returns
</span></span><span style=display:flex><span>  )
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>colnames</span>(results) <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>c</span>(<span style=color:#e6db74>&#34;Date&#34;</span>, <span style=color:#e6db74>&#34;Close&#34;</span>, <span style=color:#e6db74>&#34;Signal&#34;</span>, <span style=color:#e6db74>&#34;Position&#34;</span>, 
</span></span><span style=display:flex><span>                       <span style=color:#e6db74>&#34;Returns&#34;</span>, <span style=color:#e6db74>&#34;Strategy_Returns&#34;</span>, <span style=color:#e6db74>&#34;Commission_Cost&#34;</span>, 
</span></span><span style=display:flex><span>                       <span style=color:#e6db74>&#34;Net_Returns&#34;</span>, <span style=color:#e6db74>&#34;Cumulative_Returns&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span>(results)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>现在我们将这个策略应用到每只股票上，并评估其表现：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#75715e># 应用策略到每只股票</span>
</span></span><span style=display:flex><span>strategy_results <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>list</span>()
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (symbol <span style=color:#66d9ef>in</span> stock_symbols) {
</span></span><span style=display:flex><span>  strategy_results[[symbol]] <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>mean_reversion_strategy</span>(stock_data[[symbol]])
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 计算每只股票的策略表现</span>
</span></span><span style=display:flex><span>performance_metrics <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>data.frame</span>(Symbol <span style=color:#f92672>=</span> <span style=color:#a6e22e>character</span>(),
</span></span><span style=display:flex><span>                                  Total_Return <span style=color:#f92672>=</span> <span style=color:#a6e22e>numeric</span>(),
</span></span><span style=display:flex><span>                                  Sharpe_Ratio <span style=color:#f92672>=</span> <span style=color:#a6e22e>numeric</span>(),
</span></span><span style=display:flex><span>                                  Max_Drawdown <span style=color:#f92672>=</span> <span style=color:#a6e22e>numeric</span>(),
</span></span><span style=display:flex><span>                                  stringsAsFactors <span style=color:#f92672>=</span> <span style=color:#66d9ef>FALSE</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (symbol <span style=color:#66d9ef>in</span> stock_symbols) {
</span></span><span style=display:flex><span>  results <span style=color:#f92672>&lt;-</span> strategy_results[[symbol]]
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e># 检查结果是否存在且包含必要的列</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>is.null</span>(results) <span style=color:#f92672>||</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>all</span>(<span style=color:#a6e22e>c</span>(<span style=color:#e6db74>&#34;Cumulative_Returns&#34;</span>, <span style=color:#e6db74>&#34;Net_Returns&#34;</span>) <span style=color:#f92672>%in%</span> <span style=color:#a6e22e>colnames</span>(results))) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>warning</span>(<span style=color:#a6e22e>paste</span>(<span style=color:#e6db74>&#34;策略结果对&#34;</span>, symbol, <span style=color:#e6db74>&#34;不完整，跳过该股票&#34;</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>next</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e># 计算总收益</span>
</span></span><span style=display:flex><span>  total_return <span style=color:#f92672>&lt;-</span> results<span style=color:#f92672>$</span>Cumulative_Returns<span style=color:#a6e22e>[nrow</span>(results)]
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e># 计算夏普比率 (假设无风险利率为0)</span>
</span></span><span style=display:flex><span>  returns_xts <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>NULL</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e># 确保Net_Returns是xts格式</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>is.xts</span>(results<span style=color:#f92672>$</span>Net_Returns)) {
</span></span><span style=display:flex><span>    <span style=color:#75715e># 如果Net_Returns不是xts，尝试转换</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(<span style=color:#e6db74>&#34;Date&#34;</span> <span style=color:#f92672>%in%</span> <span style=color:#a6e22e>colnames</span>(results)) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>library</span>(xts)
</span></span><span style=display:flex><span>      <span style=color:#75715e># 增加日期有效性检查</span>
</span></span><span style=display:flex><span>      valid_dates <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>try</span>(<span style=color:#a6e22e>as.Date</span>(results<span style=color:#f92672>$</span>Date), silent <span style=color:#f92672>=</span> <span style=color:#66d9ef>TRUE</span>)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>inherits</span>(valid_dates, <span style=color:#e6db74>&#34;try-error&#34;</span>) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>all</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>is.na</span>(valid_dates))) {
</span></span><span style=display:flex><span>        returns_xts <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>xts</span>(results<span style=color:#f92672>$</span>Net_Returns, order.by <span style=color:#f92672>=</span> valid_dates)
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>warning</span>(<span style=color:#a6e22e>paste</span>(<span style=color:#e6db74>&#34;无法为&#34;</span>, symbol, <span style=color:#e6db74>&#34;转换有效日期，使用索引作为时间&#34;</span>))
</span></span><span style=display:flex><span>        returns_xts <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>xts</span>(results<span style=color:#f92672>$</span>Net_Returns, order.by <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#a6e22e>nrow</span>(results))
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e># 如果没有日期信息，创建基于索引的xts对象</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>warning</span>(<span style=color:#a6e22e>paste</span>(<span style=color:#e6db74>&#34;策略结果对&#34;</span>, symbol, <span style=color:#e6db74>&#34;缺少日期信息，使用索引作为时间&#34;</span>))
</span></span><span style=display:flex><span>      returns_xts <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>xts</span>(results<span style=color:#f92672>$</span>Net_Returns, order.by <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#a6e22e>nrow</span>(results))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    returns_xts <span style=color:#f92672>&lt;-</span> results<span style=color:#f92672>$</span>Net_Returns
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e># 验证returns_xts是否有效且非空</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>is.null</span>(returns_xts) <span style=color:#f92672>||</span> <span style=color:#a6e22e>nrow</span>(returns_xts) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>all</span>(<span style=color:#a6e22e>is.na</span>(returns_xts))) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>warning</span>(<span style=color:#a6e22e>paste</span>(<span style=color:#e6db74>&#34;策略结果对&#34;</span>, symbol, <span style=color:#e6db74>&#34;没有有效的收益数据，使用NA作为性能指标&#34;</span>))
</span></span><span style=display:flex><span>    sharpe_ratio <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>NA</span>
</span></span><span style=display:flex><span>    max_drawdown <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>NA</span>
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e># 计算年化指标</span>
</span></span><span style=display:flex><span>    annual_returns <span style=color:#f92672>&lt;-</span> PerformanceAnalytics<span style=color:#f92672>::</span><span style=color:#a6e22e>Return.annualized</span>(returns_xts, scale <span style=color:#f92672>=</span> <span style=color:#ae81ff>252</span>)
</span></span><span style=display:flex><span>    sharpe_ratio <span style=color:#f92672>&lt;-</span> PerformanceAnalytics<span style=color:#f92672>::</span><span style=color:#a6e22e>SharpeRatio.annualized</span>(returns_xts, Rf <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>, scale <span style=color:#f92672>=</span> <span style=color:#ae81ff>252</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># 计算最大回撤</span>
</span></span><span style=display:flex><span>    max_drawdown <span style=color:#f92672>&lt;-</span> PerformanceAnalytics<span style=color:#f92672>::</span><span style=color:#a6e22e>maxDrawdown</span>(returns_xts)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e># 添加到性能指标数据框</span>
</span></span><span style=display:flex><span>  performance_metrics <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>rbind</span>(performance_metrics, 
</span></span><span style=display:flex><span>                               <span style=color:#a6e22e>data.frame</span>(Symbol <span style=color:#f92672>=</span> symbol,
</span></span><span style=display:flex><span>                                          Total_Return <span style=color:#f92672>=</span> total_return,
</span></span><span style=display:flex><span>                                          Sharpe_Ratio <span style=color:#f92672>=</span> sharpe_ratio,
</span></span><span style=display:flex><span>                                          Max_Drawdown <span style=color:#f92672>=</span> max_drawdown))
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>colnames</span>(performance_metrics) <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>c</span>(<span style=color:#e6db74>&#34;Symbol&#34;</span>, <span style=color:#e6db74>&#34;Total_Return&#34;</span>, <span style=color:#e6db74>&#34;Sharpe_Ratio&#34;</span>, <span style=color:#e6db74>&#34;Max_Drawdown&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>row.names</span>(performance_metrics) <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>NULL</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>print</span>(performance_metrics)
</span></span></code></pre></div><pre tabindex=0><code>##   Symbol Total_Return Sharpe_Ratio Max_Drawdown
## 1   AAPL   -0.8533100   -1.1283544    0.8965894
## 2   MSFT   -0.6343459   -0.7499161    0.7507296
## 3   GOOG   -0.7540258   -0.9509113    0.8259180
## 4   AMZN   -0.7442898   -0.8572527    0.8211059
## 5   TSLA   -0.9929495   -1.1242993    0.9977061
</code></pre><p>让我们可视化策略的表现，比较每只股票的策略收益与买入持有收益：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#75715e># 创建图表展示每只股票的策略表现</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>par</span>(mfrow <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>(<span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>2</span>), mar <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>(<span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>1</span>))
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (symbol <span style=color:#66d9ef>in</span> stock_symbols) {
</span></span><span style=display:flex><span>  results <span style=color:#f92672>&lt;-</span> strategy_results[[symbol]]
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e># 计算买入持有策略的累积收益</span>
</span></span><span style=display:flex><span>  buy_hold_returns <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>exp</span>(<span style=color:#a6e22e>cumsum</span>(results<span style=color:#f92672>$</span>Returns)) <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e># 绘制累积收益对比图</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>plot</span>(results<span style=color:#f92672>$</span>Date, buy_hold_returns, type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;l&#34;</span>, col <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;blue&#34;</span>, 
</span></span><span style=display:flex><span>       main <span style=color:#f92672>=</span> <span style=color:#a6e22e>paste</span>(symbol, <span style=color:#e6db74>&#34;Strategy Performance&#34;</span>),
</span></span><span style=display:flex><span>       xlab <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Date&#34;</span>, ylab <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Cumulative Return&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>lines</span>(results<span style=color:#f92672>$</span>Date, results<span style=color:#f92672>$</span>Cumulative_Returns, col <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;red&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>legend</span>(<span style=color:#e6db74>&#34;topleft&#34;</span>, legend <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>(<span style=color:#e6db74>&#34;Buy &amp; Hold&#34;</span>, <span style=color:#e6db74>&#34;Mean Reversion&#34;</span>), 
</span></span><span style=display:flex><span>         col <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>(<span style=color:#e6db74>&#34;blue&#34;</span>, <span style=color:#e6db74>&#34;red&#34;</span>), lty <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><img src=/docs/mean-reverse_files/figure-html/visualize-strategy-performance-1.png width=90% style=display:block;margin:auto><h1 id=参数优化>参数优化</h1><p>接下来，我们将优化均值回归策略的参数。主要优化的参数是移动平均周期和标准差倍数。</p><p>我们将使用网格搜索方法来寻找最优参数组合：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#75715e># 设置参数网格</span>
</span></span><span style=display:flex><span>ma_periods <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>c</span>(<span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>15</span>, <span style=color:#ae81ff>20</span>, <span style=color:#ae81ff>25</span>, <span style=color:#ae81ff>30</span>)
</span></span><span style=display:flex><span>sd_multipliers <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>c</span>(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1.5</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>2.5</span>, <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span><span style=color:#75715e># 创建并注册集群</span>
</span></span><span style=display:flex><span>cl <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>makeCluster</span>(<span style=color:#a6e22e>detectCores</span>() <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>registerDoParallel</span>(cl)
</span></span><span style=display:flex><span>required_packages <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>c</span>(<span style=color:#e6db74>&#34;quantmod&#34;</span>, <span style=color:#e6db74>&#34;PerformanceAnalytics&#34;</span>, <span style=color:#e6db74>&#34;TTR&#34;</span>, <span style=color:#e6db74>&#34;zoo&#34;</span>, <span style=color:#e6db74>&#34;dplyr&#34;</span>, <span style=color:#e6db74>&#34;tidyr&#34;</span>, <span style=color:#e6db74>&#34;xts&#34;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#75715e># 对每只股票进行参数优化</span>
</span></span><span style=display:flex><span>optimal_params <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>list</span>()
</span></span><span style=display:flex><span><span style=color:#a6e22e>tryCatch</span>({
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>for</span> (symbol <span style=color:#66d9ef>in</span> stock_symbols) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>cat</span>(<span style=color:#e6db74>&#34;Optimizing parameters for&#34;</span>, symbol, <span style=color:#e6db74>&#34;...\n&#34;</span>)
</span></span><span style=display:flex><span>                 <span style=color:#75715e># 使用foreach进行并行计算</span>
</span></span><span style=display:flex><span>                 results <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>foreach</span>(ma <span style=color:#f92672>=</span> ma_periods, .combine <span style=color:#f92672>=</span> rbind, .packages <span style=color:#f92672>=</span> required_packages) <span style=color:#f92672>%:%</span>
</span></span><span style=display:flex><span>                     <span style=color:#a6e22e>foreach</span>(sd <span style=color:#f92672>=</span> sd_multipliers, .combine <span style=color:#f92672>=</span> rbind) <span style=color:#f92672>%dopar%</span> {
</span></span><span style=display:flex><span>                         <span style=color:#75715e># 应用策略</span>
</span></span><span style=display:flex><span>                           strategy_result <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>mean_reversion_strategy</span>(stock_data[[symbol]], 
</span></span><span style=display:flex><span>                                                                      ma_period <span style=color:#f92672>=</span> ma, 
</span></span><span style=display:flex><span>                                                                      sd_mult <span style=color:#f92672>=</span> sd)
</span></span><span style=display:flex><span>                           
</span></span><span style=display:flex><span>                             <span style=color:#75715e># 确保Net_Returns是xts格式</span>
</span></span><span style=display:flex><span>                             <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>is.xts</span>(strategy_result<span style=color:#f92672>$</span>Net_Returns)) {
</span></span><span style=display:flex><span>                                 returns_xts <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>xts</span>(strategy_result<span style=color:#f92672>$</span>Net_Returns, 
</span></span><span style=display:flex><span>                                       order.by <span style=color:#f92672>=</span> <span style=color:#a6e22e>index</span>(stock_data[[symbol]])[1<span style=color:#f92672>:</span><span style=color:#a6e22e>length</span>(strategy_result<span style=color:#f92672>$</span>Net_Returns)])
</span></span><span style=display:flex><span>                               } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                                   returns_xts <span style=color:#f92672>&lt;-</span> strategy_result<span style=color:#f92672>$</span>Net_Returns
</span></span><span style=display:flex><span>                                 }
</span></span><span style=display:flex><span>                           
</span></span><span style=display:flex><span>                             <span style=color:#75715e># 计算夏普比率</span>
</span></span><span style=display:flex><span>                             sharpe <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>SharpeRatio.annualized</span>(returns_xts, Rf <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>, scale <span style=color:#f92672>=</span> <span style=color:#ae81ff>252</span>)
</span></span><span style=display:flex><span>                             
</span></span><span style=display:flex><span>                               <span style=color:#75715e># 返回结果</span>
</span></span><span style=display:flex><span>                               <span style=color:#a6e22e>data.frame</span>(Symbol <span style=color:#f92672>=</span> symbol, 
</span></span><span style=display:flex><span>                                                              MA_Period <span style=color:#f92672>=</span> ma, 
</span></span><span style=display:flex><span>                                                              SD_Multiplier <span style=color:#f92672>=</span> sd, 
</span></span><span style=display:flex><span>                                                              Sharpe_Ratio <span style=color:#f92672>=</span> <span style=color:#a6e22e>as.numeric</span>(sharpe))
</span></span><span style=display:flex><span>                           }
</span></span><span style=display:flex><span>                 
</span></span><span style=display:flex><span>                   <span style=color:#75715e># 找到最优参数</span>
</span></span><span style=display:flex><span>                   optimal_params[[symbol]] <span style=color:#f92672>&lt;-</span> results<span style=color:#a6e22e>[which.max</span>(results<span style=color:#f92672>$</span>Sharpe_Ratio), ]
</span></span><span style=display:flex><span>                 }
</span></span><span style=display:flex><span>         }, finally <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>             <span style=color:#75715e># 关闭集群</span>
</span></span><span style=display:flex><span>               <span style=color:#a6e22e>stopCluster</span>(cl)
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>closeAllConnections</span>()
</span></span><span style=display:flex><span>           })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#75715e># 输出最优参数</span>
</span></span><span style=display:flex><span>      optimal_params_df <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>do.call</span>(rbind,optimal_params)
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>print</span>(optimal_params_df)
</span></span></code></pre></div><pre tabindex=0><code>##      Symbol MA_Period SD_Multiplier Sharpe_Ratio
## AAPL   AAPL        10           2.5  -0.10327300
## MSFT   MSFT        10           2.5   0.42213306
## GOOG   GOOG        25           3.0   0.06798975
## AMZN   AMZN        10           2.5  -0.27697175
## TSLA   TSLA        15           3.0  -0.68368600
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span>       <span style=color:#75715e># 可视化结果</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>length</span>(optimal_params) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>           all_results <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>do.call</span>(rbind, <span style=color:#a6e22e>lapply</span>(optimal_params, <span style=color:#66d9ef>function</span>(x) x))
</span></span><span style=display:flex><span>           
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>ggplot</span>(all_results, <span style=color:#a6e22e>aes</span>(x <span style=color:#f92672>=</span> MA_Period, y <span style=color:#f92672>=</span> SD_Multiplier, fill <span style=color:#f92672>=</span> Sharpe_Ratio)) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>               <span style=color:#a6e22e>geom_tile</span>() <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>               <span style=color:#a6e22e>scale_fill_gradient</span>(low <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;blue&#34;</span>, high <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;red&#34;</span>) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>               <span style=color:#a6e22e>facet_wrap</span>(<span style=color:#f92672>~</span>Symbol) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>               <span style=color:#a6e22e>labs</span>(title <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;参数优化热力图&#34;</span>, x <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;移动平均周期&#34;</span>, y <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;标准差倍数&#34;</span>) <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>               <span style=color:#a6e22e>theme_minimal</span>()
</span></span><span style=display:flex><span>         }
</span></span></code></pre></div><img src=/docs/mean-reverse_files/figure-html/parameter-optimization-1.png width=90% style=display:block;margin:auto><h1 id=样本外验证>样本外验证</h1><p>现在我们使用优化后的参数在样本外数据上验证策略的有效性：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#75715e># 使用优化后的参数在样本外数据上测试策略</span>
</span></span><span style=display:flex><span>oos_results <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>list</span>()
</span></span><span style=display:flex><span>oos_performance <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>data.frame</span>(Symbol <span style=color:#f92672>=</span> <span style=color:#a6e22e>character</span>(),
</span></span><span style=display:flex><span>                             Total_Return <span style=color:#f92672>=</span> <span style=color:#a6e22e>numeric</span>(),
</span></span><span style=display:flex><span>                             Sharpe_Ratio <span style=color:#f92672>=</span> <span style=color:#a6e22e>numeric</span>(),
</span></span><span style=display:flex><span>                             Max_Drawdown <span style=color:#f92672>=</span> <span style=color:#a6e22e>numeric</span>(),
</span></span><span style=display:flex><span>                             stringsAsFactors <span style=color:#f92672>=</span> <span style=color:#66d9ef>FALSE</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (symbol <span style=color:#66d9ef>in</span> stock_symbols) {
</span></span><span style=display:flex><span>  best_ma <span style=color:#f92672>&lt;-</span> optimal_params[[symbol]]<span style=color:#f92672>$</span>MA_Period
</span></span><span style=display:flex><span>  best_sd <span style=color:#f92672>&lt;-</span> optimal_params[[symbol]]<span style=color:#f92672>$</span>SD_Multiplier
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e># 在样本外数据上应用策略</span>
</span></span><span style=display:flex><span>  oos_results[[symbol]] <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>mean_reversion_strategy</span>(oos_data[[symbol]], 
</span></span><span style=display:flex><span>                                                  ma_period <span style=color:#f92672>=</span> best_ma, 
</span></span><span style=display:flex><span>                                                  sd_mult <span style=color:#f92672>=</span> best_sd)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e># 计算样本外表现</span>
</span></span><span style=display:flex><span>  oos_return <span style=color:#f92672>&lt;-</span> oos_results[[symbol]]<span style=color:#f92672>$</span>Cumulative_Returns<span style=color:#a6e22e>[nrow</span>(oos_results[[symbol]])]
</span></span><span style=display:flex><span>  <span style=color:#75715e># 确保Net_Returns是xts格式</span>
</span></span><span style=display:flex><span>  Net_Returns <span style=color:#f92672>&lt;-</span> oos_results[[symbol]]<span style=color:#f92672>$</span>Net_Returns
</span></span><span style=display:flex><span>  Net_Returns_xts <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>xts</span>(Net_Returns, order.by <span style=color:#f92672>=</span> oos_results[[symbol]]<span style=color:#f92672>$</span>Date)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  oos_sharpe <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>SharpeRatio.annualized</span>(Net_Returns_xts, Rf <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>, scale <span style=color:#f92672>=</span> <span style=color:#ae81ff>252</span>)
</span></span><span style=display:flex><span>  oos_drawdown <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>maxDrawdown</span>(Net_Returns_xts)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  oos_performance <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>rbind</span>(oos_performance, 
</span></span><span style=display:flex><span>                         <span style=color:#a6e22e>data.frame</span>(Symbol <span style=color:#f92672>=</span> symbol,
</span></span><span style=display:flex><span>                                   Total_Return <span style=color:#f92672>=</span> oos_return,
</span></span><span style=display:flex><span>                                   Sharpe_Ratio <span style=color:#f92672>=</span> oos_sharpe,
</span></span><span style=display:flex><span>                                   Max_Drawdown <span style=color:#f92672>=</span> oos_drawdown))
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>row.names</span>(oos_performance) <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>NULL</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 展示样本外性能指标</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>print</span>(oos_performance)
</span></span></code></pre></div><pre tabindex=0><code>##   Symbol Total_Return Sharpe_Ratio Max_Drawdown
## 1   AAPL  0.006107479 -0.016645990    0.1332577
## 2   MSFT -0.328535872 -1.500429504    0.3707137
## 3   GOOG -0.234853317 -1.144584312    0.2632418
## 4   AMZN -0.152420982 -0.851226442    0.2287305
## 5   TSLA  0.022876411  0.003117049    0.1941342
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#75715e># 可视化样本外表现</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>par</span>(mfrow <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>(<span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>2</span>), mar <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>(<span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>1</span>))
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (symbol <span style=color:#66d9ef>in</span> stock_symbols) {
</span></span><span style=display:flex><span>  oos_result <span style=color:#f92672>&lt;-</span> oos_results[[symbol]]
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e># 计算买入持有策略的累积收益</span>
</span></span><span style=display:flex><span>  buy_hold_returns <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>exp</span>(<span style=color:#a6e22e>cumsum</span>(oos_result<span style=color:#f92672>$</span>Returns)) <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e># 绘制累积收益对比图</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>plot</span>(oos_result<span style=color:#f92672>$</span>Date, buy_hold_returns, type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;l&#34;</span>, col <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;blue&#34;</span>, 
</span></span><span style=display:flex><span>       main <span style=color:#f92672>=</span> <span style=color:#a6e22e>paste</span>(symbol, <span style=color:#e6db74>&#34;OOS Performance&#34;</span>),
</span></span><span style=display:flex><span>       xlab <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Date&#34;</span>, ylab <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Cumulative Return&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>lines</span>(oos_result<span style=color:#f92672>$</span>Date, oos_result<span style=color:#f92672>$</span>Cumulative_Returns, col <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;red&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>legend</span>(<span style=color:#e6db74>&#34;topleft&#34;</span>, legend <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>(<span style=color:#e6db74>&#34;Buy &amp; Hold&#34;</span>, <span style=color:#e6db74>&#34;Mean Reversion&#34;</span>), 
</span></span><span style=display:flex><span>         col <span style=color:#f92672>=</span> <span style=color:#a6e22e>c</span>(<span style=color:#e6db74>&#34;blue&#34;</span>, <span style=color:#e6db74>&#34;red&#34;</span>), lty <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><img src=/docs/mean-reverse_files/figure-html/out-of-sample-validation-1.png width=90% style=display:block;margin:auto><h1 id=策略组合与风险分散>策略组合与风险分散</h1><p>最后，我们考虑构建一个包含多只股票的策略组合，以实现风险分散：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#75715e># 计算每只股票在最优参数下的日收益率</span>
</span></span><span style=display:flex><span>portfolio_returns <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>matrix</span>(<span style=color:#ae81ff>0</span>, nrow <span style=color:#f92672>=</span> <span style=color:#a6e22e>nrow</span>(oos_data[[stock_symbols[1]]]), ncol <span style=color:#f92672>=</span> <span style=color:#a6e22e>length</span>(stock_symbols))
</span></span><span style=display:flex><span><span style=color:#a6e22e>colnames</span>(portfolio_returns) <span style=color:#f92672>&lt;-</span> stock_symbols
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (i <span style=color:#66d9ef>in</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#a6e22e>length</span>(stock_symbols)) {
</span></span><span style=display:flex><span>  symbol <span style=color:#f92672>&lt;-</span> stock_symbols[i]
</span></span><span style=display:flex><span>  best_ma <span style=color:#f92672>&lt;-</span> optimal_params[[symbol]]<span style=color:#f92672>$</span>MA_Period
</span></span><span style=display:flex><span>  best_sd <span style=color:#f92672>&lt;-</span> optimal_params[[symbol]]<span style=color:#f92672>$</span>SD_Multiplier
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e># 应用策略获取收益率</span>
</span></span><span style=display:flex><span>  result <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>mean_reversion_strategy</span>(oos_data[[symbol]], ma_period <span style=color:#f92672>=</span> best_ma, sd_mult <span style=color:#f92672>=</span> best_sd)
</span></span><span style=display:flex><span>  portfolio_returns[, i] <span style=color:#f92672>&lt;-</span> result<span style=color:#f92672>$</span>Net_Returns
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 等权重组合</span>
</span></span><span style=display:flex><span>equal_weights <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>rep</span>(<span style=color:#ae81ff>1</span><span style=color:#f92672>/</span><span style=color:#a6e22e>length</span>(stock_symbols), <span style=color:#a6e22e>length</span>(stock_symbols))
</span></span><span style=display:flex><span>portfolio_returns_equal <span style=color:#f92672>&lt;-</span> portfolio_returns <span style=color:#f92672>%*%</span> equal_weights
</span></span><span style=display:flex><span><span style=color:#75715e># 将组合收益率转换为xts对象</span>
</span></span><span style=display:flex><span>portfolio_returns_equal_xts <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>xts</span>(portfolio_returns_equal, 
</span></span><span style=display:flex><span>                                   order.by <span style=color:#f92672>=</span> <span style=color:#a6e22e>index</span>(oos_data[[stock_symbols[1]]]))
</span></span><span style=display:flex><span><span style=color:#75715e># 计算组合表现</span>
</span></span><span style=display:flex><span>portfolio_total_return <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>exp</span>(<span style=color:#a6e22e>sum</span>(portfolio_returns_equal_xts)) <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>portfolio_sharpe <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>SharpeRatio.annualized</span>(portfolio_returns_equal_xts)
</span></span><span style=display:flex><span>portfolio_drawdown <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>maxDrawdown</span>(portfolio_returns_equal_xts)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 展示组合表现</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>cat</span>(<span style=color:#e6db74>&#34;Portfolio Performance (Equal Weighted):\n&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code>## Portfolio Performance (Equal Weighted):
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#a6e22e>cat</span>(<span style=color:#e6db74>&#34;Total Return:&#34;</span>, portfolio_total_return, <span style=color:#e6db74>&#34;\n&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code>## Total Return: -0.1483071
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#a6e22e>cat</span>(<span style=color:#e6db74>&#34;Sharpe Ratio:&#34;</span>, portfolio_sharpe, <span style=color:#e6db74>&#34;\n&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code>## Sharpe Ratio: -1.58031
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#a6e22e>cat</span>(<span style=color:#e6db74>&#34;Max Drawdown:&#34;</span>, portfolio_drawdown, <span style=color:#e6db74>&#34;\n&#34;</span>)
</span></span></code></pre></div><pre tabindex=0><code>## Max Drawdown: 0.1649416
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#75715e># 可视化组合表现</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>plot</span>(<span style=color:#a6e22e>cumsum</span>(portfolio_returns_equal), type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;l&#34;</span>, 
</span></span><span style=display:flex><span>     main <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Equal Weighted Portfolio Performance&#34;</span>,
</span></span><span style=display:flex><span>     xlab <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Trading Day&#34;</span>, ylab <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Cumulative Return&#34;</span>)
</span></span></code></pre></div><img src=/docs/mean-reverse_files/figure-html/portfolio-construction-1.png width=90% style=display:block;margin:auto><h1 id=结论>结论</h1><p>本文通过R语言实现了基于布林带的均值回归策略，并在多只股票上进行了测试。主要发现如
下：</p><ol><li><p>均值回归策略在某些股票上表现良好，但在其他股票上可能表现不佳，表明该策略的有效
性依赖于股票的特性。</p></li><li><p>通过参数优化，我们能够找到每只股票的最优参数组合，显著提高策略的表现。</p></li><li><p>样本外验证表明，优化后的策略在新数据上仍具有一定的有效性，但性能通常会有所下降，
这反映了过拟合的风险。</p></li><li><p>通过构建多股票组合，我们可以实现风险分散，降低单一股票波动对整体策略的影响。</p></li></ol><p>总体而言，均值回归策略是一种可行的交易方法，但需要谨慎选择适用的股票，并进行适当
的参数优化和风险控制。在实际应用中，还应考虑市场环境的变化，因为均值回归策略在趋
势市场中可能表现不佳。</p><p>未来的研究可以考虑结合其他技术指标来改进策略，或者探索不同的均值回归方法，如基于
价格与移动平均线的偏离度等。</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M4 0h8s2 0 4 2l15 15s2 2 0 4L21 31s-2 2-4 0L2 16s-2-2-2-4V3s0-3 4-3m3 10a3 3 0 000-6 3 3 0 000 6"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/r/ rel=tag>R</a></li><li class=tags__item><a class="tags__link btn" href=/tags/%E9%87%91%E8%9E%8D/ rel=tag>金融</a></li><li class=tags__item><a class="tags__link btn" href=/tags/%E5%9D%87%E5%80%BC%E5%9B%9E%E5%A4%8D/ rel=tag>均值回复</a></li><li class=tags__item><a class="tags__link btn" href=/tags/%E6%9C%89%E6%95%88%E6%80%A7/ rel=tag>有效性</a></li></ul></div></footer></article><script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js async></script><script>window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,tags:"ams"},svg:{fontCache:"global"}}</script></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2025 R-Finance中国.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script><script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js async></script><script>window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,tags:"ams"},svg:{fontCache:"global"}}</script></body></html>